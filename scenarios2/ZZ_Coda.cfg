#textdomain wesnoth-Trinity

# Khthon last stand, and closure of Nemesis:  1.  Khthon and Humans set fire to dry forests to make sure Sky Mountain lands nearby.  2.  Nemesis lands and Primeval leaders survey situation, Dardrus has to decide whether to assault Nemesis or stop Khthon.
# TO DO:  1. final playthrough

[scenario]
    id="Coda2"
    name= _ "Coda"
    map_data="{~add-ons/Trinity/maps/Coda.map}"
    next_scenario=Epilog_Primeval
    victory_when_enemies_defeated=no
    turns=-1
    #    {TURNS 85 70 60}

    [music]
        name="legends_of_the_north.ogg"
    [/music]

    #        {BMR_STORE_SIDE 1}
    #        {BMR_STORE_SIDE 3}
    #        {BMR_STORE_SIDE 6}
    {BMR_RESTORE_SIDE 1}
    {BMR_RESTORE_SIDE 3}
    {BMR_RESTORE_SIDE 5}
    {BMR_RESTORE_SIDE 6}
    {DEFAULT_SCHEDULE}
    #    {TRINITY_TWO_SUNS}
    {ARC_INIT_LUA}

    [story]
        [part]
            story= _ "King Haldrad and those left behind by Nemesis joined the Khthon through the oddly verdant portal.  Haldrad knew they were taking a big risk, trusting the Khthon.  But as he emerged from the green light, he felt he was still himself, and he was looking out at the dead outskirts of his ruined capital Weldynn."
            [background_layer]
                image="story/landscape-bridge.jpg"
                scale_horizontally=yes
            [/background_layer]
        [/part]
    [/story]

    ###############################################
    # Sides
    ###############################################
    [side]
        type=Spearman
        id=Haldrad_
        name= _ "Haldrad (Fake)"
        side=1
        canrecruit=yes
        fog=no
        controller=human
        shroud=no
        #        scroll_to_leader=no
        {GOLD 280 220 180}
        {INCOME 6 4 2}
        recruit="Dwarvish Fighter, Archaic_Orcish Grunt" # in addition to the others
        team_name=Khthon
    [/side]

    [side]
        type=Primevalist Leader
        id=Dwyire
        name= _ "General Dwyire"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        {GOLD 170 240 300}
        {INCOME 6 8 10}
        recruit="Primevalist Fighter, Primevalist Fanatic, Primevalist Follower, Primevalist Celebrant, SouthSeas Seaman, SouthSeas Shoreman, SouthSeas Caster, SouthSeas Zephyrist"
        team_name=Primeval
        # this does not work.  It is visible in :inspect, but it doesn't do anything
#ifdef __UNUSED__
        [ai]
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=SouthSeas Zephyrist
                            max=1
                        [/limit]
                        [limit]
                            type=Primevalist Fanatic
                            max=1
                        [/limit]
                        [limit]
                            type=Primevalist Celebrant
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
#endif
        # since the above isn't working, no problem using this
        # exscept that it causes lua errors
        #        [ai]
        #            {EXPERIMENTAL_AI}
        #        [/ai]
        [unit]
            type=Primevalist Monk
            ai_special=guardian
            x,y=3,28
        [/unit]
        [unit]
            type=Primevalist Shield
            ai_special=guardian
            x,y=12,27
        [/unit]
    [/side]

    [side]
        type=Spearman
        id=Primevals_
        name= _ "Fooby"
        side=3
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit=""
        team_name=Primeval
        {GOLD 280 220 180}
        {INCOME 6 4 2}
        hidden=yes
    [/side]

    # was trying to contain the Primevalists and SouthSeas
    [side]
        type=Ranger
        id=Remington
        name= _ "Remington the Red"
        side=4
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        {GOLD 160 240 280}
        {INCOME 6 8 10}
        recruit="Woodsman, Poacher, Trapper, Thief, Thug, Bandit, Footpad, Outlaw"
        team_name=Outlaws
        # this does not work.  It is visible in :inspect, but it doesn't do anything
        [ai]
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Outlaw
                            max=1
                        [/limit]
                        [limit]
                            type=Bandit
                            max=1
                        [/limit]
                        [limit]
                            type=Trapper
                            max=2
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
        [unit]
            type=Rogue
            ai_special=guardian
            x,y=35,6
        [/unit]
        [unit]
            type=Trapper
            ai_special=guardian
            x,y=43,5
        [/unit]
    [/side]

    [side]
        type=Spearman
        id=Khthons_
        name= _ "Fooby5"
        side=5
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit="Brown Duck,Timber Wolf,Yak,Ram,Horse,Toad,Terrapin"
        team_name=Khthon
        {GOLD 280 220 180}
        {INCOME 6 4 2}
    [/side]

    [side]
        type=Spearman
        id=Primevals__
        name= _ "Fooby6"
        side=6
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit=""
        team_name=Primeval
        hidden=yes
    [/side]

    # #define TRI_FIRESTARTER_TYPES
    #    Goblin Pillager,Orcish Fireline,Orcish Firebreather,Mage,Red Mage,Silver Mage,Arch Mage,Great Mage#enddef
    ###################################

    # to prevent side 2 from being overrun by cyborgs
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
        [/filter]
        [filter_second] # so it's only the assimilation, not enthrallment
            [not]
                race=khthon
            [/not]
        [/filter_second]
        [filter_second_attack]
            special=plague
        [/filter_second_attack]
        [filter_condition]
            [variable]
                name=cyb_count
                less_than=3
            [/variable]
        [/filter_condition]
        [set_variable]
            name=cyb_count
            add=1
        [/set_variable]
        [role]
            role=SideKick2
            type=Primevalist Celebrant,Primevalist Monk,Primevalist Follower,Primevalist Fighter
            side=2
        [/role]
        [if]
            [variable]
                name=cyb_count
                equals=3
            [/variable]
            [then]
                [message]
                    speaker=Dwyire
                    message=_"Hrmm...  The enemy can re-animate our fallen, but it is not as quick a process as the Khthon Plague...  I'm going to pass out these vials, drink from them when you feel all is lost - do not let the enemy turn you into a machine."
                [/message]
                [message]
                    role=SideKick2
                    message=_"What's in these vials?"
                [/message]
                [message]
                    speaker=Dwyire
                    message=_"It's oil of the"+" <i>chyvura</i>"+_" seed, it is a paralyzing poison that must be ingested to have any effect.  Our dead will stay fallen, we won't be giving the enemy any more mechanical soldiers."
                [/message]
                [event] # event to counter the assimilation [plague] weapon special
                    name=last breath
                    first_time_only=no
                    [filter]
                        side=2
                        [not]
                            id=Dwyire
                        [/not]
                    [/filter]
                    [filter_second] # so it's only the assimilation, not enthrallment
                        [not]
                            race=khthon
                        [/not]
                    [/filter_second]
                    [filter_second_attack]
                        special=plague
                    [/filter_second_attack]
                    [kill]
                        id=$unit.id
                        animate=yes
                        fire_event=no
                    [/kill]
                [/event]
            [/then]
        [/if]
    [/event]

    ###########################

    [event]
        name=prestart
        [set_variable]
            name=cyb_count
            value=0
        [/set_variable]
        [recall]
            id=Ponce
            x,y=7,3
        [/recall]
        [recall]
            race=khthon
            x,y=5,4
        [/recall]
        [recall]
            side=1
            level=3
        [/recall]
        {MODIFY_UNIT (side=3,6) facing nw}
        [store_unit]
            [filter]
                id=Nemesis
            [/filter]
            variable=nemesis
            kill=yes
        [/store_unit]
        # to prevent Nemesis from having unhelpful AI behaviour
        [set_variable]
            name=nemesis.canrecruit
            value=no
        [/set_variable]
        [store_unit]
            [filter]
                id=Dardrus
            [/filter]
            variable=dardrus
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Bresda
            [/filter]
            variable=bresda
            kill=yes
        [/store_unit]
        # if the player doesn't have such a fire-bearing unit, give them a Pyradalon on side 5
        [if]
            [have_unit]
                side=1,5
                [has_attack]
                    type=fire
                [/has_attack]
                #                type={TRI_FIRESTARTER_TYPES}
                # Goblin Pillager,Orcish Fireline,Orcish Firebreather,Mage,Red Mage
            [/have_unit]
            #		[then]
            #		    [recall]
            #			type={TRI_FIRESTARTER_TYPES}
            # Goblin Pillager,Orcish Fireline,Orcish Firebreather,Mage,Red Mage
            #			side=1
            #			x,y=1,1
            #			find_vacant=no
            #		    [/recall]
            #		[/then]
            [else]
                [unit]
                    type=Pyradalon
                    side=5
                    x,y=recall,recall
                    #                    find_vacant=no
                [/unit]
            [/else]
        [/if]
        #		[unit_overlay]
        #		    x,y=1,1
        #		    image=misc/loyal-icon.png~CS(200,-200,-200)
        #		[/unit_overlay]
        #	[store_unit]
        #	    [filter]
        #		x,y=1,1
        #	    [/filter]
        #		variable=fire_starter
        #		kill=yes
        #	[/store_unit]
        #	[unstore_unit]
        #	    variable=fire_starter
        #	    x,y=recall,recall
        #	[/unstore_unit]
        [set_recruit]
            side=3
            recruit=""
        [/set_recruit]
        [objectives]
            side=1
            {TRI_OBJ_SUMMARY (_"King Haldrad")}
            #	    summary="<span color='#B0B087' font_weight='bold' size='x-large' >King Haldrad</span>"
            #	    summary="<span color='#CECF74' font_weight='bold' bgcolor='#660000' size='x-large' >King Haldrad</span>"
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
            #            note=_"This scenario is a work-in-progress."
        [/objectives]
        [objectives]
            side=3
            {TRI_OBJ_SUMMARY (_"Bresda and Dardrus")}
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
        [/objectives]
        [objectives]
            side=5
            {TRI_OBJ_SUMMARY (_"The Khthon")}
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
        [/objectives]
        [objectives]
            side=6
            {TRI_OBJ_SUMMARY (_"Nemesis")}
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
        [/objectives]
    [/event]

#define TRI_FOREST_FIRE
    # partially recycled from previous scenario
    [store_locations]
        [and]
            terrain=*^Fd*
        [/and]
        [filter_adjacent_location]
            terrain=*^Ffyr
        [/filter_adjacent_location]
        variable=potential_rift_locations
    [/store_locations]
    # choose which locations to randomly convert
    {FOREACH potential_rift_locations prli}
        [set_variable]
            name=chance_TEMP
            rand=1,2,3
        [/set_variable]
        [if] # this might need to be adjusted
            [variable]
                name=chance_TEMP
                equals=2
            [/variable]
            [then]
                {CLEAR_VARIABLE potential_rift_locations[$prli]}
                # so the index doesn't skip ahead as we have shortened the array
                [set_variable]
                    name=prli
                    add=-1
                [/set_variable]
            [/then]
        [/if]
    {NEXT prli}
    {FOREACH potential_rift_locations prli}
        [terrain]
            terrain=Rd^Ffyr
            x,y=$potential_rift_locations[$prli].x|,$potential_rift_locations[$prli].y|
        [/terrain]
    {NEXT prli}
    {CLEAR_VARIABLE potential_rift_locations}
    [redraw]
        side=1,3,5
    [/redraw]
#enddef

    [event]
        name=start
        # testing
        # #ifdef __UNUSED__
        [music]
            name=wanderer.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Haldrad
            message=_"So, we are back home...  Such as it is..."
        [/message]
        {MODIFY_UNIT (side=1,5) facing se}
        {MODIFY_UNIT (side=2) facing ne}
        {MODIFY_UNIT (side=4) facing sw}
        [message]
            role=Khthon_Leader
            message=_"We are on a northern border of the blight caused by Seth, not far from where your capital used to be."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Yes, I can see that.  Tell me, how do we find the Ice Mountain?  Where, in all the great, green earth, will they land?"
        [/message]
        [message]
            role=Khthon_Leader
            message=_"We cannot know..."
        [/message]
        [message]
            speaker=Ponce
            message=_"Haldrad, we have more immediate concerns - we are not alone."
        [/message]
        [message]
            speaker=Dwyire
            message=_"Ack!  They've got reinforcements!  Stand strong, we'll drive back these mindless Khthon slaves!"
        [/message]
        [message]
            speaker=Remington
            message=_"We're not Khthon, you lying, invading bastard!  We'll drive you from these woods, your wave of rot and desolation will stop here!"
        [/message]
        [message]
            speaker=Haldrad
            message=_"Hoi, Ranger!  You defy the invaders?  Their leader is coming, things will get very desperate soon if we don't act wisely.  We could use your help."
        [/message]
        [message]
            speaker=narrator
            message=_"The Ranger looked at King Haldrad, then looked at the beast standing near him, and his surprised expression hardened into hostility."
        [/message]
        [message]
            speaker=Remington
            message=_"No, nice try.  Not everything the invaders say is a lie...  I've seen your type, we won't play into your hands!"
        [/message]
        [message]
            speaker=Haldrad
            message=_"(This is a distraction we really don't need.  If I can overpower the ranger and his men, I might be able to make them see the light.)"
        [/message]
        [message]
            role=Khthon_Leader
            message=_"(And if that doesn't work, we have our own methods of persuasion...)"
        [/message]
        [message]
            speaker=Haldrad
            message=_"(Right, let us hold off on that for now.)"
        [/message]
        {MOVE_UNIT (id=Haldrad) 14 5}
        {MOVE_UNIT (role=Khthon_Leader) 13 6}
        # #endif
    [/event]
    [event]
        name=turn 2
        # testing
#ifdef __UNUSED__
        [terrain_mask]
            x,y=9,36
            #            x,y=34,39
            mask="{~add-ons/Trinity/maps/Coda-Mountain.map}"
            border=yes
            [rule]
                new=_f
                use_old=yes
            [/rule]
            [rule]
                use_old=no
            [/rule]
        [/terrain_mask]
        [unstore_unit]
            variable=nemesis
            x,y=13,40
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=dardrus
            x,y=17,43
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=bresda
            x,y=18,42
            find_vacant=no
        [/unstore_unit]
#endif
        [message]
            speaker=Haldrad
            message=_"We need some bold thinking.  What can we do to get to the Ice Mountain?"
        [/message]
        [message]
            speaker=Ponce
            message=_"The spreading death from the ruins has left a lot of dry trees and brush.  We could start a pretty big fire."
        [/message]
        [message]
            speaker=Haldrad
            message=_"And what would that accomplish?"
        [/message]
        [message]
            speaker=Ponce
            message=_"The Winged Daemon thinks of herself as a goddess to be worshipped, she surely wants to settle in on the ruins of your capital.  A big fire could destroy what is left, she'd want to extinguish it.  And even if that doesn't turn out to be the case, the fire will draw attention to our fight, and she should come to crush us."
        [/message]
        [message]
            speaker=Haldrad
            message=_"I'm not sure I like this plan, but I did ask for bold thinking, and it's better than anything I can think of.  Very well, let us start a fire, I think that point near the central dead forest would be ideal."
        [/message]
        [message]
            speaker=narrator
            message=_"
Send a 'fire starter' to the center of the three largest dead forests, the one that covers hex (25,22)."
        [/message]
        [scroll_to]
            x,y=25,22
        [/scroll_to]
        [delay]
            time=350
        [/delay]
        [item]
            image=items/gohere.png
            x,y=25,22
        [/item]
        [delay]
            time=450
        [/delay]
        [remove_item]
            image=items/gohere.png
            x,y=25,22
        [/remove_item]
        [delay]
            time=450
        [/delay]
        [item]
            image=items/gohere.png
            x,y=25,22
        [/item]
        [delay]
            time=450
        [/delay]
        [objectives]
            {TRI_OBJ_SUMMARY (_"King Haldrad")}
            side=1
            [objective]
                condition=win
                description=_"Set Forest Fire"
            [/objective]
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
            note=_"Send a 'fire starter' to the center of the three largest dead forests, the one that covers hex (25,22)."
        [/objectives]
        [objectives]
            {TRI_OBJ_SUMMARY (_"The Khthon")}
            side=5
            [objective]
                condition=win
                description=_"Set Forest Fire"
            [/objective]
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
            note=_"Send a 'fire starter' to the center of the three largest dead forests, the one that covers hex (25,22)."
        [/objectives]

        [if]
            [have_unit]
                side=1,5
                [has_attack]
                    type=fire
                [/has_attack]
                #                type={TRI_FIRESTARTER_TYPES},Pyradalon
                search_recall_list=no
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        side=1,5
                        [has_attack]
                            type=fire
                        [/has_attack]
                        #                        type={TRI_FIRESTARTER_TYPES},Pyradalon
                        x,y=1-28,1-28
                    [/filter]
                    kill=no
                    variable=fs
                [/store_unit]
                [message]
                    speaker=Haldrad
                    message=_"You look up to the job, $fs[0].name|.  Get to that central forest and set fire to the dry wood fuel."
                [/message]
                {CLEAR_VARIABLE fs}
                [event]
                    remove=yes
                    id=fs_recall
                [/event]
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 4
        [filter_condition]
            [not]
                [have_location]
                    terrain=*^Ffyr
                [/have_location]
            [/not]
        [/filter_condition]
        [message]
            speaker=Haldrad
            message=_"We really should get started on setting that fire..."
        [/message]
        [if]
            [have_unit]
                side=1,5
                [has_attack]
                    type=fire
                [/has_attack]
                #                type={TRI_FIRESTARTER_TYPES},Pyradalon
                search_recall_list=no
            [/have_unit]
            [else]
                [message]
                    speaker=narrator
                    message=_"Recall a unit with fire attacks from either side 1 or side 5."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=recall
        id=fs_recall
        [filter]
            side=1,5
            [has_attack]
                type=fire
            [/has_attack]
            #            type={TRI_FIRESTARTER_TYPES},Pyradalon
        [/filter]
        [filter_condition]
            [variable]
                name=turn_number
                greater_than=1
            [/variable]
        [/filter_condition]
        [message]
            speaker=Haldrad
            message=_"You look up to the job, $unit.name|.  Get to that central forest and set fire to the dry wood fuel."
        [/message]
        [scroll_to]
            x,y=25,22
        [/scroll_to]
        [delay]
            time=150
        [/delay]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,5
            [has_attack]
                type=fire
            [/has_attack]
            #            type={TRI_FIRESTARTER_TYPES},Pyradalon
            x=19-32
            y=18-40
            [filter_location]
                [filter_adjacent_location]
                    terrain=*^Fd*
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]
        [message]
            speaker=unit
            message=_"This space will have to do..."
        [/message]
        [terrain]
            [and]
                terrain=*^Fd*
                [filter_adjacent_location]
                    [filter]
                        id=$unit.id
                    [/filter]
                [/filter_adjacent_location]
            [/and]
            terrain=Rd^Ffyr
        [/terrain]
        #	[remove_unit_overlay]
        #	    id=$fire_starter.id
        #	    image=misc/loyal-icon.png~CS(200,-200,-200)
        #	[/remove_unit_overlay]
        [music]
            name=breaking_the_chains.ogg
            append=no
            immediate=yes
        [/music]
        [redraw]
            side=1,5
        [/redraw]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_location]
                terrain=*^Ffyr
                count=1-99
            [/have_location]
        [/filter_condition]
        {TRI_FOREST_FIRE}
        # why does fire not spread to where unit is standing?
        [if]
            [have_unit]
                [filter_location]
                    [filter_adjacent_location]
                        terrain=*^Ffyr
                        count=6
                    [/filter_adjacent_location]
                [/filter_location]
            [/have_unit]
            [then]
                [kill]
                    [filter_location]
                        [filter_adjacent_location]
                            terrain=*^Ffyr
                            count=6
                        [/filter_adjacent_location]
                    [/filter_location]
                    fire_event=yes
                [/kill]
            [/then]
        [/if]
        [if]  # make these dialogues depend only upon characters that are safe for either branch, so the message just won't show if it makes no sense
            [have_location]
                x=37
                terrain=*^Ffyr
            [/have_location]
            [not] # so it should only fire once.  Is this good enough?
                [have_location]
                    x=37-44
                    terrain=*^Ffyr
                [/have_location]
            [/not]
            [then]
                [message]
                    speaker=Nemesis
                    message=_"The fire is in danger of getting out of hand, we cannot let it spread much further to the east.  We need to crush the opposition, so we can focus on fire control."
                [/message]
            [/then]
        [/if]
        [if]
            [have_location]
                x=44
                terrain=*^Ffyr
            [/have_location]
            [then]
                [message]
                    speaker=Nemesis
                    message=_"The fire has escaped this sparse environment, it has reached a bountiful fuel source..."
                [/message]
                [message]
                    speaker=Nemesis
                    message=_"I would have suggested retreating back to the Sky Mountain, but since Dardrus destroyed the Angry Eye, the mountain is grounded.  There is no escape..."
                [/message]
                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]
        [/if]
    [/event]

    [event]
        name=new turn
        first_time_only=yes
        [filter_condition]
            [have_location]
                terrain=*^Ffyr
                count=12-99
            [/have_location]
        [/filter_condition]
        # the sky mountain arrives
    [/event]

    # defeating the ranger side 4, with Haldrad ...
    [event]
        name=last breath
        [filter]
            id=Remington
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=unit
            message=_"I fall, but there are others.  Wesnothians have survived oppressors and plagues before, we will survive you too!"
        [/message]
        [message]
            speaker=second_unit
            message=_"Don't be so melodramatic."
        [/message]
        [message]
            speaker=Haldrad
            message=_"We're not a plague, and we're certainly not the oppressors.  Believe me when I say we are here to stop the oppressors and we could really use your help!"
        [/message]
        [message]
            side=4
            message=_"We got off on the wrong foot, but I can see that you aren't like the monsters.  You may even be the Prince.  We'll unite with you to drive out the oppressors."
        [/message]
        {MODIFY_UNIT (side=4
        [not]
            canrecruit=yes
        [/not]) side 1}
        [store_gold]
            side=4
            variable=side4_gold
        [/store_gold]
        [gold]
            side=1
            amount=$side4_gold
        [/gold]
        [store_gold]
            side=1
            variable=side1_gold
        [/store_gold]
        [while]
            [variable]
                name=side1_gold
                less_than=200
            [/variable]
            [do]
                [gold]
                    side=1
                    amount=20
                [/gold]
                [store_gold]
                    side=1
                    variable=side1_gold
                [/store_gold]
            [/do]
        [/while]
        [allow_recruit]
            side=1
            type=Woodsman, Poacher, Thief
        [/allow_recruit]
        [message]
            speaker=narrator
            message=_"Haldrad can now recruit some of the resisting humans."
        [/message]
        {CLEAR_VARIABLE side1_gold}
        {CLEAR_VARIABLE side4_gold}
    [/event]

    # ... with thralls, then side 4 just runs away...
    [event]
        name=last breath
        [filter]
            id=Remington
        [/filter]
        [filter_second]
            race=thrall_khthon,tri_outlander
        [/filter_second]
        [message]
            name=unit
            message=_"I fall, but there are others.  Wesnothians have survived oppressors and plagues before, we will survive you too!"
        [/message]
        [kill]
            id=Remington
            animate=yes
        [/kill]
        [message]
            side=4
            message=_"Remington has fallen to the zombies!  Fall back!"
        [/message]
        [kill]
            side=4
            animate=no
        [/kill]
    [/event]

    #  ... and if it was Khthon, some new Khthons are formed, and side5 gets more money.
    [event]
        name=attacker_hits
        [filter]
            race=khthon
        [/filter]
        [filter_second]
            id=Remington
        [/filter_second]
        [message]
            role=Khthon_Leader
            message=_"Join us in our fight against the oppressors..."
        [/message]
        {MODIFY_UNIT (id=Remington) canrecruit no}
        {ARCHAIC_KHTHONIZE_MAJOR (id=Remington)}
        {ARCHAIC_KHTHONIZED (
            side=4
            [not]
                id=Remington
            [/not]
        )}
        {MODIFY_UNIT (side=4) side 5}
        [gold]
            side=5
            amount=100
        [/gold]
    [/event]

    # if Khthon are advancing on the Primevalists
    [event]
        name=enter_hex
        [filter]
            side=5
            x=1-17
            y=23-26
        [/filter]
        [allow_undo]
        [/allow_undo]
        [gold]
            amount=120
            side=2
        [/gold]
    [/event]

    # the mountain arrives when side 4 is gone, and there is a forest fire
    [event]
        # testing
        #	name=turn 2
        name=side 3 turn
        # ifdef __UNUSED__
        [filter_condition]
            [not]
                [have_unit]
                    side=4
                [/have_unit]
            [/not]
            [have_location]
                terrain=*^Ffyr
            [/have_location]
        [/filter_condition]
        # endif
        [set_variable] # five or six turns may be too much, changing from 1->2
            name=sceptre_count
            value=2
        [/set_variable]
        [message]
            speaker=Dwyire
            message=_"I can see the Sky Mountain!  Our Goddess arrives!"
        [/message]
        [music]
            name=suspense.ogg
            append=no
            immediate=yes
        [/music]
        {FADE_TO_BLACK}
        [terrain_mask]
            x,y=9,36
            #            x,y=34,39
            mask="{~add-ons/Trinity/maps/Coda-Mountain.map}"
            border=yes
            [rule]
                new=_f
                use_old=yes
            [/rule]
            [rule]
                use_old=no
            [/rule]
        [/terrain_mask]
        [unstore_unit]
            variable=nemesis
            x,y=13,40
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=dardrus
            x,y=17,43
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=bresda
            x,y=18,42
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE nemesis}
        {CLEAR_VARIABLE dardrus}
        {CLEAR_VARIABLE bresda}
        [modify_side]
            side=3
            hidden=no
        [/modify_side]
        [modify_side]
            side=6
            controller=ai
            hidden=no
        [/modify_side]
        {FADE_IN}
        [message]
            speaker=Nemesis
            message=_"I thought there was something strange about this fire..."
        [/message]
        [message]
            speaker=Bresda
            message=_"What are you doing here, Haldrad?  What sort of Khthon sorcery is this?"
        [/message]
        [message]
            speaker=Haldrad
            message=_"You and your, ahem, goddess left me no choice.  She abandoned me and my followers to die on that dark world."
        [/message]
        [message]
            speaker=Ponce
            message=_"No doubt she wanted a cleaner take-over of this realm.  I know you worship the ground she walks on, Bresda, but that is not a just and wise god you serve.  We will not be brought under her heel."
        [/message]
        [message]
            speaker=Bresda
            message=_"<i>*snort*</i>  No, you would rather throw yourself down before the green-eyed plague!  You used to be an honorable man, Ponce, but your short-sightedness and audacity have gotten the better of you.  Come on, Dardrus, let's stomp out this fire, and this plague!"
        [/message]
        [message]
            speaker=narrator
            message=_"Dardrus knew, much better than did Bresda, what a triumph of Nemesis would mean for the humans.  He also knew, much better than did Haldrad, what a failure to stamp out the Khthon Plague would mean."
        [/message]
        [message]
            speaker=Dardrus
            message=_"Let's focus on the fire, for now."
        [/message]
        {MOVE_UNIT (id=Bresda) 14 33}
        [message]
            speaker=Bresda
            message=_"And let us also focus on reaching our forces in the southwestern camp.  I doubt General Dwyire has the wherewithall to fend off the Khthon."
        [/message]
        [objectives]
            side=3
            {TRI_OBJ_SUMMARY (_"Bresda and Dardrus")}
            [objective]
                condition=win
                description=_"Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Side Leaders and Heroes"
            [/objective]
            note=_"The direction this scenario goes depends upon the actions of Dardrus, whether he attacks Nemesis or not."
        [/objectives]
        [event]
            name=moveto
            [filter]
                id=Bresda,Dardrus
                x=3,6
                y=27,28
            [/filter]
            [message]
                speaker=Dwyire
                message=_"Thank the fates you made it back!  Your soldiers are ready at your command!"
            [/message]
            [set_recruit]
                side=3
                recruit="Primevalist Fighter, Primevalist Follower, SouthSeas Seaman, SouthSeas Shoreman, SouthSeas Caster"
            [/set_recruit]
            [message]
                speaker=narrator
                message=_"Side 3 can recruit level 1 Primevalists and South-Seas again."
            [/message]
        [/event]
    [/event]

    # events for Dardrus attacking Nemesis - She loses her immortality and the Khthon becomes the main enemy to beat
    # Nemesis triumphs, but she is mortal, so her rule cannot last forever
    [event]
        name=select
        first_time_only=no
        id=d_choice_select
        [filter]
            id=Dardrus
        [/filter]
        [filter_condition]
            [variable]
                name=side_number
                equals=3
            [/variable]
        [/filter_condition]
        [modify_side]
            side=6
            team_name=Primeval2
        [/modify_side]
        [object]
            [filter]
                id=Dardrus
            [/filter]
            silent=yes
            id=dardrus_sceptre1
            # need to make this powerful enough that player is tempted to attack Nemesis
            # new special might do it
            [effect]
                apply_to=new_attack
                name=sceptre of fire
                description= _ "sceptre of fire"
                icon=attacks/fireball.png
                type=fire
                range=ranged
                [specials]
                    {WEAPON_SPECIAL_MAGICAL}
                    [drains]
                        name= _ "corruption"
                        description= _ "The odd power in the Ruby has odd effects on those exposed to it.  It can turn cunning and gifted leaders into snarling madmen, turn honest guardians into scheming thieves, and turn the mighty into mere children.  What effect it might have on those that fancy themselves gods can only be speculated."
                        id=tri_drain_corruption
                    [/drains]
                [/specials]
                damage=64
                number=4
            [/effect]

            [effect]
                apply_to=new_animation

                [attack_anim]
                    [filter_attack]
                        name=sceptre of fire
                    [/filter_attack]

                    {MISSILE_FRAME_FIREBALL}

                    start_time=-200
                    [frame]
                        #                        image=$unit.image
                        image=$unit.image|~BLIT(misc/dardrus_sceptre.png)
                        sound=fire.wav
                    [/frame]
                [/attack_anim]
            [/effect]
        [/object]

        [event]
            name=select
            first_time_only=no
            id=d_choice_cleanup2
            [filter]
                [not]
                    id=Dardrus
                [/not]
            [/filter]
            [filter_condition]
                [variable]
                    name=side_number
                    equals=3
                [/variable]
            [/filter_condition]
            [modify_side]
                side=6
                team_name=Primeval
            [/modify_side]
            [object]
                [filter]
                    id=Moopy
                    #                    id=Dardrus
                [/filter]
                silent=yes
                [effect]
                    apply_to=remove_attacks
                    name=sceptre of fire
                [/effect]
            [/object]
        [/event]
    [/event]
    # FLAG:  clean-up doesn't cover all cases, it seems.  This still needs work
    [event]
        name=side 3 turn end # was 'turn 3 end', is hopefully fixed now?
        first_time_only=no
        id=d_choice_cleanup1
        [modify_side]
            side=6
            team_name=Primeval
        [/modify_side]
        [object]
            [filter]
                id=Moopy
                #                id=Dardrus
            [/filter]
            silent=yes
            [effect]
                apply_to=remove_attacks
                name=sceptre of fire
            [/effect]
        [/object]
    [/event]
    [event]
        name=attack_ends
        [filter]
            id=Dardrus
        [/filter]
        [event]
            id=d_choice_cleanup1
            remove=yes
        [/event]
        [event]
            id=d_choice_cleanup2
            remove=yes
        [/event]
        [event]
            id=d_choice_select
            remove=yes
        [/event]
    [/event]
    [event]
        name=attack
        [filter]
            id=Dardrus
        [/filter]
        [filter_second]
            id=Nemesis
        [/filter_second]
        [music]
            name=In_the_Land_of_Madness.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Dardrus
            message=_"I cannot allow you to bring about a Neo-Pantheon!  We will not go back to the old order!"
        [/message]
    [/event]
    # FLAG: the object works, but something is off in these attacker/defender things <-had primary/secondary unit confusion for defender_hits
    # adding FCTH, maybe that will make this work.
    {FORCE_CHANCE_TO_HIT (id=Dardrus) (id=Nemesis) 100 ()}
    {FORCE_CHANCE_TO_HIT (id=Nemesis) (id=Dardrus) 100 ()}
    [event]
        name=attacker_hits
        [filter]
            id=Dardrus
        [/filter]
        [filter_second]
            id=Nemesis
        [/filter_second]
        [filter_attack]
            name=sceptre of fire
        [/filter_attack]

        {FLASH_RED (
            [object]
                id=tri_nemesis_lost_immortal
                silent=yes
                [filter]
                    id=Nemesis
                [/filter]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [regenerates]
                            id=aa_immortal
                        [/regenerates]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_REGENERATES}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=-600
                    increase=-600
                [/effect]
            [/object]
            [delay]
                time=250
            [/delay]
            [message]
                speaker=Nemesis
                message=_"Argh!  What have you done?!"
            [/message]
        )}
        [message]
            speaker=Dardrus
            message=_"I never trusted you gods, but you were strong and I was not.  However, I have seen from where you draw your power..."
        [/message]
        [message]
            speaker=Nemesis
            message=_"<i>Are you completely mad?  We needed that crystal!</i>"
        [/message]
        [message]
            speaker=Dardrus
            message=_"I had heard that Ares died in an explosion of one of the Angry Eyes.  I could not get the Sceptre to explode, but I know its raw power is still corrupting of the flesh.  Tell me, how god-like do you feel now?"
        [/message]
        [message]
            speaker=Nemesis
            message=_"Grrr!"
        [/message]
        [event]
            name=defender_hits
            [filter]
                id=Dardrus
            [/filter]
            [filter_second]
                id=Nemesis
            [/filter_second]
            [message]
                speaker=Nemesis
                message=_"Die, Dardrus, you traitor!"
            [/message]
            [kill]
                id=Dardrus
                animate=yes
            [/kill]
            [item]
                image=misc/sceptre-of-fire-ruined.png
                x,y=$x1,$y1
            [/item]
            [modify_side]
                side=6
                team_name=Primeval
            [/modify_side]
            [modify_side]
                side=6
                controller=human
            [/modify_side]
            [message]
                speaker=Bresda
                message=_"What has happened, Ish-Nemesis?  What has he done to you?"
            [/message]
            [message]
                speaker=Nemesis
                message=_"It was treachery not even I could forsee...  I'll admit, I've felt better but I'll live.  Let us defeat these Khthon and their slaves."
            [/message]
            # make it so that side 1 is now enemy, player is side 3.  But there can be a conversion mechanism, probably via Nemesis, so all side 1 does not need to be killed.
            [music]
                name=legends_of_the_north.ogg
                append=no
                immediate=yes
            [/music]
            [message]
                speaker=Haldrad
                message=_"Dardrus wouldn't have just thrown his life away like that, he must have weakened the goddess somehow."
            [/message]
            [message]
                speaker=Ponce
                message=_"Now we stand a chance!"
                #		    message=_"Now we stand a chance!  Men, get away from Keldan's beasts!  With the winged daemon is weakened, we no longer need this terrible alliance!"
            [/message]
            [message]
                speaker=Bresda
                message=_"No, Ponce, you don't stand a chance.  If you succeed in defeating us, the Khthon will take over."
            [/message]
            [message]
                speaker=Haldrad
                message=_"And if we don't defeat you, your Goddess will enslave us all.  The Khthon are complicated, but you give us no choice!"
            [/message]
            #		[message]
            #		    role=Khthon_Leader
            #		    message=_"Really!  We have methods for dealing with your type!"
            #		[/message]
            [set_variable]
                name=sceptre_count
                value=0
            [/set_variable]
            [modify_side]
                side=5
                controller=ai
            [/modify_side]
            [modify_side]
                side=1
                controller=ai
            [/modify_side]
            #	[objectives]
            #	    side=1
            #	    [objective]
            #		condition=win
            #		description=_"Defeat Khthon"
            #	    [/objective]
            #	    [objective]
            #		condition=lose
            #		description=_"Death of Haldrad or Ponce"
            #	    [/objective]
            #	    note=_""
            #	[/objectives]
            [objectives]
                side=3
                {TRI_OBJ_SUMMARY (_"Bresda")}
                [objective]
                    condition=win
                    description=_"Defeat Khthon"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Death of Bresda or Nemesis"
                [/objective]
                #	    note=_""
            [/objectives]
            [objectives]
                side=6
                {TRI_OBJ_SUMMARY (_"Nemesis")}
                [objective]
                    condition=win
                    description=_"Defeat Khthon"
                [/objective]
                [objective]
                    condition=win
                    description=_"Recruit Haldrad"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Death of Bresda or Nemesis"
                [/objective]
                note=_"Nemesis can try to turn the members of side 1 she fights (including Haldrad).  If successful, she makes them immune to Khthon enthrallment."
            [/objectives]
            # some things to build up the Khthon
            [gold]
                amount=225
                side=5
            [/gold]
            [unit]
                side=5
                type=Skylliaron
                x,y=1,1
            [/unit]
            [unit]
                side=5
                type=Ophis
                x,y=11,1
            [/unit]
            [event]
                name=attack
                [filter]
                    id=Kerrnyn
                [/filter]
                [filter_second]
                    id=Nemesis
                [/filter_second]
                [message]
                    speaker=Kerrnyn
                    message=_"My Goddess, it is I, your servant Kerrnyn.  I could never raise my hand against you."
                [/message]
                [message]
                    speaker=Nemesis
                    message=_"Let us both raise our weapons against the Khthon and their weak-minded friends."
                [/message]
                [set_variable]
                    name=unit.side
                    value=6
                [/set_variable]
                [set_variable]
                    name=unit.moves
                    value=$unit.max_moves
                [/set_variable]
                [set_variable]
                    name=unit.attacks_left
                    value=1
                [/set_variable]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [set_variable]
                    name=second_unit.moves
                    value=$second_unit.max_moves
                [/set_variable]
                [set_variable]
                    name=second_unit.attacks_left
                    value=1
                [/set_variable]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
            [/event]
            [event]
                name=attack
                [filter]
                    id=Nemesis
                [/filter]
                [filter_second]
                    id=Kerrnyn
                [/filter_second]
                [message]
                    speaker=Kerrnyn
                    message=_"My Goddess, it is I, your servant Kerrnyn.  I could never raise my hand against you."
                [/message]
                [message]
                    speaker=Nemesis
                    message=_"Let us both raise our weapons against the Khthon and their weak-minded friends."
                [/message]
                [set_variable]
                    name=second_unit.side
                    value=6
                [/set_variable]
                [set_variable]
                    name=second_unit.moves
                    value=$second_unit.max_moves
                [/set_variable]
                [set_variable]
                    name=second_unit.attacks_left
                    value=1
                [/set_variable]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
                [set_variable]
                    name=unit.moves
                    value=$unit.max_moves
                [/set_variable]
                [set_variable]
                    name=unit.attacks_left
                    value=1
                [/set_variable]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/event]
            [event]
                name=attacker_hits
                first_time_only=no
                [filter]
                    id=Nemesis
                [/filter]
                [filter_second]
                    side=1
                    [not]
                        id=Ponce
                    [/not]
                [/filter_second]
                [filter_condition]
                    [have_unit]
                        x,y=$x2,$y2
                    [/have_unit]
                [/filter_condition]
                [if]
                    [variable]
                        name=second_unit.id
                        equals=Haldrad
                    [/variable]
                    [then]
                        [message]
                            speaker=Nemesis
                            message=_"You have proven yourself more tenacious than I thought.  I give you one last chance:  Will you bear my mark?"
                        [/message]
                        [message]
                            speaker=Ponce
                            message=_"No!  Don't do it!"
                        [/message]
                        [message]
                            speaker=Haldrad
                            message=_"I...  I don't like working with the green-eyed beasts...  I accept your offer, I shall bear your mark..."
                        [/message]
                        [message]
                            speaker=Ponce
                            message=_"You are a fool!  Not all of us roll over so easily, we shall never submit to the murderous daemon!"
                        [/message]
                        {MODIFY_UNIT (id=Haldrad) canrecruit no}
                        {MODIFY_UNIT (id=Ponce) canrecruit yes}
                        {MODIFY_UNIT (id=Haldrad) side 6}
                        {MODIFY_UNIT (id=Haldrad) race primevalist_human}
                        {FULL_HEAL (id=Haldrad)}
                        [message]
                            speaker=narrator
                            message=_"Nemesis raked her nails across Haldrad's neck, leaving streaks of blue."
                        [/message]
                        [message]
                            speaker=Nemesis
                            message=_"We can do better later, but for now, while the bruises persist, you are immune to the Khthon Plague."
                        [/message]
                        [if]
                            [not]
                                [have_unit]
                                    race=khthon
                                [/have_unit]
                            [/not]
                            [then]
                                [message]
                                    speaker=Ponce
                                    message=_"We won't win this fight, fall back!"
                                [/message]
                                [endlevel]
                                    {CONTINUE}
                                [/endlevel]
                            [/then]
                        [/if]
                    [/then]
                    [else]
                        [message]
                            speaker=Nemesis
                            message=_"You fought well, I will give you one more chance:  Will you wear my mark?"
                        [/message]
                        [set_variable]
                            name=accept_yn
                            rand=1..9
                        [/set_variable]
                        [if]
                            [variable]
                                name=accept_yn
                                less_than=4
                            [/variable]
                            [then]
                                [message]
                                    speaker=second_unit
                                    message=_"Never!"
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=second_unit
                                    message=_"I serve one king or another, but at least I do not have to watch my back for the green-eyed beasts.  I accept."
                                [/message]
                                [message]
                                    speaker=narrator
                                    message=_"Nemesis raked her claws against $second_unit.name|'s face, leaving some blue lines."
                                [/message]
                                [heal_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    amount=full
                                    restore_attacks=yes
                                    restore_statuses=yes
                                    moves=full
                                [/heal_unit]
                                {MODIFY_UNIT (id=$second_unit.id) side 6}
                                #                                {MODIFY_UNIT (id=$second_unit.id) race primevalist_human}
                                [object]
                                    silent=yes
                                    duration=scenario
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=status
                                        add=unplagueable
                                    [/effect]
                                [/object]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/event]
        [/event]
        # deaths that apply to this branch only
        [event]
            name=last_breath
            [filter]
                id=Bresda
            [/filter]
            [message]
                speaker=Bresda
                message=_"This cannot be happening..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
        [event]
            name=last_breath
            [filter]
                id=Nemesis
            [/filter]
            [message]
                speaker=Nemesis
                message=_"I'll admit...  I didn't see this happening..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
        [event]
            name=last_breath
            [filter]
                id=Ponce
                canrecruit=yes
            [/filter]
            [message]
                speaker=Ponce
                message=_"This is not the end.  There will always be those of us who do not bow down to the winged daemon!"
            [/message]
            {MOVE_UNIT (id=Ponce) 1 1}
            [kill]
                id=Ponce
            [/kill]
        [/event]
        [event] # conditions where the player could have killed him
            name=last_breath
            first_time_only=no
            [filter]
                id=Haldrad
                canrecruit=yes
                [filter_side]
                    controller=human
                [/filter_side]
            [/filter]
            [message]
                speaker=Haldrad
                message=_"Ponce, this is not going well..."
            [/message]
            {MOVE_UNIT (id=Haldrad) 1 1}
            [heal_unit]
                [filter]
                    id=Haldrad
                [/filter]
                amount=8
            [/heal_unit]
            [message]
                speaker=Haldrad
                message=_"I'll rejoin the battle when I can."
            [/message]
        [/event]
        [event]
            name=last_breath
            first_time_only=no
            [filter]
                id=Ponce
                canrecruit=no
                [filter_side]
                    controller=ai
                [/filter_side]
            [/filter]
            [message]
                speaker=Ponce
                message=_"Haldrad, this is not going well..."
            [/message]
            {MOVE_UNIT (id=Ponce) 1 1}
            [heal_unit]
                [filter]
                    id=Ponce
                [/filter]
                amount=4
            [/heal_unit]
            [message]
                speaker=Ponce
                message=_"I'll rejoin the battle when I can."
            [/message]
        [/event]
        [event]
            name=last_breath
            [filter]
                race=khthon
            [/filter]
            [filter_condition]
                [not]
                    [have_unit]
                        race=khthon
                    [/have_unit]
                [/not]
                [have_unit]
                    id=Haldrad
                    side=6
                [/have_unit]
            [/filter_condition]
            [message]
                speaker=Bresda
                message=_"We've defeated the Plague!"
            [/message]
            [message]
                speaker=Bresda
                message=_"Now it's just a mop-up operation.  Soon, we begin the building of our new home."
            [/message]
            [message]
                speaker=Ponce
                message=_"Fall back!  We won't win this fight today, but we shall not give up!"
            [/message]
            [endlevel]
                {CONTINUE}
            [/endlevel]
        [/event]
    [/event]
    # might expand this, but for now, keeping it simple
    [event]
        name=attack_hits
        [filter]
            id=Dardrus
        [/filter]
        [filter_second]
            id=Nemesis
        [/filter_second]
        [filter_attack]
            [not]
                name=sceptre of fire
            [/not]
        [/filter_attack]
        [event]
            name=defender_hits
            [filter]
                id=Dardrus
            [/filter]
            [filter_second]
                id=Nemesis
            [/filter_second]
            [music]
                name=legends_of_the_north.ogg
                append=no
                immediate=yes
            [/music]
            [message]
                speaker=Nemesis
                message=_"Die, Dardrus, you traitor!"
            [/message]
            [kill]
                id=Dardrus
                animate=yes
            [/kill]
            [message]
                speaker=Bresda
                message=_"Such senseless violence...  Why did he do that?"
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]

    # deaths that apply to both branches
    [event]
        name=last_breath # conditions were the player is controlling him, either as side 1 leader, or side 6 pawn
        [filter]
            id=Haldrad
            # actually, we need him for Epilogue as well
            #	    canrecruit=yes
            [filter_side]
                controller=human
            [/filter_side]
        [/filter]
        [message]
            speaker=Haldrad
            message=_"There is so much I still had to do..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last_breath
        [filter]
            id=Ponce
            canrecruit=no # There is a case where he is leader of player side, so maybe this should just be removed.  For now, just adding another (nested) event below
            [filter_side]
                controller=human
            [/filter_side]
        [/filter]
        [message]
            speaker=Ponce
            message=_"There is so much I still had to do..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #######################################
    # events for Dardrus not attacking Nemesis - Primevals are the enemy to beat
    [event]
        name=attack end
        [filter]
            id=Dardrus
        [/filter]
        [filter_second]
            [not]
                id=Nemesis
            [/not]
        [/filter_second]
        [filter_attack]
            name=sceptre of fire
        [/filter_attack]
        [kill]
            x,y=$x2,$y2
            animate=yes
        [/kill]
        [item]
            image=misc/sceptre-of-fire-ruined.png
            x,y=$x1,$y1
        [/item]
        [fire_event]
            name=broken_eye
        [/fire_event]
    [/event]

    [event]
        name=side 3 turn end
        first_time_only=no
        [filter_condition]
            [variable]
                name=sceptre_count
                greater_than=0
            [/variable]
            [variable]
                name=sceptre_count
                less_than=6
            [/variable]
        [/filter_condition]
        [set_variable]
            name=sceptre_count
            add=1
        [/set_variable]
        [if]
            [variable]
                name=sceptre_count
                equals=6
            [/variable]
            [then]
                [message]
                    speaker=Dardrus
                    message=_"Whoops..."
                [/message]
                [store_unit]
                    [filter]
                        id=Dardrus
                    [/filter]
                    variable=dardrus
                    kill=no
                [/store_unit]
                [item]
                    image=misc/sceptre-of-fire-ruined.png
                    x,y=$dardrus.x|,$dardrus.y|
                [/item]
                [floating_text]
                    x,y=$dardrus.x|,$dardrus.y|
                    text=_"Crack!"
                [/floating_text]
                [fire_event]
                    name=broken_eye
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event] # essentially the top scenario-level for this 'branch'
        name=broken_eye
        [object]
            [filter]
                id=Dardrus
            [/filter]
            silent=yes
            id=dardrus_sceptre2
            [effect]
                apply_to=remove_attacks
                name=sceptre of fire
            [/effect]
        [/object]
        [message]
            speaker=Nemesis
            message=_"What was that?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"That was the Angry Eye.  I didn't know it would break like that."
        [/message]
        [message]
            speaker=Nemesis
            message=_"Yes, I can see what it is.  What I want to know is what you were doing with it."
        [/message]
        [message]
            speaker=Dardrus
            message=_"I knew it was a powerful weapon, I wanted to use it to exterminate the Khthon."
        [/message]
        [message]
            speaker=Nemesis
            message=_"While I appreciate your dedication to that cause, I cannot have such a loose cannon running around.  Will you go quietly?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"No."
        [/message]
        [message]
            speaker=Haldrad
            message=_"I know it wasn't your idea to leave us behind, Dardrus.  You are not an enemy, as far as I am concerned."
        [/message]
        {MODIFY_UNIT (id=Dardrus) side 1}
        {MODIFY_UNIT (id=Dardrus) canrecruit no}
        [message]
            speaker=Dardrus
            message=_"Thank you, Haldrad.  I made a mistake.  We cannot let Nemesis become the unopposed victor, you will not like the order she imposes."
        [/message]
        [message]
            speaker=Ponce
            message=_"No kidding."
        [/message]
        [modify_side]
            side=3
            controller=ai
        [/modify_side]
        # FLAG: maybe we should put something here to prevent Bresda from being kill-able at this point?
        [modify_ai] # get Nemesis moving, not hanging around side 2 camp
            side=6
            action=add
            path=goal
            [goal]
                id=target_haldrad
                value=20
                name=target
                [criteria]
                    id=Haldrad
                [/criteria]
            [/goal]
        [/modify_ai]
        [objectives]
            side=1
            {TRI_OBJ_SUMMARY (_"King Haldrad")}
            [objective]
                condition=win
                description=_"Defeat Primevalists"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Haldrad, Ponce, or Dardrus"
            [/objective]
        [/objectives]
        [objectives]
            side=5
            {TRI_OBJ_SUMMARY (_"The Khthon")}
            [objective]
                condition=win
                description=_"Defeat Primevalists"
            [/objective]
            [objective]
                condition=lose
                description=_"Death of Haldrad, Ponce, or Dardrus"
            [/objective]
        [/objectives]
        [event]
            name=die
            [filter_second]
                id=Nemesis
            [/filter_second]
            [message]
                speaker=Haldrad
                message=_"Has it occured to anyone that we will not be able to defeat an immortal?"
            [/message]
            [message]
                role=Khthon_Leader
                message=_"There is a way, though it will take some sacrifice..."
            [/message]
            [message]
                speaker=Haldrad
                message=_"I'm listening..."
            [/message]
            [message]
                role=Khthon_Leader
                message=_"Khthon are mere mortals, but if we concentrate our strength, forcing many into one, we should be able to overpower any supposed immortal."
            [/message]
            [message]
                speaker=Haldrad
                message=_"So why haven't you done this sooner?  Haven't you been fighting Nemesis and her type for ages?"
            [/message]
            [message]
                role=Khthon_Leader
                message=_"It requires great sacrifice, and we had placed our hopes in Echidna and our other champions."
            [/message]
            [message]
                speaker=Ponce
                message=_"All right then, what do we need to do?"
            [/message]
            [message]
                role=Khthon_Leader
                message=_"One of you must be a vessel that carries as many Khthon as possible.  You must choose someone who can get close to the immortal.  Get close, and we shall take care of the rest.  She will recognize what we are doing, so choose the vessel wisely."
            [/message]
            [message]
                speaker=Haldrad
                message=_"I cannot ask anyone else to be that vessel, I will do it.  Ponce, I give command to you."
            [/message]
            [message]
                speaker=Ponce
                message=_"No!  You are the leader of your people, you have an important role to play.  Let me-"
            [/message]
            [message]
                speaker=Haldrad
                message=_"I'm not asking, Ponce.  As royalty and as 'the leader of my people', as you put it, I must do this."
            [/message]
            {MODIFY_UNIT (id=Ponce) canrecruit yes}
            {MODIFY_UNIT (id=Haldrad) canrecruit no}
            [message]
                role=Khthon_Leader
                message=_"Now, let Khthon enter you.  Carry as many as you can, then make your way to the goddess.  With our combined strength, we will triumph over her."
            [/message]
            [set_variable]
                name=haldrad_khthon_count
                value=0
            [/set_variable]
            [objectives]
                side=1
                {TRI_OBJ_SUMMARY (_"King Haldrad")}
                [objective]
                    condition=win
                    description=_"Defeat Primevalists"
                [/objective]
                [objective]
                    condition=win
                    description=_"Haldrad attacks Nemesis, once he has 6 Khthon spirits"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Death of Haldrad, Ponce, or Dardrus"
                [/objective]
                note=_"To collect a Khthon spirit, move Haldrad adjacent to any Khthon (but not a thrall).  Haldrad loses a Khthon spirit if he is hit."
            [/objectives]
            [objectives]
                side=5
                {TRI_OBJ_SUMMARY (_"The Khthon")}
                [objective]
                    condition=win
                    description=_"Defeat Primevalists"
                [/objective]
                [objective]
                    condition=win
                    description=_"Khthon spirits enter Haldrad"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Not enough surviving Khthon to give Haldrad 6 spirits"
                [/objective]
                note=_"Haldrad has to be able to move adjacent to a Khthon (but not a thrall) to collect them."
            [/objectives]
            [event]
                name=moveto
                id=coda_khthon_collect_k
                first_time_only=no
                [filter]
                    id=Haldrad
                    [filter_adjacent]
                        race=khthon
                        is_enemy=no
                    [/filter_adjacent]
                [/filter]
                [store_unit]
                    [filter]
                        race=khthon
                        [filter_adjacent]
                            id=Haldrad
                        [/filter_adjacent]
                    [/filter]
                    kill=no
                    variable=collected_khthon
                [/store_unit]
                [arc_message_box]
                    title="Khthon Collective"
                    message="Should $collected_khthon[0].name| join Haldrad in the attack of Nemesis? ($haldrad_khthon_count| collected)"
                    variable=khthon_counts
                [/arc_message_box]
                [if]
                    [variable]
                        name=khthon_counts
                        boolean_equals=yes
                    [/variable]
                    [then]
                        {CLEAR_VARIABLE khthon_counts}
                        [redraw]
                            side=1
                        [/redraw]
                        [animate_unit]
                            flag=attack
                            [filter]
                                id=$collected_khthon[0].name
                            [/filter]
                            [primary_attack]
                                name=khthon_vector
                            [/primary_attack]
                            hits=yes
                            [facing]
                                [filter]
                                    id=Haldrad
                                [/filter]
                            [/facing]
                        [/animate_unit]
                        [store_unit]
                            [filter]
                                id=Haldrad
                            [/filter]
                            variable=haldrad
                            kill=no
                        [/store_unit]
                        [set_variable]
                            name=haldrad_khthon_count
                            add=1
                        [/set_variable]
                        [set_variable]
                            name=haldrad.variables.khthon_count
                            value=$haldrad_khthon_count
                        [/set_variable]
                        [unstore_unit]
                            variable=haldrad
                            find_vacant=no
                            text="$haldrad_khthon_count|"
                            red,green,blue=220,255,220
                        [/unstore_unit]
                        [kill]
                            id=$collected_khthon[0].id
                            animate=no
                        [/kill]
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=haldrad_khthon_count
                        equals=6
                    [/variable]
                    [not]
                        [have_unit]
                            id=Haldrad
                            [has_attack]
                                name=khthon fire
                                range=ranged
                            [/has_attack]
                        [/have_unit]
                    [/not]
                    [then]
                        [message]
                            speaker=Haldrad
                            message=_"That's as many as I can bear...  Let's go get Nemesis..."
                        [/message]
                        [object]
                            silent=yes
                            id=haldrad_khthon_fire
                            [filter]
                                id=Haldrad
                            [/filter]
                            [effect]
                                apply_to=new_attack
                                name=khthon fire
                                description= _ "khthonic fire"
                                icon=attacks/lightbeam.png~CS(-55,10,-10)
                                type=arcane
                                range=ranged
                                #		                range=aetheric # some made-up bs -> this is no longer supported, it seems.  changing to 'ranged'
                                [specials]
                                    [chance_to_hit]
                                        id=aetherical
                                        name= _ "aetherical"
                                        description= _ "This attack always has a 100% chance to hit regardless of the defensive ability of the unit being attacked."
                                        value=100
                                        cumulative=no
                                    [/chance_to_hit]
                                    [petrifies]
                                        id=petrifies
                                        name= _ "petrifies"
                                        description= _ "This attack petrifies the target, turning it to stone. Units that have been petrified may not move or attack."
                                    [/petrifies]
                                    [attacks]
                                        id=tri_hexavector_damage
                                        name= _ "hexavector"
                                        description= _ "This attack is only available if unit is combined with 6 khthon spirits, and is fighting an immortal"
                                        description_inactive= _ "This attack is only available if unit is combined with 6 khthon spirits, and is fighting an immortal."
                                        add=1
                                        [filter_self]
                                            [filter_wml]
                                                [variables]
                                                    khthon_count=6
                                                [/variables]
                                            [/filter_wml]
                                        [/filter_self]
                                        [filter_opponent]
                                            id=Nemesis
                                        [/filter_opponent]
                                    [/attacks]
                                [/specials]
                                damage=50
                                number=0
                            [/effect]
                            [effect]
                                apply_to=new_animation

                                [attack_anim]
                                    [filter_attack]
                                        name=khthon fire
                                    [/filter_attack]

                                    start_time=-500
                                    blend_color=50,190,220
                                    blend_ratio=0~0.3:150,0.3~0.6:150,0.6~1:150,1~0.3:150,0.3~0.0:75
                                    {MISSILE_FRAME_FAERIE_FIRE}
                                [/attack_anim]
                            [/effect]
                        [/object]
                    [/then]
                [/if]
                [event]
                    name=new turn
                    id=new_frogs
                    first_time_only=no
                    [store_locations]
                        terrain=*^F*
                        variable=dspawn_locs
                    [/store_locations]
                    [set_variable]
                        name=loc_index_dspawn
                        rand=1..$dspawn_locs.length
                    [/set_variable]
                    [unit]
                        side=5
                        type=Toad
                        x,y=$dspawn_locs[$loc_index_dspawn].x|,$dspawn_locs[$loc_index_dspawn].y|
                    [/unit]
                    {CLEAR_VARIABLE dspawn_locs}
                    {CLEAR_VARIABLE loc_index_dspawn}
                [/event]
            [/event]
            [event]
                name=attacker_hits
                first_time_only=no
                [filter_second]
                    id=Haldrad
                [/filter_second]
                [filter_condition]
                    [variable]
                        name=haldrad_khthon_count
                        greater_than=0
                    [/variable]
                [/filter_condition]
                [set_variable]
                    name=haldrad_khthon_count
                    add=-1
                [/set_variable]
                [set_variable]
                    name=second_unit.variables.khthon_count
                    add=-1
                [/set_variable]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
            [/event]
        [/event]
        [event]
            name=attack
            [filter]
                id=Haldrad
            [/filter]
            [filter_second]
                id=Nemesis
            [/filter_second]
            # make a better filter than this...
            [filter_condition]
                [variable]
                    name=haldrad_khthon_count
                    greater_than_equal_to=6
                [/variable]
            [/filter_condition]
            [message]
                speaker=Haldrad
                image=portraits/haldrad-khthon-back.png~BLIT(portraits/haldrad.png,0,0)~BLIT(portraits/haldrad-khthon-front.png,0,0)
                message="<span color='#22FF22'>" + _ "THIS IS THE FATE OF TYRANTS!" + "</span>"
            [/message]
        [/event]
        [event]
            name=attacker_hits
            [filter]
                id=Haldrad
            [/filter]
            [filter_second]
                id=Nemesis
            [/filter_second]
            [filter_condition]
                [variable]
                    name=haldrad_khthon_count
                    equals=6
                [/variable]
            [/filter_condition]
            {FLASH_GREEN (
                [delay]
                    time=800
                [/delay]
                [item]
                    x,y=$second_unit.x|,$second_unit.y|
                    halo="halo/holy/light-beam-[1~7,6~1].png~CS(-50,80,-30):150"
                [/item]
                #		    [unstore_unit] # to prevent the fight from contniuing (even though she is stoned) -> does not work.  Give Haldrad a new attack, that is not melee or ranged, so there is no counter -> ugly.  Giving 100% CTH & petrify special (ranged) instead
                # 			# petrify special in the attack does not work.  Killing Nemesis, replacing her with dummy unit, then petrifying it.
                #			variable=second_unit
                #			find_vacant=no
                #		    [/unstore_unit]
                [kill]
                    id=Nemesis
                    animate=no
                [/kill]
                [unit]
                    side=6
                    id=Nemesis_
                    name=Nemesis
                    type=Primeval Nemesis2
                    x,y=$second_unit.x|,$second_unit.y|
                    facing=$second_unit.facing
                [/unit]
                [petrify]
                    id=Nemesis_
                [/petrify]
                [harm_unit]
                    [filter]
                        id=Haldrad
                    [/filter]
                    amount=36
                    kill=no
                [/harm_unit]
                [object]
                    silent=yes
                    id=haldrad_khthon_fire_gone
                    [filter]
                        id=Haldrad
                    [/filter]
                    [effect]
                        apply_to=remove_attacks
                        name=khthon fire
                    [/effect]
                [/object]
                [remove_event]
                    id=coda_khthon_collect_k
                [/remove_event]
                [remove_event]
                    id=new_frogs
                [/remove_event]
            )}
            [message]
                speaker=Haldrad
                message=_"Ugh...  I hope I don't have to do that again."
            [/message]
            [message]
                speaker=Ponce
                message=_"But it worked!  The daemon is turned to stone!"
            [/message]
            [message]
                speaker=Bresda
                message=_"No!  We'll figure out a way to undo your evil plague magic."
            [/message]
            [objectives]
                side=1
                {TRI_OBJ_SUMMARY (_"King Haldrad and Ponce")}
                [objective]
                    condition=win
                    description=_"Defeat Bresda"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Death of Haldrad, Ponce, or Dardrus"
                [/objective]
            [/objectives]
            [objectives]
                side=5
                {TRI_OBJ_SUMMARY (_"The Khthon")}
                [objective]
                    condition=win
                    description=_"Defeat Bresda"
                [/objective]
                [objective]
                    condition=lose
                    description=_"Death of Haldrad, Ponce, or Dardrus"
                [/objective]
            [/objectives]
            [if]
                [have_unit]
                    id=Bresda
                [/have_unit]
                [then]
                    [event]
                        name=last_breath
                        [filter]
                            id=Bresda
                        [/filter]
                        [message]
                            speaker=Bresda
                            message=_"The Khthon have won.  I hope you idiots are happy..."
                        [/message]
                        [message]
                            speaker=Haldrad
                            message=_"It's not as bad as that.  You'll see."
                        [/message]
                        [store_unit]
                            [filter]
                                id=Ponce
                            [/filter]
                            variable=ponce
                            kill=no
                        [/store_unit]
                        [store_unit]
                            [filter]
                                id=Dardrus
                            [/filter]
                            variable=dardrus
                            kill=no
                        [/store_unit]
                        [endlevel]
                            {CONTINUE}
                            next_scenario=Epilog_Khthon
                        [/endlevel]
                    [/event]
                [/then]
                [else]
                    [message]
                        speaker=narrator
                        image=portraits/bresda-heroine.png
                        caption=Bresda
                        message=_"The Khthon have won.  I hope you idiots are happy..."
                    [/message]
                    [message]
                        speaker=Haldrad
                        message=_"It's not as bad as that.  You'll see."
                    [/message]
                    [store_unit]
                        [filter]
                            id=Ponce
                        [/filter]
                        variable=ponce
                        kill=no
                    [/store_unit]
                    [store_unit]
                        [filter]
                            id=Dardrus
                        [/filter]
                        variable=dardrus
                        kill=no
                    [/store_unit]
                    [endlevel]
                        {CONTINUE}
                        next_scenario=Epilog_Khthon
                    [/endlevel]
                [/else]
            [/if]
        [/event]
        [event]
            name=moveto
            [filter]
                id=Kerrnyn
                side=1 # because this won't make sense if he is already on side 3
                [filter_adjacent]
                    side=2,3,6
                [/filter_adjacent]
            [/filter]
            [message]
                speaker=Kerrnyn
                message=_"Ah, this is no good.  It is true that we were abondoned on that evil planet, but teaming up with the Khthon is not the answer.  I cannot raise my weapon against you."
            [/message]
            [message]
                speaker=second_unit
                message=_"At least someone is able to see reason.  Welcome back, Kerrnyn."
            [/message]
            {MODIFY_UNIT (id=Kerrnyn) side 3}
        [/event]
        [event]
            name=die
            [filter]
                id=Dardrus
            [/filter]
            [message]
                speaker=Haldrad
                message=_"That wasn't good.  I was kind of hoping he could help us with any Primeval stragglers we came across..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
        [event]
            name=die
            [filter]
                id=Ponce
            [/filter]
            [message]
                speaker=Haldrad
                message=_"That wasn't good.  We needed him to deal peacefully with the remaining sailors, after this battle is over..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
[/scenario]
