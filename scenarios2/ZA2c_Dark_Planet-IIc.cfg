#textdomain wesnoth-Trinity

# recall Mechanics
# 1.  Keldan's list is cleared of level 1 elves, otherwise that's all that would be recalled
# 2.  Khthon are put on a second list

# to do
# 1.  main chamber events
#	a.  Change time-of-day to red, as facility is on fire
#	b.  Mechanical Dragon hangar bay
#	c.  escape/victory event
# 2.  unstore khthon events (partially done)
# 3.  artwork? 	a. new Khthon prisoner
#		b. big Mech_Dragon (just a dormant image, not a unit)

[scenario]
    id="Dark_Planet_2c"
    name= _ "Second Chances"
    map_data="{~add-ons/Trinity/maps/Dark_Planet_Lower_Keldan.map}"
    next_scenario=Dark_Planet_3
    victory_when_enemies_defeated=no
    turns=-1
    #	{TURNS 8 10 12}

    [music]
        name="legends_of_the_north.ogg"
    [/music]

    {BMR_STORE_SIDE 5}
    {BMR_RESTORE_SIDE 5}
    {UNDERGROUND}
    [time_area]
        x=0-13,0-11,0-9,0-7,0-5,0-3,0-1
        y=0-1,2,3,4,5,6,7
        {TRINITY_DP_SCHEDULE}
        id=Tri_DP2C_end
    [/time_area]
    [story]
        [part]
            story= _ "Keldan woke to intense pain.  The pain came in waves, and in the lulls, he could register a bright light, a strange whining noise, and the smell of burning flesh.  He knew the burning flesh was his own."
            background="story/dungeon.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Escape from the Mechanical Fortress."
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Keldan"
            [/objective]
            note= "Rescue as many Khthon as you can, cause as much damage to the Mechanical side as you can, and take advantage of the enthrallment ability when you can."
        [/objectives]
        [unit]
            type=Tri_Mech_Android
            id=Android1
            side=1
            x,y=58,7
        [/unit]
        [unit]
            type=Tri_Blue_Novice
            side=1
            x,y=63,3
        [/unit]
        [unit]
            type=Tri_Blue_Machinist
            side=1
            x,y=62,1
            id=Machinist_1
        [/unit]
#ifdef EASY
        [unit]
            type=Tri_Blue_Novice
            side=1
            ai_special=guardian
            x,y=72,12
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            side=1
            ai_special=guardian
            x,y=71,13
        [/unit]
#endif
#ifdef NORMAL
        [unit]
            type=Tri_Blue_Mage
            side=1
            ai_special=guardian
            x,y=72,12
        [/unit]
        [unit]
            type=Tri_Mech_Android
            side=1
            ai_special=guardian
            x,y=71,13
        [/unit]
#endif
#ifdef HARD
        [unit]
            type=Tri_Blue_Mage
            experience=28
            side=1
            ai_special=guardian
            x,y=72,12
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            side=1
            ai_special=guardian
            x,y=71,13
        [/unit]
#endif
        [unit]
            type=Tri_Mech_Drone
            side=1
            x,y=57,17
            ai_special=guardian
        [/unit]
        [item]
            image=items/bookshelf-less-full.png~FL(horiz)
            x,y=48,27
        [/item]
        [item]
            image=items/bookshelf-less-full.png~FL(horiz)
            x,y=65,30
        [/item]
        [item]
            image=items/bones.png
            x,y=47,2
        [/item]
        [item]
            image=items/box.png
            x,y=61,30
        [/item]
        [item]
            image=items/box.png
            x,y=59,30
        [/item]
        [item]
            image=misc/metal-box.png
            x,y=13,21
        [/item]
        [item]
            image=misc/metal-box.png
            x,y=39,1
        [/item]
        [item]
            image=misc/metal-box.png
            x,y=40,1
        [/item]
        [item]
            image=scenery/trash.png
            x,y=53,3
        [/item]
        {OBJ_POTION_STRONG 37 31 pot1}
        {OBJ_POTION_STRONG 72 23 pot2}
        ##################################################
        # This is to deal with Khthon recall list
        ##################################################
        {FOREACH keldan_khthon_list ix}
            # restore movement, etc.
            [set_variable]
                name=keldan_khthon_list[$ix].moves
                value=$keldan_khthon_list[$ix].max_moves
            [/set_variable]
            [set_variable]
                name=keldan_khthon_list[$ix].attacks_left
                value=1
            [/set_variable]
            [set_variable]
                name=keldan_khthon_list[$ix].hitpoints
                value=$keldan_khthon_list[$ix].max_hitpoints
            [/set_variable]
            # remove the cannon fodder from the list.  Could have been avoided if I'd stored the units better in earlier scenario
            [if]
                [not]
                    [variable]
                        name=keldan_khthon_list[$ix].race
                        equals=khthon
                    [/variable]
                [/not]
                [and]
                    [variable]
                        name=keldan_khthon_list[$ix].type
                        equals="Elvish Fighter"
                    [/variable]
                    [or]
                        [variable]
                            name=keldan_khthon_list[$ix].type
                            equals="Elvish Archer"
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=keldan_khthon_list[$ix].type
                            equals="Elvish Shaman"
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=keldan_khthon_list[$ix].type
                            equals="Elvish Scout"
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=keldan_khthon_list[$ix].type
                            equals="Ruffian"
                        [/variable]
                    [/or]
                [/and]
                [then]
                    {CLEAR_VARIABLE keldan_khthon_list[$ix]}
                    [set_variable]
                        name=ix
                        add=-1
                    [/set_variable]
                [/then]
            [/if]
            # put the Khthon, as opposed to Thralls, on a different list
            [if]
                [variable]
                    name=keldan_khthon_list[$ix].race
                    equals=khthon
                [/variable]
                [then]
                    [set_variables]
                        name=keldan_khthon_list2
                        mode=append
                        to_variable=keldan_khthon_list[$ix]
                    [/set_variables]
                    {CLEAR_VARIABLE keldan_khthon_list[$ix]}
                    [set_variable]
                        name=ix
                        add=-1
                    [/set_variable]
                [/then]
            [/if]
        {NEXT ix}
        # filling out the veterans list, if it was needed
        [while]
            [variable]
                name=keldan_khthon_list.length
                less_than=10
            [/variable]
            [do]
                [set_variable]
                    name=rk_type_TEMP
                    rand="Elvish Hero,Spearman,Spearman,Mage,Swordsman,White Mage,Bowman,Elvish Hero,Elvish Ranger,Elvish Marksman,Elvish Druid,Elvish Sorceress"
                [/set_variable]
                [unit]
                    side=5
                    type=$rk_type_TEMP
                    x,y=55,14
                [/unit]
                {ARCHAIC_KHTHONIZED (x,y=55,14)}
                [store_unit]
                    [filter]
                        x,y=55,14
                    [/filter]
                    mode=append
                    variable=keldan_khthon_list
                    kill=yes
                [/store_unit]
                {CLEAR_VARIABLE rk_type_TEMP}
            [/do]
        [/while]
        # making sure there are enough Khthon too
        [while]
            [variable]
                name=keldan_khthon_list2.length
                less_than=8
            [/variable]
            [do]
                [set_variable]
                    name=rk_type_TEMP
                    rand="Elvish Fighter,Elvish Hero,Spearman,Mage,Swordsman,White Mage,Elvish Shaman,Elvish Druid,Yak,Ophis,Tauricorn,Timber Wolf,Prokyon,Snapper"
                [/set_variable]
                [unit]
                    side=5
                    type=$rk_type_TEMP
                    x,y=55,14
                [/unit]
                {ARCHAIC_KHTHONIZE_MAJOR (
                    [not]
                        race=khthon
                    [/not]
                    x,y=55,14
                )}
                [store_unit]
                    [filter]
                        x,y=55,14
                    [/filter]
                    mode=append
                    variable=keldan_khthon_list2
                    kill=yes
                [/store_unit]
                {CLEAR_VARIABLE rk_type_TEMP}
            [/do]
        [/while]
        [unstore_unit]
            variable=keldan_khthon_list2[0]
            x,y=73,1
            find_vacant=yes
        [/unstore_unit]
        {CLEAR_VARIABLE keldan_khthon_list2[0]}
        {VARIABLE ix 0}
        [unstore_unit]
            variable=keldan_khthon_list[0]
            find_vacant=yes
            x,y=68,1
        [/unstore_unit]
        {CLEAR_VARIABLE keldan_khthon_list[0]}
        [unstore_unit]
            variable=keldan_khthon_list[0]
            find_vacant=yes
            x,y=69,6
        [/unstore_unit]
        {CLEAR_VARIABLE keldan_khthon_list[0]}
        [unstore_unit]
            variable=keldan_khthon_list[0]
            find_vacant=yes
            x,y=71,6
        [/unstore_unit]
        {CLEAR_VARIABLE keldan_khthon_list[0]}
        # don't clear the index (ix) or the array yet
        #        {CLEAR_VARIABLE keldan_khthon_list}
        #	{TRANSFORM_UNIT id=Keldan Keldan_Cyborg} # this screws things up in ways I don't understand... using an object instead (I just won't deal with new sprite for now)
        [store_unit]
            [filter]
                canrecruit=yes
                side=2
            [/filter]
            variable=side_2_leader
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                canrecruit=yes
                side=3
            [/filter]
            variable=side_3_leader
            kill=yes
        [/store_unit]
    [/event]

    # first blue people enemy
    [side]
        type=Tri_Blue_Engineer
        id=Soneric
        name= _ "Soneric"
        canrecruit=yes
        side=1
        recruit="Tri_Mech_Scout,Tri_Mech_Manbot,Tri_Mech_Cyborg"
        controller=ai
        fog=no
        team_name=Enemy
        {GOLD 24 32 44}
        {INCOME 4 6 8}
        #	[unit]
        #            type=Tri_Mech_Cyborg
        #	    x,y=recall,recall
        #	[/unit]
        #	[unit]
        #            type=Tri_Mech_Cyborg
        #	    x,y=recall,recall
        #	[/unit]
        #	[unit]
        #            type=Tri_Mech_Seeker
        #	    x,y=recall,recall
        #	[/unit]
        [ai]
            [leader_goal]
                x,y=63,24
                id=0
            [/leader_goal]
            # AI has stopped recruiting...  does this help? nope.  Try removing recall list - yes, that did it
            # this is causing errors
            #            recruitment_ignore_bad_combat=yes
            # FLAG this does not work - reducing the starting gold further
            # #ifdef __UNUSED__
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Tri_Mech_Cyborg
                            max=4
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
            # #endif
        [/ai]
    [/side]

    # mechanical enemy
    [side]
        type=Tri_Mech_Android_Leader
        id=AL776
        name= _ "AL-776"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit="Tri_Mech_Scout,Tri_Mech_Drone,Tri_Mech_Cyborg,Tri_Mech_Seeker"
        team_name=Enemy
        {GOLD 170 230 280}
        {INCOME 4 6 8}
        [ai]
#ifdef __UNUSED__
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Tri_Mech_Android
                            max=2
                        [/limit]
                        [limit]
                            type=Tri_Mech_Tank
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
#endif
            [goal]
                name=target_location
                [criteria]
                    x=50,69
                    y=21,31
                [/criteria]
                value=6
            [/goal]
        [/ai]
    [/side]

    # second blue people enemy
    [side]
        type=Tri_Azure_Mage
        id=Braydon
        name= _ "Braydon"
        side=3
        canrecruit=yes
        controller=ai
        fog=no
        shroud=yes
        recruit="Tri_Blue_Novice,AR_Green_Man,Tri_Mech_Drone,Tri_Mech_Cyborg,Tri_Mech_Manbot"
        #        recruit="Tri_Blue_Novice,AR_Green_Man,Tri_Mech_Drone,Tri_Mech_Cyborg,Tri_Mech_Cyborg_Captain,Blue_Lizard,Blue_Drake,Tri_Blue_Mage,Tri_Mech_Defender"
        {GOLD 180 240 280}
        {INCOME 4 6 8}
        team_name=Enemy
        [ai]
#ifdef __UNUSED__
            [aspect]
                id=recruitment
                [facet]
                    [value]
                        name=ai_default::recruitment
                        [limit]
                            type=Tri_Mech_Defender
                            max=1
                        [/limit]
                        [limit]
                            type=Tri_Blue_Mage
                            max=1
                        [/limit]
                        [limit]
                            type=Blue_Drake
                            max=1
                        [/limit]
                        [limit]
                            type=Tri_Mech_Cyborg_Captain
                            max=1
                        [/limit]
                    [/value]
                [/facet]
            [/aspect]
#endif
        [/ai]
    [/side]

    # not sure
    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        team_name=Other
        hidden=yes
#ifdef __UNUSED__
        [ai]
            [goal]
                name=target_location
                [criteria]
                    x=50,69
                    y=21,31
                [/criteria]
                value=6
            [/goal]
        [/ai]
#endif
    [/side]

    # player - I don't think there is a recall list?
    [side]
        type=Keldan_Cyborg
        id=Keldan
        name= _ "Keldan"
        side=5
        canrecruit=yes
        controller=human
        fog=no
        shroud=yes
        recruit=""
        {GOLD 250 200 180}
        {INCOME 8 6 4}
        team_name=Khthon
    [/side]

    # non-chronological events
    #   {ARCHAIC_KHTHON_RECRUITS (side=5)}
    # the bugs an be turned to Cyborgs, it looks weird.
    # removing the race=thrall part
    # changed assimilation, maybe it is OK now.  letting them become thralls again.

    [event]
        name=prerecruit
        first_time_only=no
        [filter]
            side=5
        [/filter]
        {ARCHAIC_KHTHONIZED (x,y=$x1,$y1)}
        #        {MODIFY_UNIT (x,y=$x1,$y1) race tri_outlander}
    [/event]

    # teleports
    [event]
        name=prestart
        [tunnel]
            id=tunnel1
            [source]
                x,y=49,24
            [/source]
            [target]
                x,y=69,31
            [/target]
            [filter]
            [/filter]
        [/tunnel]
        [tunnel]
            id=tunnel2
            [source]
                x,y=39,30
            [/source]
            [target]
                x,y=50,21
            [/target]
            [filter]
            [/filter]
        [/tunnel]
        [tunnel]
            id=tunnel3
            [source]
                x,y=34,29
            [/source]
            [target]
                x,y=45,22
            [/target]
            [filter]
            [/filter]
        [/tunnel]
    [/event]
    [event]
        name=fooby
        #        name=moveto
        first_time_only=no
        [filter]
            x=69
            y=31
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=49,24
        [/teleport]
    [/event]
    [event] # this event was screwing up the event where AI goals are updated, is this new to 1.14?
        name=fooby
        #        name=moveto
        first_time_only=no
        [filter]
            x=49
            y=24
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=69,31
        [/teleport]
    [/event]
    [event]
        #        name=moveto
        name=fooby
        first_time_only=no
        [filter]
            x=50
            y=21
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=39,30
        [/teleport]
    [/event]
    [event]
        name=fooby
        #        name=moveto
        first_time_only=no
        [filter]
            x=39
            y=30
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=50,21
        [/teleport]
    [/event]

    # chronological (and moveto) events
    [event]
        name=start
        [object]
            id=obj_keldan_cyborg
            silent=yes
            [filter]
                id=Keldan
            [/filter]
            [effect]
                apply_to=type
                name=Keldan_Cyborg
            [/effect]
        [/object]
        [store_unit]
            [filter]
                id=Keldan
            [/filter]
            variable=K_TEMP
            kill=no
        [/store_unit]
        [set_variable]
            name=K_TEMP.attacks_left
            value=1
        [/set_variable]
        [unstore_unit]
            variable=K_TEMP
            find_vacant=no
        [/unstore_unit]
        {QUAKE "rumble.ogg"}
        {FADE_STEP -32 5}
        {FADE_STEP -64 5}
        {FADE_STEP -96 5}
        {FADE_STEP -128 5}
        {FADE_STEP -160 5}
        {QUAKE "rumble.ogg"}
        {FADE_STEP -128 5}
        {FADE_STEP -96 5}
        {FADE_STEP -64 5}
        {FADE_STEP -32 5}
        {FADE_STEP 0 5}
        {MODIFY_UNIT (id=Machinist_1) facing sw}
        {MODIFY_UNIT (id=Soneric) facing sw}
        [message]
            speaker=Soneric
            message= _ "What was that?  Can't be good..."
        [/message]
        {MODIFY_UNIT (id=Keldan) facing se}
        [delay]
            time=300
        [/delay]
        {MODIFY_UNIT (id=Keldan) facing sW}
        [delay]
            time=300
        [/delay]
        {MODIFY_UNIT (id=Keldan) facing se}
        [delay]
            time=100
        [/delay]
        {MODIFY_UNIT (id=Keldan) facing sw}
        [delay]
            time=100
        [/delay]
        {MODIFY_UNIT (id=Keldan) facing se}
        [message]
            speaker=Keldan
            message= _ "Where am I?"
        [/message]
        [message]
            speaker=Machinist_1
            message= _ "The subject awoke!  That wasn't supposed to happen, was it?"
        [/message]
        [message]
            speaker=narrator
            message=_"<i>Core control offline!  All hands to core!  Critical event imminent!</i>"
            image=portraits/speaker.png
        [/message]
        [message]
            speaker=Soneric
            message= _ "No..."
        [/message]
        {MOVE_UNIT (id=Soneric) 62 4}
        {MODIFY_UNIT (id=Soneric) facing sw}
        [terrain]
            x,y=61,5
            terrain=Fyp
        [/terrain]
        [redraw]
            side=5
        [/redraw]
        {MOVE_UNIT (id=Soneric) 59 8}
        {MODIFY_UNIT (id=Keldan) facing ne}
        [message]
            speaker=Keldan
            message= _ "Who are you?"
        [/message]
        [message]
            speaker=Machinist_1
            message= _ "None of you are supposed to be awake, let me just-"
        [/message]
        [message]
            speaker=Keldan
            message= _ "No!  Keep your hands off!"
        [/message]
        {MOVE_UNIT (x,y=73,1) 70 2}
        [message]
            speaker=Keldan
            message= _ "At least I'm not alone.  Come, let us get out of this holding tank!"
        [/message]
        {MOVE_UNIT (id=Machinist_1) 61 4}
        [message]
            speaker=Machinist_1
            message= _ "No, I can't let you do that!  Guard, we must keep these monsters contained!"
        [/message]
        {MOVE_UNIT (id=Android1) 62 4}
        [message]
            speaker=Machinist_1
            message= _ "Lock down all doors, don't let anyone unauthorized through."
        [/message]
        [terrain]
            x,y=61,5
            terrain=Fyp^Gsyw
        [/terrain]
        [redraw]
            side=5
        [/redraw]
    [/event]

    # to introduce the player to the concept
    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist,Tri_Blue_Engineer
            x=61-62
            y=4
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Identity Confirmed.  You may proceed."
        [/message]
        [terrain]
            terrain=Fyp
            x,y=61,5
        [/terrain]
        [redraw]
            side=5
        [/redraw]
        [message]
            speaker=Keldan
            message= _ "Hrmm...  I couldn't have opened that door.  If thralls that were masters of this metal dungeon can still open the doors, that will be useful..."
        [/message]
    [/event]

    [event]
        name=turn 2
        [unit]
            side=1
            x,y=71,13
            type=Tri_Blue_Mage
        [/unit]
        [unit]
            side=3
            type=AR_Green_Soldier
            ai_special=guardian
            facing=se
            x,y=61,31
        [/unit]
        [message]
            speaker=Keldan
            message= _ "What have they done to me..."
        [/message]
    [/event]
    # do we need to adjust this for difficulty?
    [event]
        name=turn 8
        [unit]
            side=1
            x,y=70,22
            type=Tri_Mech_Android
            ai_special=guardian
        [/unit]
    [/event]

    [event]
        name=turn 12
        [unit]
            side=3
            x,y=1,5
            type=Tri_Azure_Mage
        [/unit]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            x=35-43,27,28
            y=2-6,20,19
        [/filter]
        [allow_undo][/allow_undo]
        [unstore_unit]
            variable=side_3_leader
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE side_3_leader}
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            x,y=63,30-32
        [/filter]
        [allow_undo][/allow_undo]
        [unstore_unit]
            variable=side_2_leader
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE side_2_leader}
        [unit]
            type=Tri_Mech_Android
            side=2
            x,y=36,3
        [/unit]
        [unit]
            type=Tri_Mech_Android
            side=2
            x,y=36,1
        [/unit]
        [unit]
            type=Tri_Mech_Android
            side=2
            x,y=38,1
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            side=2
            x,y=38,6
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            side=2
            x,y=39,2
        [/unit]
        [unit]
            type=Tri_Mech_Tank
            side=2
            x,y=34,2
        [/unit]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            x,y=50,24-25
        [/filter]
        [allow_undo][/allow_undo]
        [unit]
            type=AR_Green_Soldier
            side=3
            x,y=64,31
        [/unit]
        [unit]
            type=AR_Green_Man
            side=3
            x,y=66,32
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            side=3
            x,y=65,31
        [/unit]
    [/event]

    # still getting a bottleneck at transport pads, with AI popping in/out in very silly fashion.  We need to fix this...
    [event]
        name=moveto
        [filter]
            id=Soneric
            x,y=63,24
        [/filter]
        [event]
            #	    name=side 1 turn end
            name=enter_hex
            [filter]
                id=Keldan
                # when it was y=20, Keldan could catch him before he ran.  Is this high up enough?
                y=18
            [/filter]
            [allow_undo]
            [/allow_undo]
            # did that fix the bottle-neck?
            [unit]
                side=1
                type=Tri_Mech_Cyborg
                x,y=65,25
            [/unit]
            [unit]
                side=1
                type=Tri_Mech_Cyborg
                x,y=57,23
            [/unit]
            [unit]
                side=1
                type=Tri_Mech_Scout
                x,y=54,23
            [/unit]
            [terrain]
                terrain=Ctym
                x,y=63,24
            [/terrain]
            [modify_ai]
                side=1
                action=delete
                path=aspect[leader_goal].facet[*]
            [/modify_ai]
            [modify_ai]
                side=1
                action=add
                path=aspect[leader_goal].facet[]
                [facet]
                    id=goto2
                    [value]
                        x,y=49,24
                    [/value]
                [/facet]
            [/modify_ai]
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Soneric
            x,y=49,24
        [/filter]
        [unit]
            side=1
            type=Tri_Mech_Cyborg
            x,y=58,31
        [/unit]
        [modify_ai]
            side=1
            action=delete
            path=aspect[leader_goal].facet[*]
        [/modify_ai]
        [modify_ai]
            side=1
            action=add
            path=aspect[leader_goal].facet[]
            [facet]
                id=goto2
                [value]
                    x,y=39,30
                [/value]
            [/facet]
        [/modify_ai]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Soneric
            x,y=39,30
        [/filter]
        [modify_ai]
            side=1
            action=delete
            path=aspect[leader_goal].facet[*]
        [/modify_ai]
        [modify_ai]
            side=1
            action=add
            path=aspect[leader_goal].facet[]
            [facet]
                id=goto2
                [value]
                    x,y=46,16
                [/value]
            [/facet]
        [/modify_ai]
    [/event]

    [event] # this may lead to a build-up, adding an AI goal
        # something is wrong, he doesn't recruit
        name=moveto
        [filter]
            id=Soneric
            x,y=46,16
        [/filter]
        #	[set_recruit]
        #	    side=1
        #	[/set_recruit]
        [modify_ai]
            side=1
            action=add
            path=goal
            [goal]
                name=target_location
                value=5
                [criteria]
                    x,y=50,21
                [/criteria]
            [/goal]
        [/modify_ai]
    [/event]

    [event] # if I give him too much gold at the start, it create bottlenecks.  This will force him to save something until the player is approaching him.
        name=exit_hex
        [allow_undo][/allow_undo]
        [filter]
            x,y=50,21
            side=5
        [/filter]
        [gold]
            side=1
            amount=70
        [/gold]
    [/event]

    [event]
        name=attack
        [filter]
            id=Keldan
        [/filter]
        [filter_second]
            id=Soneric
        [/filter_second]
        {MODIFY_UNIT (id=Soneric) canrecruit no}
        [message]
            speaker=Soneric
            message=_"Stop!  What I did to you was wrong, I know that now.  Please, I was only following orders!"
        [/message]
        [message]
            speaker=Keldan
            message=_"I have no sympathy for you..."
        [/message]
        [message]
            speaker=Keldan
            message=_"<i>(I should enthrall that piece of filth...  His high rank will probably open steel doors that my current crew cannot.)</i>"
        [/message]
    [/event]

    [event] # I'm not sure how this interacts with the enthrall event (which is last_breath, so I think it should be OK?)
        name=die
        [filter]
            id=Soneric
        [/filter]
        [if]
            [variable]
                name=unit.race
                equals=thrall_khthon
            [/variable]
            # I suppose it is possible to get him killed before he opens the doors, hopefully Keldan's hint is enough to alert the player not to let that happen.
            [else]
                [message]
                    speaker=Keldan
                    message= _ "No!  It would have been really helpful to have one of those high-ranking cretins under my thumb.  But that opportunity is gone, I suspect I am trapped here!  Fate damn this all!"
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=enter_hex
        [filter]
            id=Keldan
            x,y=44,30-32
        [/filter]
        [allow_undo][/allow_undo]
        [message]
            speaker=Keldan
            message=_"Something tore a hole in the wall..."
        [/message]
        [unit]
            side=4
            type=Lunar Ripper
            x,y=30,31
            id=Lunar_Queen
        [/unit]
        [unit]
            side=4
            type=Lunar Bug
            x,y=32,32
        [/unit]
        [unit]
            side=4
            type=Lunar Bug
            x,y=33,30
        [/unit]
        [event]
            name=new turn
            first_time_only=no
            id=goo_spawn
            [if]
                [have_unit]
                    side=4
                    count=1-3
                [/have_unit]
                [then]
                    [unit]
                        side=4
                        type=Lunar Bug
                        x,y=33,30
                    [/unit]
                [/then]
            [/if]
        [/event]
        [event] # die event would be more logical, but we have to be sure this fires
            name=attacker_hits
            [filter]
                race=khthon
            [/filter]
            [filter_second]
                id=Lunar_Queen
            [/filter_second]
            [event]
                id=goo_spawn
                remove=yes
            [/event]
            [message]
                speaker=Keldan
                message=_"I can't summon my usual forces, but these little bugs are numerous and susceptable to my influence..."
            [/message]
            [message]
                speaker=narrator
                message=_"Keldan can now recruit some local vermin as thralls"
            [/message]
            # might need to adjust this...
            [set_recruit]
                side=5
                recruit="Lunar Bug,Lunar Mantis,Lunar Stinkbug"
                #                recruit="Lunar Bug,Lunar Goo,Lunar Slime,Lunar Eye,Lunar Mantis,Lunar Stinkbug"
            [/set_recruit]
        [/event]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            x,y=58,31-32
        [/filter]
        [allow_undo][/allow_undo]
        [unit]
            side=3
            type=Tri_Blue_Mage
            x,y=50,28
            id=Mage1
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Cyborg_Captain
            x,y=51,30
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Cyborg
            x,y=52,29
        [/unit]
        [event]
            name=attacker_hits
            [filter_second]
                id=Mage1
            [/filter_second]
            [message]
                speaker=narrator
                message=_"When the mage got hit, he accidentally dropped a key-ring onto the ground.  The keys most likely are for the two nearby metal gates."
            [/message]
            [event]
                name=moveto
                [filter]
                    side=5
                    x=46,48
                    y=20,19
                [/filter]
                [terrain]
                    terrain=Rr^Pr\o
                    x,y=47,20
                [/terrain]
                [redraw]
                    side=5
                [/redraw]
            [/event]
            [event]
                name=moveto
                [filter]
                    side=5
                    x=71,72
                    y=13,12
                [/filter]
                [terrain]
                    terrain=Rrc^Pr/o
                    x,y=71,12
                [/terrain]
                [unstore_unit]
                    variable=keldan_khthon_list2[0]
                    x,y=69,11
                [/unstore_unit]
                {CLEAR_VARIABLE keldan_khthon_list2[0]}
                [redraw]
                    side=5
                [/redraw]
                [unit]
                    type=Tri_Mech_Drone
                    side=2
                    x,y=73,1
                [/unit]
                [unit]
                    type=Tri_Mech_Defender
                    side=2
                    x,y=73,2
                [/unit]
            [/event]
            [event]
                name=moveto
                [filter]
                    side=5
                    x,y=52,28
                [/filter]
                [terrain]
                    terrain=Rrc^Pr\o
                    x,y=53,28
                [/terrain]
                [unstore_unit]
                    variable=keldan_khthon_list2[0]
                    x,y=55,27
                [/unstore_unit]
                {CLEAR_VARIABLE keldan_khthon_list2[0]}
                [redraw]
                    side=5
                [/redraw]
            [/event]
            [event]
                name=moveto
                [filter]
                    side=5
                    x,y=47,28
                [/filter]
                [terrain]
                    terrain=Rrc^Pr/o
                    x,y=46,27
                [/terrain]
                [unstore_unit]
                    variable=keldan_khthon_list[0]
                    x,y=44,26
                [/unstore_unit]
                {CLEAR_VARIABLE keldan_khthon_list[0]}
                [redraw]
                    side=5
                [/redraw]
            [/event]
            [event]
                name=moveto
                [filter]
                    side=5
                    x=43,44
                    y=16,15
                [/filter]
                [terrain]
                    terrain=Rrc^Pr/o
                    x,y=43,15
                [/terrain]
                [unstore_unit]
                    variable=keldan_khthon_list2[0]
                    x,y=42,12
                [/unstore_unit]
                {CLEAR_VARIABLE keldan_khthon_list2[0]}
                [redraw]
                    side=5
                [/redraw]
            [/event]
        [/event]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist,Tri_Blue_Engineer
            x=46,47
            y=6,7
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Identity Confirmed.  You may proceed."
        [/message]
        [terrain]
            terrain=Fyp
            x,y=47,6
        [/terrain]
        [redraw]
            side=5
        [/redraw]
        [event]
            name=moveto
            [filter]
                side=5
                x,y=48-49,5
            [/filter]
            [terrain]
                terrain=Urb^Pr/o
                x,y=48,4
            [/terrain]
            [unstore_unit]
                variable=keldan_khthon_list2[0]
                x,y=47,2
            [/unstore_unit]
            {CLEAR_VARIABLE keldan_khthon_list2[0]}
            [redraw]
                side=5
            [/redraw]
        [/event]
        [event]
            name=moveto
            [filter]
                side=5
                x=50,51
                y=5,6
            [/filter]
            [terrain]
                terrain=Urb^Pr\o
                x,y=51,5
            [/terrain]
            [unstore_unit]
                variable=keldan_khthon_list[0]
                x,y=55,3
            [/unstore_unit]
            {CLEAR_VARIABLE keldan_khthon_list[0]}
            [unstore_unit]
                variable=keldan_khthon_list2[0]
                x,y=50,2
            [/unstore_unit]
            {CLEAR_VARIABLE keldan_khthon_list2[0]}
            [redraw]
                side=5
            [/redraw]
            [message]
                speaker=Keldan
                message=_"Come, let us leave this place."
            [/message]
        [/event]
    [/event]

    # finding the primevals who came here with Tanyche
    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist,Tri_Blue_Engineer
            x=26,27,28
            y=27,28,28
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Identity Confirmed.  You may proceed."
        [/message]
        [terrain]
            terrain=Fyp
            x=26,27
            y=28,29
        [/terrain]
        [redraw]
            side=5
        [/redraw]
        [event]
            name=moveto
            [filter]
                side=5
                x=22,23
                y=30,31
            [/filter]
            [terrain]
                terrain=Urb^Pr\o
                x,y=22,31
            [/terrain]
            [unit]
                side=4
                type=Primeval Striker
                x,y=18,32
                facing=ne
                id=Striker1
                hitpoints=27
                experience=11
            [/unit]
            [unit]
                side=4
                type=Primeval Dogface
                x,y=20,33
                facing=ne
                id=Dogface1
                hitpoints=32
                experience=16
            [/unit]
            [redraw]
                side=5
            [/redraw]
            [if]
                [variable]
                    name=unit.type
                    contains="Tri_Blue"
                [/variable]
                [then]
                    [message]
                        speaker=Dogface1
                        message=_"Look who it is..."
                    [/message]
                    [message]
                        speaker=Striker1
                        message=_"You've made a mistake opening that gate, little man!"
                    [/message]
                    {MOVE_UNIT (id=Dogface1) 21 32}
                    [message]
                        speaker=Dogface1
                        message=_"You're tin-men won't save you now!"
                    [/message]
                    {MOVE_UNIT (id=Striker1) 22 32}
                    [message]
                        speaker=Striker1
                        message=_"Revenge is ours!"
                    [/message]
                    [message]
                        speaker=Keldan
                        message=_"No, halt!  He's with me!"
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Striker1
                        message=_"Who are you?"
                    [/message]
                    [message]
                        speaker=Dogface1
                        message=_"(Don't you see the eyes?  It's one of <i>them!</i>)"
                    [/message]
                [/else]
            [/if]
            [message]
                speaker=Keldan
                message=_"We are prisoners here, just like you seem to be...  I should probably kill you in your cell, red-eyed daemons, but we both need all the help we can get down here.  How many of you are there?"
            [/message]
            [message]
                speaker=Dogface1
                message=_"Why should we even entertain the idea of sullying our honour by embracing your vile-"
            [/message]
            [message]
                speaker=Striker1
                message=_"(Wait!  He's been tortured just like Palaphane and Kurkorus ...)  How did you survive the strange perversion of the machinists?"
            [/message]
            [message]
                speaker=Keldan
                message=_"I don't know, something woke me when they were not expecting it...  How many of you are there?"
            [/message]
            [message]
                speaker=Striker1
                message=_"There were eight of us.  Hellius and Tanyche should be somewhere on the surface.  Dredia and Pollonus were killed during our capture.  Palaphane and Kurkorus were taken next door for demented experiments-"
            [/message]
            [message]
                speaker=Dogface1
                message=_"We believe Palaphane is dead, we no longer hear her screams.  But Kurkorus should still be on his feet if we act quickly."
            [/message]
            [message]
                speaker=Keldan
                message=_"(I no longer know who I am, a Khthon would never help a Primeval...  But...)  Very well, let's go rescue Mr. Kurkorus."
            [/message]
            {MODIFY_UNIT (id=Dogface1) side 5}
            {MODIFY_UNIT (id=Striker1) side 5}
        [/event]
        # if player tries to open steel door first
        [event]
            name=moveto
            id=lab_access_denied
            [filter]
                side=5
                x=21,22
                y=30,29
            [/filter]
            [filter_condition]
                [not]
                    [have_unit]
                        id=Striker1
                    [/have_unit]
                [/not]
            [/filter_condition]
            [message]
                speaker=narrator
                image=portraits/speaker.png
                message=_"Testing in Progress, Access denied."
            [/message]
        [/event]
        [event]
            name=moveto
            [filter]
                side=5
                x=21,22
                y=30,29
            [/filter]
            [filter_condition]
                [have_unit]
                    id=Striker1
                [/have_unit]
            [/filter_condition]
            [message]
                speaker=narrator
                image=portraits/speaker.png
                message=_"Testing in Progress, Access denied."
            [/message]
            [message]
                speaker=Dogface1
                message=_"Like hell it is!"
            [/message]
            [if]
                [have_unit]
                    x,y=22,29
                    [not]
                        id=Dogface1
                    [/not]
                [/have_unit]
                [then]
                    {MOVE_UNIT (x,y=22,29) 27 30}
                [/then]
            [/if]
            {MOVE_UNIT (id=Dogface1) 22 29}
            [message]
                speaker=Keldan
                message=_"You're going to smash down that door?"
            [/message]
            [message]
                speaker=Dogface1
                message=_"Of course not!  If I could do that, why would I have stayed in my cell?  We found that there is often a wire in the door-frame... which causes the door to ... open... Ha!  There we go!"
            [/message]
            [message]
                speaker=Keldan
                message=_"... (?) ..."
            [/message]
            [message]
                speaker=narrator
                image=portraits/speaker.png
                message=_"Fault detected!  Intruders!  Alert!"
            [/message]
            [terrain]
                terrain=Fyp
                x,y=21,29
            [/terrain]
            [unit]
                side=5
                type=Primeval Driver
                id=Kurkorus
                name=Kurkorus
                x,y=16,28
                hitpoints=48
            [/unit]
            [object]
                id=pd_cyborg_obj
                silent=yes
                [filter]
                    id=Kurkorus
                [/filter]
                [effect]
                    apply_to=max_experience
                    increase=200
                [/effect]
                [effect]
                    apply_to=resistance
                    [resistance]
                        blade=70
                        pierce=70
                        impact=70
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=movement
                    set=4
                [/effect]
                [effect]
                    apply_to=profile
                    small_portrait="portraits/driver.png~BLIT(portraits/pd_cyborg.png,0,0)~CROP(60,30,330,330)~SCALE(205,205)"
                    portrait="portraits/driver.png~BLIT(portraits/pd_cyborg.png,0,0)"
                [/effect]
            [/object]
            [unit]
                side=3
                type=Tri_Blue_Engineer
                x,y=15,29
                facing=ne
                id=Engineer3
            [/unit]
            [unit]
                side=3
                type=Tri_Blue_Machinist
                x,y=17,29
                facing=nw
            [/unit]
            [unit]
                side=3
                type=Tri_Mech_Defender
                x,y=16,29
                facing=ne
            [/unit]
            [redraw]
                side=5
            [/redraw]
            [message]
                speaker=Engineer3
                message=_"Go away!  We need to do this, I'd think your type would understand."
            [/message]
            [message]
                speaker=Keldan
                message=_"There is no understanding any of this..."
            [/message]
            [message]
                speaker=Kurkorus
                message=_"Kill me..."
            [/message]
            [message]
                speaker=Striker1
                message=_"That's no way to talk, Kurkorus!  We're here to free you!"
            [/message]
            [event]
                name=last_breath
                [filter]
                    id=Kurkorus
                [/filter]
                [message]
                    speaker=Kurkorus
                    message=_"I have failed, but at least the pain stops..."
                [/message]
                [message]
                    speaker=Dogface1
                    message=_"Rest in peace, Kurkorus."
                [/message]
                [message]
                    speaker=Striker1
                    message=_"The bastard pilot will pay for this..."
                [/message]
            [/event]
        [/event]
    [/event]

    ##########################################################
    # to make sure the player has to visit the primeval prisoners first
    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist,Tri_Blue_Engineer
            x=31-32,33
            y=4,5
        [/filter]
        [filter_condition]
            [have_unit]
                side=5
                race=primeval
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Security Overide - Identity Confirmed.  You may proceed.  Intruders detected, proceed with caution."
        [/message]
        [terrain]
            terrain=Fyp
            x,y=31,5
        [/terrain]
        [redraw]
            side=5
        [/redraw]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist,Tri_Blue_Engineer
            x=31-32,33
            y=4,5
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    side=5
                    race=primeval
                [/have_unit]
            [/not]
        [/filter_condition]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Insufficient clearance.  Directors only.  Access denied."
        [/message]
    [/event]
    ############################################

    [event]
        name=enter_hex
        id=shortcut_door
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist
            x=35-36
            y=22
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Insufficient clearance.  Engineers only.  Access denied."
        [/message]
    [/event]
    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Engineer
            x=35-36
            y=22
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Identity Confirmed.  You may proceed."
        [/message]
        [terrain]
            terrain=Fyp
            x=34,35
            y=22,23
        [/terrain]
        [redraw]
            side=5
        [/redraw]
        [event]
            id=shortcut_door
            remove=yes
        [/event]
    [/event]

    [event]
        name=enter_hex
        id=shortcut_door2
        [filter]
            side=5
            type=Tri_Blue_Mage,Tri_Blue_Novice,Tri_Blue_Machinist
            x=27,28,29
            y=21,20,20
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Insufficient clearance.  Engineers only.  Access denied."
        [/message]
    [/event]
    [event]
        name=enter_hex
        [filter]
            side=5
            type=Tri_Blue_Engineer
            x=27,28,29
            y=21,20,20
        [/filter]
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Identity Confirmed.  You may proceed."
        [/message]
        [terrain]
            terrain=Fyp
            x=27,28
            y=2220,19
        [/terrain]
        [unit]
            side=3
            type=Tri_Mech_Defender
            x,y=26,23
            facing=ne
        [/unit]
        [redraw]
            side=5
        [/redraw]
        [event]
            id=shortcut_door2
            remove=yes
        [/event]
    [/event]

    # main chamber events

    [event]
        name=enter_hex
        [filter]
            side=5
            x=26,27,28,29,30,31,32
            y=19,19,18,5,5,6,6
        [/filter]
        [set_variable]
            name=MD_remaining
            value=2
        [/set_variable]
        [unit]
            side=2
            # not really ready for prime-time
            #	    type=Tri_Mech_Arty_Gun_a
            type=Tri_Mech_Tank
            x,y=18,8
        [/unit]
        [unit]
            side=2
            # not really ready for prime-time
            #	    type=Tri_Mech_Arty_Gun_a
            type=Tri_Mech_Tank
            x,y=20,17
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Tank
            ai_special=guardian
            x,y=17,4
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Tank
            ai_special=guardian
            x,y=14,13
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Tank
            ai_special=guardian
            x,y=20,12
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Tank
            ai_special=guardian
            x,y=28,7
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Engineer
            ai_special=guardian
            x,y=5,8
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Drone
            ai_special=guardian
            facing=sw
            x,y=6,8
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Machinist
            ai_special=guardian
            x,y=5,10
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Engineer
            ai_special=guardian
            facing=sw
            x,y=13,8
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Machinist
            ai_special=guardian
            facing=ne
            x,y=11,9
        [/unit]
        [unit]
            side=3
            type=Tri_Mech_Drone
            ai_special=guardian
            facing=ne
            x,y=12,9
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Engineer
            id=Engineer2
            ai_special=guardian
            facing=sw
            x,y=5,16
        [/unit]
        [unit]
            side=3
            type=Tri_Blue_Machinist
            ai_special=guardian
            facing=ne
            x,y=12,18
        [/unit]
        [unit]
            side=3
            type=AR_Green_Soldier
            ai_special=guardian
            facing=se
            x,y=17,7
        [/unit]
        [unit]
            side=3
            type=AR_Green_Soldier
            ai_special=guardian
            facing=se
            x,y=11,6
        [/unit]
        [unit]
            side=3
            type=AR_Green_Tank
            ai_special=guardian
            facing=se
            x,y=13,5
        [/unit]
        [remove_shroud]
            side=5
            x,y=1-28,1-29
        [/remove_shroud]
        [redraw]
            side=5
        [/redraw]
        [message]
            speaker=Keldan
            message=_"I've never seen such a large structure...  Actually, it's like a cave, one whole wall is open to the outside desert."
        [/message]
        [scroll_to]
            x,y=5,8
        [/scroll_to]
        [delay]
            time=200
        [/delay]
        [scroll_to]
            x,y=12,8
        [/scroll_to]
        [delay]
            time=200
        [/delay]
        [message]
            speaker=Keldan
            message=_"It also looks like Tristien's people are up to no good.  I must-"
        [/message]
        {QUAKE "rumble.ogg"}
        # verify that this does not remove the [time_area] in the NW corner
        {FLASH_RED (
            [replace_schedule]
                [time]
                    id=tri_mech_fire
                    name=_"Fire"
                    image="misc/time-schedules/schedule-underground.png~CS(60,-50,-80)"
                    lawful_bonus=-10
                    red=10
                    green=-90
                    blue=-120
                [/time]
            [/replace_schedule]
            [music]
                name=frantic.ogg
                append=no
                immediate=yes
            [/music]
        )}
        [message]
            speaker=narrator
            image=portraits/speaker.png
            message=_"Alert!  Engineers to Core!  Alert!  Engineers to Core!"
        [/message]
        {QUAKE "rumble.ogg"}
        [message]
            speaker=Engineer2
            message=_"Hurry people, we need to get these things on the road!"
        [/message]
        [message]
            speaker=Keldan
            message=_"We cannot allow those mechanical monsters to be resurrected.  I hope my enthralled mechanics know how to destroy them..."
        [/message]
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Escape from the Mechanical Fortress."
            [/objective]
            [objective]
                condition=win
                description=_ "Destroy the Mechanical Dragons"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Keldan"
            [/objective]
            note= "Move either a Machinist or Engineer thrall to the dormant mechanical dragons to sabotage the war machines before they can be brought online.  The largest of the three machines must be detroyed before Keldan can leave.
(Note: this scenario is a work in progress - it is possible to win however)"
        [/objectives]
        [terrain]
            x,y=46-47,7-14
            terrain=Fypd^Foyg
            layer=overlay
        [/terrain]
    [/event]

    # spreading smoke, that damages units standing in it, then spreads to adjacent hexes
    [event]
        name=new turn
        first_time_only=no
        [terrain]
            terrain=Fypd^Foyg
            layer=overlay
            [and]
                terrain=Fyp,Fypd,Rrc,Urb
            [/and]
            [not]
                terrain=*^Foyg
            [/not]
            [filter_adjacent_location]
                terrain=*^Foyg
            [/filter_adjacent_location]
        [/terrain]
        [redraw]
            side=5
        [/redraw]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                [not]
                    race=tri_mech
                [/not]
                [not]
                    race=mechanical
                [/not]
                [filter_location]
                    terrain=*^Foyg
                [/filter_location]
            [/filter]
            variable=fogged_TEMP
            kill=no
        [/store_unit]
        {FOREACH fogged_TEMP ifog}
            [if]
                [variable]
                    name=fogged_TEMP[$ifog].variables.smoked
                    equals=yes
                [/variable]
                [then]
                    [set_variable]
                        name=fogged_TEMP[$ifog].status.slowed
                        value=yes
                    [/set_variable]
                [/then]
                [else]
                    [set_variable]
                        name=fogged_TEMP[$ifog].variables.smoked
                        value=yes
                    [/set_variable]
                [/else]
            [/if]
            [set_variable]
                name=fogged_TEMP[$ifog].hitpoints
                add=-8
            [/set_variable]
            [unstore_unit]
                variable=fogged_TEMP[$ifog]
                find_vacant=no
                text="-8"
                {COLOR_HARM}
            [/unstore_unit]
        {NEXT ifog}
        {CLEAR_VARIABLE fogged_TEMP}
        # the ones not inside the smoke are set back to normal
        [store_unit]
            [filter]
                side=$side_number
                [filter_location]
                    [not]
                        terrain=*^Foyg
                    [/not]
                [/filter_location]
                [filter_wml]
                    [variables]
                        smoked=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=unfogged_TEMP
            kill=no
        [/store_unit]
        {FOREACH unfogged_TEMP ifog}
            [set_variable]
                name=unfogged_TEMP[$ifog].variables.smoked
                value=no
            [/set_variable]
            [unstore_unit]
                variable=unfogged_TEMP[$ifog]
                find_vacant=no
            [/unstore_unit]
        {NEXT ifog}
        {CLEAR_VARIABLE unfogged_TEMP}
    [/event]

    # move a machinist, engineer, or space-alien adjacent to a mechanical dragon, he blows it up (and dies)
    # only two to destroy for now.  Eventually, I will change it so that there is a third mega-dragon that must be destroyed
    # but for now, only two optional regular ones.  Victory is to reach NW corner.
#define TRI_MECH_DESTROYERS
Tri_Blue_Machinist,Tri_Blue_Engineer,AR_Green_Man,AR_Green_Soldier,AR_Green_Tank,AR_Green_Delta#enddef

    [event]
        name=moveto
        [filter]
            side=5
            type={TRI_MECH_DESTROYERS}
            x=4,5,6
            y=8-9,8-10,8-9
        [/filter]
        [message]
            speaker=Keldan
            message=_"Destroy that machine beyond all repair!"
        [/message]
        [message]
            speaker=unit
            message=_"Yes..."
        [/message]
        [delay]
            time=800
        [/delay]
        {FLASH_RED (
            [terrain]
                x,y=5,9
                terrain=Uu^Crby
            [/terrain]
            {QUAKE "rumble.ogg"}
            [kill]
                x=4,5,6
                y=8-9,8-10,8-9
            [/kill]
            [redraw]
                side=5
            [/redraw]
        )}
        [set_variable]
            name=MD_remaining
            add=-1
        [/set_variable]
    [/event]

    [event]
        name=moveto
        [filter]
            side=5
            type={TRI_MECH_DESTROYERS}
            x=11,12,13
            y=8-9,7-9,8-9
        [/filter]
        [message]
            speaker=Keldan
            message=_"Destroy that machine beyond all repair!"
        [/message]
        [message]
            speaker=unit
            message=_"Yes..."
        [/message]
        [delay]
            time=800
        [/delay]
        {FLASH_RED (
            [terrain]
                x,y=12,8
                terrain=Uu^Crby
            [/terrain]
            {QUAKE "rumble.ogg"}
            [kill]
                x=11,12,13
                y=8-9,7-9,8-9
            [/kill]
            [redraw]
                side=5
            [/redraw]
        )}
        [set_variable]
            name=MD_remaining
            add=-1
        [/set_variable]
    [/event]

    [event]
        name=moveto
        [filter]
            side=5
            type={TRI_MECH_DESTROYERS}
            x=9,10,11
            y=12-13,11-13,12-13
        [/filter]
        [message]
            speaker=Keldan
            message=_"Destroy that machine beyond all repair!  We'll never be able to fight that behemoth if they get it into operation."
        [/message]
        [message]
            speaker=unit
            message=_"Yes..."
        [/message]
        [delay]
            time=800
        [/delay]
        {FLASH_RED (
            [terrain]
                x,y=10,12
                terrain=Uu^Crby
            [/terrain]
            {QUAKE "rumble.ogg"}
            [kill]
                x=9,10,11
                y=12-13,11-13,12-13
            [/kill]
            [redraw]
                side=5
            [/redraw]
        )}
        [set_variable]
            name=k_can_win
            value=yes
        [/set_variable]
    [/event]
    ###################################

    [event]
        name=moveto
        [filter]
            id=Keldan
            x,y=1-9,1-5
#            location_id=Tri_DP2C_end # this causes event to get triggered at very strange times.
        [/filter]
        [filter_condition]
            [variable]
                name=k_can_win
                equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=Keldan
            message= _ "And I'm free!  Now, we need to get our bearings, then circle back and see what we can do to completely destroy this infernal place!"
        [/message]
        [endlevel]
            result=victory
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Keldan
        [/filter]
        [message]
            speaker=unit
            message= _ "Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]
