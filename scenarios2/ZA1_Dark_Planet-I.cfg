#textdomain wesnoth-Trinity

[scenario]
    id="Dark_Planet"
    name= _ "Dark Planet"
    map_data="{~add-ons/Trinity/maps/Dark_Planet2.map}"
    next_scenario=Dark_Planet_2
    victory_when_enemies_defeated=no
    turns=-1
    #	{TURNS 8 10 12}

    [music]
        name="New_Wesnoth_Battle_Music.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    {BMR_STORE_SIDE 3}
    {BMR_RESTORE_SIDE 1}
    #    {BMR_RESTORE_SIDE 2}
    {BMR_RESTORE_SIDE 3}
    {BMR_RESTORE_SIDE 5}
    {TRINITY_DP_SCHEDULE}
    [story]
#ifdef __UNUSED__
        [part]
            story= _ "Queen Caldera directed the party through the icy caverns, and into a hall made of metal and marble.  As the queen drew their attention to a complicated-looking metal and glass altar, Ponce noticed some damage to the structures, as well as some splashes of blood.  Blood that was still wet...

He followed a trail of this blood to an alcove full of metal contraptions.  They reminded him of something he once saw in a sawmill.  Then he spied something that was a dead-ringer for the crest Haldrad wore on his chest - the others would want to know about this!"
            [background_layer]
                image="story/Trinity_altar.jpg"
            [/background_layer]
        [/part]
        [part]
            story= _ "Ponce barely had time to rejoin the party at the altar before a minor quake shook the mountain.  Queen Caldera explained that she was lifting the Sky Mountain up into the night sky, beyond the night sky, to the home of the enemy."
            [background_layer]
                image="story/Trinity_space.jpg"
            [/background_layer]
        [/part]
        [part]
            story= _ "'The enemy is from a land so distant, it is amongst the stars,' explained Caldera.  'It moved from star to star, conquering and devouring all who it encountered.  But then it came to our lands, and our ancestors were able to repulse its attack.'

Haldrad knew that it was not his mother speaking, but rather the thing possessing her, be it daemon or angel.  As he and his officers stared slack-jawed at the strange, stary visions revealed on the glass wall, Queen Caldera continued her story."
            [background_layer]
                image="story/Trinity_space2.jpg"
            [/background_layer]
        [/part]
        [part]
            story= _ "'Though the enemy was unsuccessful, it was not really defeated, and it has been lurking in our shadow, biding its time.'  Caldera motioned toward the image of the dark moon that was gradually engulfing the entire panel of glass.  'Now it tries to devour us once more, and it is up to us to finish the work that our ancestors were forced to start so many years ago.'"

            [background_layer]
                image="story/Trinity_space3.jpg"
            [/background_layer]
        [/part]
#endif
        [part]
            story= _ "The image of a dark moon filled the entire glass panel, and details of the surface were becoming evident.  It was mostly a dark and grey desert-scape, barren of anything resembling life.  But then Haldrad saw there was a small collection of structures, in various states of ruin, and it was towards these that the Sky Mountain was headed.  Queen Caldera made some quick movements over the altar, then stepped away and crouched against the wall.  'You will want to brace yourself against a stable surface, we are about to land.'"
            [background_layer]
                image="story/Trinity_DP1.jpg"
            [/background_layer]
        [/part]
        #        [part]
        #            story= _ "These last scenarios are under construction and are unfinished.  It should be possible to win this next one though."
        #            [background_layer]
        #                image="story/Trinity_warning.jpg"
        #            [/background_layer]
        #        [/part]
    [/story]

#define SETH_MESSAGE MESSAGE
    [message]
        speaker=narrator
        image=portraits/seth.png~O(0.5)
        caption=Seth
        message= _ {MESSAGE}
    [/message]
#enddef

    # #define BRANCH_PRIMEVAL
    #    [filter_condition]
    #        [variable]
    #            name=branch
    #            equals=primeval
    #        [/variable]
    #    [/filter_condition]
    # #enddef

    # #define BRANCH_KHTHON
    #    [filter_condition]
    #        [variable]
    #            name=branch
    #            equals=khthon
    #        [/variable]
    #    [/filter_condition]
    #  #enddef

    ######################################################
    # map switching related WML
    # not needed for this scenario
    #    {~add-ons/Trinity/scenarios2/ZB_Dark_Planet-switching.cfg}

    ###################################################

    ###############################################
    # Sides - not all of these sides are relevant for this scenario, but they will be later
    ###############################################
    # Haldrad
    [side]
        type=Spearman
        id=Fooby
        name= _ "Haldrad"
        side=1
        canrecruit=yes
        controller=human
        fog=no
        shroud=yes
        scroll_to_leader=no
        recruit="Spearman,Bowman,Peasant,Ruffian,Heavy Infantryman"
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 10 7 4}
        {GOLD 390 270 160}
        team_name=Human
        [village]
            x,y=64,57
        [/village]
    [/side]

    # phantoms, lower
    [side]
        type=Seth
        id=Seth
        name= _ "Seth"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit="Tomb Dancer,Tomb Huntress,Tomb Guard,Tomb Shade,Tower Dancer,Tower Servant,Skeleton"
        {INCOME 7 10 14}
        {GOLD 350 450 550}
        team_name=Phantom
        #        {ai/aliases/stable_singleplayer.cfg}
        #        [ai]
        #            {MODIFY_AI_ADD_CANDIDATE_ACTION 2 main_loop (
        #                [candidate_action]
        #                    id=push_to_destination
        #                    engine=fai
        #                    name=push_to_destination
        #                    type=movement
        #                    evaluation="if(me.id='Mech_Seth',{AI_CA_COMBAT_SCORE}+10,0)"
        #                    action="move(me.loc,choose(unit_moves(me.loc),'mloc',-sum(map(simplest_path(mloc,loc(67,62),me.loc),'path_location', movement_cost( me, path_location ) ))) )"
        #                [/candidate_action]
        #            )}
        #        [/ai]
    [/side]

    # Bresda & Dardrus
    [side]
        type=Spearman
        id=Fooby
        name= _ "Dardrus"
        side=3
        canrecruit=yes
        controller=human
        recall_cost=10
        fog=no
        shroud=yes
        recruit=""
        {INCOME 10 7 4}
        {GOLD 360 250 150}
        team_name=Primeval
    [/side]

    # Mechs, lower
    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
    [/side]

    # Keldan
    [side]
        type=Spearman
        id=Fooby
        name= _ "Keldan"
        side=5
        canrecruit=yes
        controller=human
        fog=no
        shroud=yes
        recruit="Elvish Fighter,Elvish Archer, Elvish Shaman, Elvish Scout"
        recall_cost=10
        {INCOME 10 7 4}
        #        {GOLD 360 290 190}
        # trying out less gold so the AI won't ruin everything in the beginning
        {GOLD 180 120 190}
        team_name=Phantom
        # because I think the recall list balancing may be all screwed up at this point:
        # let's reconsider
#ifdef __UNUSED__
        [unit]
            type=Yak
            x,y=recall,recall
        [/unit]
        [unit]
            type=Orthrus
            x,y=recall,recall
        [/unit]
        [unit]
            type=Noble_Beast
            x,y=recall,recall
        [/unit]
        [unit]
            type=Ophis
            x,y=recall,recall
        [/unit]
        [unit]
            type=Yak
            experience=15
            x,y=recall,recall
        [/unit]
        [unit]
            type=Ram
            experience=12
            x,y=recall,recall
        [/unit]
        [unit]
            type=Timber Wolf
            experience=14
            x,y=recall,recall
        [/unit]
#endif
        [village]
            x,y=23,27
        [/village]
        [village]
            x,y=25,32
        [/village]
    [/side]

    # Mechs, upper
    [side]
        no_leader=yes
        side=6
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
        [ai]
            aggression=0.8
        [/ai]
        [unit]
            type=Tri_Mech_Mine
            id=Minder
            name="M 742"
            x,y=25,28
            # adding these because the mine is qiven QUICK trait, even though that is not what is in the unit file or what shows in :inspect
            [modifications]
                {TRAIT_MECHANICAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
    [/side]

    # phantoms, upper
    [side]
        type=Mummy Pharo
        id=Imambyses
        name= "Imambyses"
        side=7
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit=""
        extra_recruit="Tomb Guard,Tomb Dancer,Tomb Mummy,Spirit Dove,Tomb Huntress"
        {INCOME 10 15 20}
        {GOLD 350 450 550}
        team_name=Phantom
        [unit]
            type=Mummy King
            id=Aramhotep
            name="Aramhotep"
            canrecruit=yes
            x,y=33,29
            extra_recruit="Tomb Shade"
        [/unit]
        [village]
            x,y=35,27
        [/village]
        [village]
            x,y=33,32
        [/village]
    [/side]

#ifdef __UNUSED__
    [event]
        name=select
        first_time_only=no
        [filter]
            type=Tri_Cyan_Cyborg,Tri_Cyan_Cyborg_Flyer
        [/filter]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            kill=no
            variable=temp_animtest
        [/store_unit]
        [set_variable]
            name=temp_animtest.experience
            value=200
        [/set_variable]
        [unstore_unit]
            variable=temp_animtest
            find_vacant=no
            advance=yes
        [/unstore_unit]
        {CLEAR_VARIABLE temp_animtest}
    [/event]
#endif

    ##########################################################
    # teleport pads, to cut down on the slogging across the map
    # in an event below, but I leave these because I think it helps with usability.
    ##########################################################
    # west
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,62
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,62
        [/teleport]
    [/event]
    # east
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=64,50
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=36,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=36,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=64,50
        [/teleport]
    [/event]
    #######################################

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Find and Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Caldera"
            [/objective]
            note= _"These last scenarios are under construction.  This one should work, as should the next, but feedback is appreciated."
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Find and Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
        [objectives]
            side=5
            [objective]
                condition=win
                description=_ "Find and Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Keldan"
            [/objective]
        [/objectives]
        [recall]
            id=E_Caldera
        [/recall]
        [recall]
            id=Ponce
        [/recall]
        [recall]
            id=Lyron
        [/recall]
        {MODIFY_UNIT (side=3
        [not]
            canrecruit=yes
        [/not]) facing se}
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=34,21
        [/item]
        [item]
            halo=units/gun-a-s.png
            x,y=40,23
        [/item]
        [item]
            halo=units/gun-a-s.png
            x,y=19,24
        [/item]
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=52,34
        [/item]
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=62,22
        [/item]
        [store_unit]
            [filter]
                id=Seth
            [/filter]
            variable=seth
            kill=yes
        [/store_unit]
        # I don't think I need these anymore
#ifdef __UNUSED__
        [set_variable]
            name=leaders_of_side1
            value="Haldrad,E_Caldera"
        [/set_variable]
        [set_variable]
            name=leaders_of_side3
            value="Dardrus,Bresda"
        [/set_variable]
        [set_variable]
            name=leaders_of_side5
            value="Keldan"
        [/set_variable]
        [set_variable]
            name=tri_on_surface
            value=yes
        [/set_variable]
        [set_variable]
            name=player_side
            value=1,3
        [/set_variable]
#endif
        [remove_shroud]
            side=1,3,5
            x,y=1-68,1-68
        [/remove_shroud]
        # sw structure
        [place_shroud]
            side=1,3,5
            x=3-13,4-11,5-12
            y=60-66,59,67
        [/place_shroud]
        # big structure
        [place_shroud]
            side=1,3,5
            x=19-35,40-47,48-53,54-56,13-18
            y=1-11,8-20,15-23,18-22,11-18
        [/place_shroud]
        # this is development stuff that should be removed when possible - these things should have been taken care of in earlier scenarios
        ###############
        #        [clear_menu_item]
        #            id=tri_tower_go_inside
        #        [/clear_menu_item]
        #        [clear_menu_item]
        #            id=tri_tower_go_outside
        #        [/clear_menu_item]
        {CLEAR_VARIABLE e_rat}
        {CLEAR_VARIABLE caldera}
        {CLEAR_VARIABLE leader_s2}
        {CLEAR_VARIABLE leader_s4}
        {CLEAR_VARIABLE leader_s6}
        {CLEAR_VARIABLE leader_s7}
        {CLEAR_VARIABLE dardrus}
        {CLEAR_VARIABLE bresda}
        ############
        # make the initial shroud data for underground cover all - I don't think this is needed any longer
        #   [store_locations]
        #   variable=shroud_locs_lower
        #   x,y=1-68,1-68
        #   [/store_locations]
        #    [micro_ai]
        #        side=8
        #        ai_type=forest_animals
        #        action=add
        #        deer_type=Lunar Bug,Lunar Mantis,Lunar Worm,Lunar Crab
        #        [filter_location]
        #            terrain=Dsmz
        #        [/filter_location]
        #    [/micro_ai]
        #   {CAPTURE_VILLAGES 1 27 54 1}
        #   [item]
        #   image=items/chest.png
        #   x,y=29,53
        #   [/item]
    [/event]

    {ARCHAIC_KHTHON_RECRUITS (
        side=5
        [not]
            race=khthon
        [/not]
    )}

    # save the khthon for later
    [event]
        name=die
        first_time_only=no
        [filter]
            side=5
            canrecruit=no
        [/filter]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            mode=append
            variable=keldan_khthon_list
        [/store_unit]
    [/event]

    [event]
        name=recall
        [filter]
            side=5
        [/filter]
        [filter_condition]
            [have_unit]
                side=5
                count=3
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=Keldan
            message=_"That is enough for now, let us not sacrifice ourselves as that monsters front line..."
        [/message]
        [message]
            speaker=Minder
            message="<i>"+_"(Analyzing...)"+"</i>"
        [/message]
        [end_turn]
        [/end_turn]
        [event]
            name=side 5 turn
            first_time_only=no
            id=idle_5_ai
            [filter_condition]
                [have_unit]
                    side=5
                    count=3,4,5,6
                [/have_unit]
            [/filter_condition]
            [end_turn]
            [/end_turn]
        [/event]
    [/event]

    [event]
        name=recall
        [filter]
            side=1
            race=orc
        [/filter]
        [message]
            speaker=unit
            message=_"Haha!  I must be the first orc to set foot on this new land!  ...  Hmmm ...  It's a cursed land - I think I like my homeland better, despite all the ices."
        [/message]
    [/event]

    [event]
        name=recall
        [filter]
            side=1
            race=dwarf
        [/filter]
        [message]
            speaker=unit
            message=_"It may be one small step for a man, orc, or elf, but it's one giant step for dwarf kin!  Ah...  Hrmh...  This place is dark and rocky like a cave, but it is drier and more open...  I don't like it."
        [/message]
    [/event]

    [event]
        # testing
        #        name=side 3 turn 2
        name=side 3 turn
        [filter_condition]
            [have_unit]
                id=Mech_D
            [/have_unit]
        [/filter_condition]
        [unstore_unit]
            variable=dardrus
        [/unstore_unit]
        [unstore_unit]
            variable=bresda
        [/unstore_unit]
        {CLEAR_VARIABLE dardrus}
        {CLEAR_VARIABLE bresda}
        [music]
            name=legends_of_the_north.ogg
            immediate=yes
            append=yes
        [/music]
        [item]
            image=scenery/summoning-center.png
            x,y=8,64
        [/item]
        [remove_shroud]
            side=1,3,5
            x,y=2-14,57-68
        [/remove_shroud]
        [recall]
            side=3
        [/recall]
        [unit]
            side=3
            type=Primeval Swiftfoot
            id=Tanyche
            name=Tanyche
            profile=portraits/tanyche.png
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
            x,y=5,67
            facing=ne
        [/unit]
        [redraw]
            side=3
        [/redraw]
        [message]
            speaker=Bresda
            message=_"Where are we?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"I don't know, but I recognize some of the architecture.  This is territory of The Pantheon, or at least it once was."
        [/message]
        {MODIFY_UNIT (id=Bresda) facing se}
        [message]
            speaker=Bresda
            message=_"That's fascinating..."
        [/message]
        {MOVE_UNIT (id=Bresda) 12 66}
        {MODIFY_UNIT (id=Bresda) facing se}
        [message]
            speaker=Bresda
            message=_"How do we open these doors and get out?"
        [/message]
        # actually, you can bring in Tanyche here, instead of this
        #        [message]
        #            speaker=narrator
        #            image=portraits/seth.png~O(0.5)
        #            caption=Seth
        #            message= _ "Allow me..."
        #        [/message]
        [message]
            speaker=Tanyche
            message=_"You have come!  Let us be on our way!"
        [/message]
        {MOVE_UNIT (id=Tanyche) 13 66}
        [set_variable]
            name=gate1_open
            value=yes
        [/set_variable]
        [terrain]
            terrain=Urb
            x=13,14
            y=67,66
        [/terrain]
        [redraw][/redraw]
        [message]
            speaker=Dardrus
            message=_"Who are you?"
        [/message]
        [message]
            speaker=Tanyche
            message=_"Why, I am the scout to guide you, the vanguard of our revenge against the pilot!"
        [/message]
        [message]
            speaker=Bresda
            message=_"(Dardrus, what is she talking about?)"
        [/message]
        [message]
            speaker=Dardrus
            message=_"(I have no idea...)"
        [/message]
        [message]
            speaker=Tanyche
            message=_"What are you waiting for?  You <i>are</i> our vanguard, are you not?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Yes, of course we are!  Now, let us find and destroy this ... pilot."
        [/message]
        [message]
            speaker=Tanyche
            message=_"We'll need to get to the lower level of the main structure to the north."
        [/message]
    [/event]

    [event]
        name=enter_hex
        [filter]
            id=Tanyche
            x=20
        [/filter]
        [message]
            speaker=Tanyche
            message=_"Those wooden patches will transport you somewhere distant, if you stand on it and stop moving.  This one will take us to the main structure."
        [/message]
        [message]
            speaker=Dardrus
            message=_"Yes, we have recently seen such things."
        [/message]
        [tunnel]
            id=tunnel_west
            bidirectional=yes
            [source]
                x,y=22,62
            [/source]
            [target]
                x,y=22,15
            [/target]
            [filter]
            [/filter]
        [/tunnel]
        [tunnel]
            id=tunnel_east
            bidirectional=yes
            [source]
                x,y=64,50
            [/source]
            [target]
                x,y=36,15
            [/target]
            [filter]
            [/filter]
        [/tunnel]
    [/event]

    [event]
        name=side 1 turn
        [filter_condition]
            [have_unit]
                id=Dardrus
            [/have_unit]
        [/filter_condition]
        [unit]
            side=7
            type=Tomb Stalker
            x,y=16,61
        [/unit]
        [unit]
            side=7
            type=Tomb Stalker
            x,y=15,61
        [/unit]
        [unit]
            side=7
            type=Tomb Stalker
            x,y=17,61
        [/unit]
        [unit]
            side=7
            type=Tomb Stalker
            x,y=27,68
        [/unit]
        [message]
            speaker=E_Caldera
            message=_"So, my red-eyed enemies are here...  <i>Keldan, we will soon be trapped between a hammer and an anvil, if we don't act now...</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"<i>Yes, Echidna.  What do you wish me to do?</i>"
        [/message]
        [message]
            speaker=E_Caldera
            message=_"<i>Create a distraction, just like when we destroyed the human capital.</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"<i>Yes, Echidna, as you command...</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"So, Red-eyed daemon!  You have joined our little adventure!  No doubt you have come to the aid of your evil master!  Prince, we must destroy these newcomers!"
        [/message]
        [kill]
            id=E_Caldera
        [/kill]
        [message]
            speaker=Bresda
            message=_"(What is <i>he</i> doing here?)"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Prince Haldrad!  Don't be fooled, we are not enemies!  It is the green-eyed ones such as him that are not to be trusted."
        [/message]
        [message]
            speaker=Haldrad
            message=_"It has been a while, Dardrus, and you did leave me in prison.  But should I trust you any less than these evil elves?"
        [/message]
        [message]
            speaker=Ponce
            message=_"Speaking of 'trust', where did the Queen go?"
        [/message]
        [unit]
            side=5
            type=AR_Owl
            x,y=66,64
            facing=nw
        [/unit]
        [unit]
            side=5
            type=AR_Owl
            x,y=68,64
            facing=nw
        [/unit]
        [unit]
            side=5
            type=AR_LittleThing
            x,y=67,63
            facing=nw
        [/unit]
        [unit]
            side=5
            type=Weasadillo
            x,y=67,64
            facing=nw
        [/unit]
        {ARCHAIC_KHTHONIZED (x=66,68,67,67
        y=64,64,63,64)}
        [music]
            name=In_the_Land_of_Madness.ogg
            append=no
            immediate=yes
        [/music]
        [terrain]
            terrain=Ke
            x,y=68,63
        [/terrain]
        [terrain]
            terrain=Ce
            x=68,68,67
            y=62,64,63-64
        [/terrain]
        [redraw]
            side=1
        [/redraw]
        [unit]
            side=5
            type=Echidna_Queen
            x,y=68,63
            id=Echidna
            name=Echidna
            facing=nw
            canrecruit=yes
        [/unit]
        [message]
            speaker=Echidna
            message=_"I'm right here!  I need this Sceptre, <i>my son</i>, you shall soon understand."
        [/message]
        [message]
            speaker=Haldrad
            message=_"So, I must now slay my own mother.  Fate can be cruel..."
        [/message]
        [message]
            speaker=narrator
            message=_"Some of the light seemed to go out of Echidna's eyes as she heard Haldrad's words.  Maybe it was because some fragment of Queen Caldera remained, maybe it was because Echidna saw herself as a mother, or maybe it was some other reason that would only make sense to the Khthon.  In any case, Echidna lost some of her haughty attitude."
        [/message]
        [message]
            speaker=Echidna
            message=_"Yes, yes it can.  But our fight is not with you, as long as you stay out of my way.  Keldan, leave the young king alone - the red-eyed daemon and the other puppets will be our targets as we burn down this circus.  When the time allows, I will <i>convince</i> my son to join us; it would be a remarkable step forward - a symbiosis!"
        [/message]
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "No, Echidna...  Such corruption as that can never be!  You shall join me..."
        [/message]
        {MODIFY_UNIT (id=Echidna) facing nw}
        [message]
            speaker=Echidna
            message=_"You've made a mistake in your little game, Seth!  You thought to lure me in, but you are getting weaker, while I've grown stronger!"
        [/message]
        [set_recruit]
            side=5
            recruit=""
        [/set_recruit]
        [set_extra_recruit]
            id=Keldan
            extra_recruit="Elvish Fighter,Elvish Archer, Elvish Shaman, Elvish Scout"
        [/set_extra_recruit]
        [set_extra_recruit]
            id=Echidna
            extra_recruit="Spearman,Bowman,Horse,Peasant,Ruffian"
        [/set_extra_recruit]
        [gold]
            side=5
            amount=320
        [/gold]
        [modify_side]
            side=1
            controller=human
            team_name=Primeval
        [/modify_side]
        [modify_side]
            side=3
            controller=human
            team_name=Primeval
        [/modify_side]
        [modify_side]
            side=5
            controller=ai
            team_name=Khthon
        [/modify_side]
        # the team switching was a bad design.  This is an attempt to blunt the 'tomatoe surprise-ness'
        ################################################################
        [modify_ai]
            side=5
            action=add
            path=aspect[attacks].facet[]
            [facet]
                id=attacks_not_one
                invalidate_on_gamestate_change=yes
                [filter_enemy]
                    [not]
                        side=1
                    [/not]
                [/filter_enemy]
            [/facet]
        [/modify_ai]

        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Defeat Khthon Leaders and regain the Sceptre"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lyron"
            [/objective]
            note=_"The Khthon will not attack side 1 for a few turns, unless side 1 attacks them."
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Defeat Khthon Leaders and regain the Sceptre"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
        [music]
            name=New_Wesnoth_Battle_Music.ogg
            append=no
            immediate=no
        [/music]
        [music]
            name=siege_of_laurelmor.ogg
            append=yes
            immediate=no
        [/music]
        [set_variable]
            name=k_stall
            value=3
        [/set_variable]
        [event]
            name=side 5 turn
            first_time_only=no
            [set_variable]
                name=k_stall
                add=-1
            [/set_variable]
            [if]
                [variable]
                    name=k_stall
                    equals=1
                [/variable]
                [then]
                    [message]
                        speaker=Keldan
                        message=_"(The humans are using Echidna's truce to position themselves...  Why does she allow it?)"
                    [/message]
                [/then]
            [/if]
            [if]
                [variable]
                    name=k_stall
                    equals=0
                [/variable]
                [then]
                    [message]
                        speaker=Echidna
                        message=_"King Haldrad, you are using my sentimentality against me, aren't you?  Moving into a position to strike.  Well, truce is off!  Keldan, kill them!  Save the young King for me!"
                    [/message]
                    [message]
                        speaker=Keldan
                        message=_"Yes, Echidna."
                    [/message]
                    [modify_ai]
                        side=5
                        action=delete
                        path=aspect[attacks].facet[attacks_not_one]
                    [/modify_ai]
                [/then]
            [/if]
        [/event]
    [/event]

    [event]
        name=attack_end
        [filter]
            side=1
        [/filter]
        [filter_second]
            side=5
        [/filter_second]
        [filter_condition]
            [have_unit]
                id=Echidna
            [/have_unit]
            [variable]
                name=k_stall
                greater_than=0
            [/variable]
        [/filter_condition]
        [message]
            speaker=Echidna
            message=_"I said to stay out of our way!  My sentimentality got the better of me, but the moment of weakness is over.  Kill them all!  Save the young King for me!"
        [/message]
        [message]
            speaker=Keldan
            message=_"Understood."
        [/message]
        [modify_ai]
            side=5
            action=delete
            path=aspect[attacks].facet[attacks_not_one]
        [/modify_ai]
        # make it less than zero
        [set_variable]
            name=k_stall
            add=-4
        [/set_variable]
    [/event]
    ###############################################

    [event]
        # this mimics a recruiting side, the spawning stops once there are a certain number of units on the map
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=spawn_side_6
                equals=yes
            [/variable]
        [/filter_condition]
        [set_variable]
            name=mech_type
            rand=Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Defender,Tri_Mech_Defender,Tri_Mech_Sentinel
        [/set_variable]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=49,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            type=$mech_type
            side=6
            x,y=50,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            side=6
            x,y=51,36
            facing=nw
        [/unit]
        {CLEAR_VARIABLE mech_type}
        [if]
            [have_unit]
                side=6
                count=9-99 # this can be changed, for difficulty levels and balancing
            [/have_unit]
            [then]
                {CLEAR_VARIABLE spawn_side_6}
            [/then]
        [/if]
    [/event]

    [event]
        # supposed to happen when on surface, and Khthon are defeated
        #       name=turn 2
        # # ifdef __UNUSED__
        name=new_turn
        [filter_condition]
            [and]
                [not]
                    [have_unit]
                        id=Echidna
                    [/have_unit]
                [/not]
            [/and]
            [and]
                [not]
                    [have_unit]
                        id=Keldan
                    [/have_unit]
                [/not]
            [/and]
        [/filter_condition]
        # # endif
        [unit]
            x,y=24,21
            id=Tristien
            type=Tri_Cyan_Cyborg
            name=Tristien
            side=6
            facing=se
        [/unit]
        [terrain]
            terrain=Qxu^Scoz
            x=50,49-51
            y=35,36
        [/terrain]
        [music]
            name=vengeful.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Tristien
            message=_"<i>Remember me?!</i>  I've been given a chance to show you how wrong you were to reject our master!"
        [/message]
        [store_unit]
            [filter]
                id=Tristien
            [/filter]
            kill=no
            variable=temp_animtest
        [/store_unit]
        [set_variable]
            name=temp_animtest.experience
            value=200
        [/set_variable]
        [unstore_unit]
            variable=temp_animtest
            find_vacant=no
            advance=yes
        [/unstore_unit]
        {CLEAR_VARIABLE temp_animtest}
        [remove_item]
            x,y=52,34
        [/remove_item]
        [remove_item]
            x,y=34,21
        [/remove_item]
        [remove_item]
            x,y=40,23
        [/remove_item]
        [remove_item]
            x,y=19,24
        [/remove_item]
        [remove_item]
            x,y=62,22
        [/remove_item]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun0
            side=6
            x,y=52,34
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun1
            side=6
            x,y=34,21
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun2
            side=6
            x,y=40,23
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun3
            side=6
            x,y=19,24
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun3
            side=6
            x,y=62,22
        [/unit]
        [message]
            speaker=Tristien
            message=_"My people could have crushed you like the primitive heathens you are, yet even we were nothing compared to Seth...  And now, well, enough talk!"
        [/message]

        [micro_ai]
            side=6
            ai_type=goto
            action=add
            ca_id=tris1
            [filter]
                id=Tristien
            [/filter]
            [filter_location]
                x,y=25,63
            [/filter_location]
        [/micro_ai]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=25,63
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=64,50
                [/filter_location]
            [/micro_ai]
        [/event]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=64,50
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=46,29
                [/filter_location]
            [/micro_ai]
        [/event]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=46,29
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=25,63
                [/filter_location]
            [/micro_ai]
        [/event]
    [/event]

    [event]
        name=start
        # because Keldan might be missing, bug in an earlier scenario
        [music]
            name="casualties_of_war.ogg"
            immediate=yes
            append=no
        [/music]
        [if]
            [have_unit]
                id=Keldan
            [/have_unit]
            [else]
                [unit]
                    side=5
                    type=Keldan
                    name=Keldan
                    id=Keldan
                    canrecruit=yes
                    x,y=25,29
                    experience=35
                [/unit]
            [/else]
        [/if]
        # recall/leaders for side 3 were also screwed up, this is a patch
        # the tower scenario needs to be fixed
        [recall]
            id=Bresda
        [/recall]
        [recall]
            id=Dardrus
        [/recall]
        {FOREACH leader_3 index}
            [if]
                [have_unit]
                    id=$leader_3[$index].id
                [/have_unit]
                [then]
                    #                   [message]
                    #                       id=$leader_3[$index].id
                    #                       message= _ "I had a clone!"
                    #                   [/message]
                    {CLEAR_VARIABLE leader_3[$index]}
                [/then]
                [else]
                    [unstore_unit]
                        variable=leader_3[$index]
                        x,y=7,63
                        find_vacant=yes
                    [/unstore_unit]
                    #            [message]
                    #                id=$leader_3[$index].id
                    #                message= _ "Unstored"
                    #            [/message]
                [/else]
            [/if]
        {NEXT index}
        {MODIFY_UNIT (canrecruit=yes
        side=3
        [not]
            id=Bresda,Dardrus
        [/not]) canrecruit no}
        {MODIFY_UNIT (id=Keldan) facing se}
        [message]
            speaker=Keldan
            message= _ "I see movement in that strange ice-mountain."
        [/message]
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "Those are the enemy.  I sense... We must lure them into my chambers.  For now, assist my Ancient Servants and put up a good fight, until I give the signal."
        [/message]
        [message]
            speaker=Keldan
            message= _ "As you wish."
        [/message]
        [modify_side]
            side=3
            controller=ai
        [/modify_side]
        [modify_side]
            side=5
            controller=ai
        [/modify_side]
        # there are two dardrus being created...
        # because he was a variable and on recall.  see above.
        [store_unit]
            [filter]
                id=Dardrus
            [/filter]
            variable=dardrus
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Bresda
            [/filter]
            variable=bresda
            kill=yes
            #                kill=no
        [/store_unit]
        {PUT_TO_RECALL_LIST (side=3)}
        [message]
            speaker=E_Caldera
            message= _ "There, we need to get into the larger building!"
        [/message]
        {MODIFY_UNIT (id=Haldrad) facing nw}
        [message]
            speaker=Haldrad
            message= _ "Hrm...  I see the Elves, or whatever used to be Elves, have beat us here!"
        [/message]
        {MODIFY_UNIT (id=E_Caldera) facing nw}
        [message]
            speaker=E_Caldera
            message= _ "Really!  I did not expect to see them here.  <i>(mutters: What in all the void is Keldan doing here?)</i> "
        [/message]
        {MODIFY_UNIT (id=Ponce) facing nw}
        [message]
            speaker=Ponce
            message= _ "Who did you expect to see?"
        [/message]
        [message]
            speaker=E_Caldera
            message= _ "Just more of those who fought us at the Tower Ruins.  We are clearly fighting forces the likes of which we have never seen, we should make useof every weapon we have!  Haldrad, my son, let me have the Sceptre, I- "
        [/message]
        [message]
            speaker=Haldrad
            message= _ "No!  Mother, we've gone over this several times already!  The Sceptre stays hidden and under my control until I know more about our situation."
        [/message]
        [message]
            speaker=Lyron
            message= _ "Should I put her in the brig, Your Excellency?"
        [/message]
        [message]
            speaker=E_Caldera
            message= _ "Why are you so eager to get me out of the way, <i>Advisor</i>?!"
        [/message]
        [message]
            speaker=Keldan
            message= _ "(They squabble amongst themselves...  Can they not be united even in this battle?  ... Seth will surely triumph.)"
        [/message]
    [/event]

    [event]
        name=recall
        [filter]
            side=1
        [/filter]
        [message]
            speaker=unit
            message=_"My Liege, we veterans and trainees have been talking, and we recognize there is nothing waiting for us if we fail.  We will fight as long as we have the resources and rations to do so."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Thank you, $unit.name|.  Let the forces know that their sacrifices shall not go unnoticed.  With such dedication in our forces, we shall prevail."
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Recalling and supporting units is not as expensive in this scenario as in standard scenarios."
        [/message]
    [/event]

    [event]
        name=turn 3
        {FOREACH skm_survivors index}
            [unstore_unit]
                variable=skm_survivors[$index]
                find_vacant=yes
                x,y=68,62
            [/unstore_unit]
        {NEXT index}
        {CLEAR_VARIABLE skm_survivors}
        # debugging stuff, this should be deleted when possible
        [if]
            [have_unit]
                id=Kerrnyn
            [/have_unit]
            [else]
                {KERRNYN_UNIT Kerrnyn 3 68 62}
                [+unit]
                    facing=nw
                    experience=29
                [/unit]
                #                [unit]
                #                    side=3
                #                    type=Kerrnyn
                #                    id=Kerrnyn
                #                    name=Kerrnyn
                #                    experience=29
                #                    x,y=68,62
                #                [/unit]
                [unit]
                    side=3
                    type=Tri_Bronze_Bird
                    experience=14
                    x,y=68,61
                [/unit]
            [/else]
        [/if]
        {MODIFY_UNIT (id=Kerrnyn) canrecruit no}
        {MODIFY_UNIT (id=Kerrnyn) facing nw}
        [modify_unit]
            [filter]
                id=Kerrnyn
            [/filter]
            {TRAIT_LOYAL}
        [/modify_unit]
        [unit_overlay]
            id=Kerrnyn
            image="misc/loyal-icon.png"
            #            overlays="misc/loyal-icon.png"
        [/unit_overlay]
        [message]
            speaker=Kerrnyn
            message=_"Who are you!?"
        [/message]
        {MODIFY_UNIT (id=Ponce) facing se}
        [message]
            speaker=Ponce
            message=_"No, who are you?"
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"I am a loyal servant to the winged Goddess of Vengeance!  If you are friends, I offer my allegience, but if you are her foes, I bring sharp steel!  Again, who are you?"
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"The disheveled fighter's gaze lingered on Queen Caldera for a moment, as if he recognized her, then he turned his eyes back to the one who had addressed him."
        [/message]
        [message]
            speaker=Ponce
            message=_"Winged goddess, huh?  If she is the one who-"
        [/message]
        [message]
            speaker=Haldrad
            message=_"Easy, Sir Ponce!  We have no quarrel with the Goddess of Vengeance, Stranger-"
        [/message]
        [message]
            speaker=Lyron
            message=_"Indeed, an enemy of the Goddess of Vengeance is an enemy of ours!"
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"Glad I am to hear that, this has been a very strange day...  Let us kill some green-eyed daemons!"
        [/message]
        #   {MODIFY_UNIT (id=Kerrnyn) side 1}
        {MODIFY_UNIT (x,y=66-68,60-64) side 1}
    [/event]

    [event]
        name=turn 5
        [message]
            speaker=Lyron
            message=_"So tell me, faithful servant of the Goddess, where were you hiding?  Why did we not see you, and are there any others?"
        [/message]
        [message]
            speaker=Ponce
            message=_"(I knew I should have pushed us to follow the blood-trails...)"
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"My name is Kerrnyn.  I was alone, save for my Goddess and her brass-winged agents.  I was tricked by a green-eyed daemon into the Ice Mountain, where it wanted to assassinate Her!  But we were too strong for the daemon, and Our Goddess crashed the mountain into the daemon's infernal tower.  After that, I don't remember so much...  But now we're here, so let's finish this and make Our Goddess proud!"
        [/message]
        [message]
            speaker=Lyron
            message=_"I see...  So there are no reinforcements coming?  Prince Haldrad, now you know where we stand..."
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"Well, there was some water stored in the back chambers, just follow the light-colored tiles..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Really!  Thank you-"
        [/message]
        [message]
            speaker=Lyron
            message=_"<i>Brother</i> Kerrnyn!  This is valuable information you give, and Our Goddess shall be proud of your efforts!"
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"I sense you mock me...  Do you really serve Our Goddess?"
        [/message]
        [message]
            speaker=Haldrad
            message=_"Kerrnyn, it is true, we are not of your faith...  But I have fought side-by-side with a man of your goddess's stock, I considered him my friend.  Believe me when I say we are united in purpose to destroy the green-eyed daemons!"
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"I see...  It is all I could hope for, I'm sure my Goddess will forgive me if I share the supplies that I know are in the mountain...  I shall return."
        [/message]
        {MOVE_UNIT (id=Kerrnyn) 68 61}
        [store_unit]
            [filter]
                id=Kerrnyn
            [/filter]
            variable=kerrnyn
            kill=yes
        [/store_unit]
        [message]
            speaker=narrator
            message=_"Haldrad and his officers exchanged glances, but he decided to give the crazed fighter a chance to return of his own accord."
        [/message]
    [/event]

    [event]
        name=turn 7
        [unstore_unit]
            variable=kerrnyn
        [/unstore_unit]
        {CLEAR_VARIABLE kerrnyn}
        {MODIFY_UNIT (id=Kerrnyn) facing nw}
        [terrain]
            terrain=Spay^Vct
            x,y=68,60-61
        [/terrain]
        [redraw][/redraw]
        [message]
            speaker=Lyron
            message=_"Look who's back..."
        [/message]
        [message]
            speaker=Kerrnyn
            message=_"Yes, I'm back, with supplies!  The Goddess had instructed us on how to clean and dress wounds, these two medical tents have all the instruments needed for that."
        [/message]
#ifdef EASY
        [gold]
            side=1
            amount=280
        [/gold]
#endif
#ifdef NORMAL
        [gold]
            side=1
            amount=75
        [/gold]
#endif
    [/event]

    [event]
        name=side 5 turn 6 end
        # testing
        #	name=side 5 turn 2 end
        [message]
            speaker=Minder
            message=_"You are not doing your part!  I must report-"
        [/message]
        [message]
            speaker=Keldan
            message=_"No, I am analyzing the situation!  I must pick the best fighters, and I am but a humble Khthon, I do not have the fast, metal mind of-"
        [/message]
        [message]
            speaker=Minder
            message=_"Flattery will not fool me!  Start fighting or I shall report you!"
        [/message]
        [message]
            speaker=Keldan
            message=_"Fine, I'll recklessly throw my forces at the intruders!  Happy?"
        [/message]
        [message]
            speaker=Minder
            message=_"Negative! Start fighting!"
        [/message]
        [event]
            remove=true
            id=idle_5_ai
        [/event]
    [/event]

    [event]
        name=turn 7
        # this was difficult to balance
        #        name=attack_end
        #        [filter]
        #            side=1
        #            #        side=1,5 # if the truce happens during AIs turn, the teams change, but controller doesn't until end of turn, so the Phantoms AI destroy the Elf A
        #        [/filter]
        #        [filter_second]
        #            side=5
        #            #        side=1,5
        #        [/filter_second]
        [message]
            speaker=E_Caldera
            message=_"Stop this!  Why are we fighting?"
        [/message]
        [store_unit]
            [filter]
                id=Keldan
            [/filter]
            variable=keldan
            kill=no
        [/store_unit]
        {MOVE_UNIT (id=E_Caldera) $keldan.x $keldan.y}
        # need to have something to check which way she should face
        [if]
            [have_unit]
                id=Keldan
                [filter_adjacent]
                    id=E_Caldera
                    adjacent=nw,sw
                [/filter_adjacent]
            [/have_unit]
            [then]
                {MODIFY_UNIT (id=E_Caldera) facing ne}
            [/then]
            [else]
                {MODIFY_UNIT (id=E_Caldera) facing nw}
            [/else]
        [/if]
        [message]
            speaker=E_Caldera
            message=_"(*hisses*<i>Keldan, look at me!</i>)"
        [/message]
        [if]
            [have_unit]
                id=Keldan
                [filter_adjacent]
                    id=E_Caldera
                    adjacent=nw,sw
                [/filter_adjacent]
            [/have_unit]
            [then]
                {MODIFY_UNIT (id=Keldan) facing sw}
            [/then]
            [else]
                {MODIFY_UNIT (id=Keldan) facing se}
            [/else]
        [/if]
        [message]
            speaker=Keldan
            message=_"...  Echidna?  Is that you?"
        [/message]
        # this could be the branch point, but for now, I will play it straight
        [message]
            speaker=narrator
            message=_"Keldan felt very conflicted.  He knew Seth's promise was empty, so he was biding his time to see if there was another possible winning side.  The part of him that was still Elf wanted that side to be the human-led defenders, and strike down both Seth and Echidna.  The part of him that was Khthon wanted to rejoin Echidna, defeat Seth and consume the humans..."
        [/message]
        [message]
            speaker=Keldan
            message=_"Keep your cover for now, I will-"
        [/message]
        {FLASH_RED (
            [music]
                name=legends_of_the_north.ogg
                immediate=no
                append=no
            [/music]
            [message]
                speaker=Minder
                message=_"ALERT!  Betrayal!  ALERT-"
            [/message]
        )}
        [message]
            speaker=Keldan
            message=_"*(snarl!)* Silence you!"
        [/message]
        [animate_unit]
            flag=attack
            [filter]
                id=Keldan
            [/filter]
            hits=yes
            [primary_attack]
                name=sword
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    [filter]
                        id=Minder
                    [/filter]
                [/filter_adjacent_location]
            [/facing]
        [/animate_unit]

        [kill]
            id=Minder
            animate=yes
        [/kill]
        {CLEAR_VARIABLE keldan}
        [message]
            speaker=Keldan
            message=_"Damnation!  They see my true colors!  Human Prince, I fight for you now!  We are enemies, and I'll admit I razed your capitol, but we must unite now to confront this threat!"
        [/message]
        [message]
            speaker=Haldrad
            message=_"You seem to have the trust of my mother. (<i> Or whoever that is...</i>)  I accept your offer, let us join forces for now."
        [/message]
        [modify_side]
            side=5
            team_name=Human
            controller=human
        [/modify_side]
#ifdef EASY
        [gold]
            side=5
            amount=270
        [/gold]
#endif
#ifdef NORMAL
        [gold]
            side=5
            amount=240
        [/gold]
#endif
#ifdef HARD
        [gold]
            side=5
            amount=200
        [/gold]
#endif
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=49,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            side=6
            x,y=51,36
            facing=nw
        [/unit]
        [message]
            x,y=51,36
            message=_"The slaves revolt!  Seek and destroy!"
        [/message]
        [message]
            id=Imambyses
            message=_"Indeed...  We no longer require your services, Keldan ..."
        [/message]
        [set_variable]
            name=spawn_side_6
            value=yes
        [/set_variable]
        [music]
            name=battle.ogg
            append=no
            immediate=yes
        [/music]
    [/event]

    [event]
        name=die
        [filter]
            id=Imambyses
        [/filter]
        [message]
            side=1
            message=_"The enemy generals are falling, we are winning!"
        [/message]
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "Your <i>arrogance</i> shall be your downfall..."
        [/message]
        [terrain]
            terrain=Qxu^Scfz
            x=50,49-51
            y=35,36
        [/terrain]
        [unit]
            side=6
            type=Mechanical Dragon
            id=Mech_D
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=48,38
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=48,33
            facing=nw
        [/unit]
        [redraw][/redraw]
        [music]
            name=knalgan_theme.ogg
            append=yes
            immediate=yes
        [/music]
        [message]
            speaker=Mech_D
            message=_"*ROAR!*" # try to come up with something less stupid
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"The mechanical monster made a strange, ear-splitting noise that was like nothing the humans or khthon had ever heard before..."
        [/message]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Keldan
        [/filter]
        [message]
            speaker=unit
            message=_"So this is the end...  I'll never know..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"He was a good man back when he was an elf, but the elves have suffered a very strange illness.  I hope that in death, they find peace and freedom from the green-eyed daemons."
        [/message]
        [message]
            speaker=Echidna
            message=_"We are not <i>daemons!</i>  But you are sad little animals, and your silly little kingdoms fold when confronted, just like how my dear Seth's little circus-show is now collapsing!"
        [/message]
        [message]
            speaker=unit
            message=_"No...  Don't be fooled...  Seth will win...  unless you destroy...  the source."
        [/message]
        [message]
            speaker=Haldrad
            message=_"What source, where?  What are you saying?"
        [/message]
        [message]
            speaker=unit
            message=_"Underground... <i>*gasp!*</i> ..."
        [/message]
        # FLAG
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "Hahaha...  Nice try, Keldan, but you shall pay for that!  And you cannot escape your service to me by death, we had a deal..."
        [/message]
        [item]
            halo="halo/holy/light-beam-[1~6,2,5].png~CS(-100,-150,10):[80*8]"
            x,y=$x1,$y1
        [/item]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=unit
            message=_"I never made...  deal...  damn you..."
        [/message]
        [delay]
            time=100
        [/delay]
        [kill]
            id=Keldan
            animate=yes
        [/kill]
        [remove_item]
            halo="halo/holy/light-beam-[1~6,2,5].png~CS(-100,-150,10):[80*8]"
            x,y=$x1,$y1
        [/remove_item]
        [message]
            speaker=Haldrad
            message=_"That was creepy...  But, it seems we need to destroy something underground."
        [/message]
        [message]
            speaker=second_unit
            message=_"Or it is a trap, his last attempt to harm us."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Hrmm..."
        [/message]
        #        [set_variable]
        #            name=gateD_open
        #            value=yes
        #        [/set_variable]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Echidna
        [/filter]
        [message]
            speaker=unit
            message=_"This is not the end of me..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Sure looks like the end to me!"
        [/message]
        [message]
            speaker=Dardrus
            message=_"I wouldn't be so sure, Prince Haldrad.  Keep your guard up!"
        [/message]
        #    [set_variable]
        #        name=gateB_open
        #        value=yes
        #    [/set_variable]
        #    [set_variable]
        #        name=gateE_open
        #        value=yes
        #    [/set_variable]
        [kill]
            id=Echidna
            animate=yes
        [/kill]
        [item]
            image=items/sceptre-of-fire.png
            x,y=$x1,$y1
        [/item]
        # there is probably a more elegant way to deal with this, but let's worry about that later
        [set_variable]
            name=sceptre_x
            value=$x1
        [/set_variable]
        [set_variable]
            name=sceptre_y
            value=$y1
        [/set_variable]
        [event]
            name=moveto
            [filter]
                side=1,3
                x,y=$sceptre_x|,$sceptre_y|
            [/filter]
            [if]
                [variable]
                    name=unit.side
                    equals=3
                [/variable]
                [then]
                    [message]
                        speaker=unit
                        message=_"This mighty wand can shoot explosive fire, I've seen it with my own eyes!  We'll fry the enemy now!"
                    [/message]
                    [message]
                        speaker=Haldrad
                        message=_"We could do that, but that thing also attracts all sorts of attention, and if we lose it, we can't go home.  We need to keep it hidden."
                    [/message]
                    [message]
                        speaker=unit
                        message=_"Right, I see.  I'll pass it along as soon as I can."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Haldrad
                        message=_"We need the Sceptre to power the flying mountain to get home.  It's a powerful weapon, but we'll need to keep it hidden for now."
                    [/message]
                [/else]
            [/if]
            [message]
                speaker=Haldrad
                message=_"Now we have to focus our efforts on defeating the lord of this strange world, lest it come back to attack us again."
            [/message]
            [remove_item]
                x,y=$sceptre_x|,$sceptre_y|
                image=items/sceptre-of-fire.png
            [/remove_item]
        [/event]
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Find and Defeat Seth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lyron"
            [/objective]
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Find and Defeat Seth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=last breath
        [filter]
            canrecruit=yes
            [filter_side]
                controller=human
            [/filter_side]
            [not]
                id=$temp_leader_id
            [/not]
        [/filter]
        [message]
            speaker=unit
            message=_"Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=E_Caldera,Ponce,Lyron
        [/filter]
        [message]
            speaker=unit
            message=_"Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        # testing
        #	name=turn 3
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                id=Tristien
            [/have_unit]
            [not]
                [variable]
                    name=run_dialog
                    equals=yes
                [/variable]
            [/not]
        [/filter_condition]
        [set_variable]
            name=mech_type
            rand=Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Defender,Tri_Mech_Defender,Tri_Mech_Sentinel
        [/set_variable]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=49,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            type=$mech_type
            side=6
            x,y=50,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            side=6
            x,y=51,36
            facing=nw
        [/unit]
        {CLEAR_VARIABLE mech_type}
        [if]
            [have_unit]
                side=6
                # testing
                #		 count=2-99
                count=12-99 # this may need adjustment
            [/have_unit]
            [then]
                [set_variable]
                    name=run_dialog
                    value=yes
                [/set_variable]
                [message]
                    speaker=Ponce
                    message=_"We are just going to get overwhelmed by these machines if we stay here - I don't see how we can defeat them!"
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"You're right...  We need to get into Seth's compound and take this fight to him!  Everyone, head to the large building, we're going in!"
                [/message]
                [message]
                    speaker=Dardrus
                    message=_"Prince!  There is that smaller building that also has passage to the underground, shouldn't some of us check that out as well?"
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"I don't like the idea of splitting our forces, but it might be for the best, since we don't know the layout of Seth's lair...  Very well, you take the small compound, I'll take the larger one."
                [/message]
                [objectives]
                    side=1
                    [objective]
                        condition=win
                        description=_ "Haldrad reaches north-most stairwell (red-ringed indicator image - may be hidden by shroud)"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Haldrad"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Ponce"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Lyron"
                    [/objective]
                    note=_"Any unit from Side 3 that goes to the north-most stairwell before Haldrad will join Side 1."
                [/objectives]
                [objectives]
                    side=3
                    [objective]
                        condition=win
                        description=_ "Dardrus or Bresda reaches east-most stairwell (green-ringed indicator image)"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Dardrus"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Bresda"
                    [/objective]
                    note=_"Any unit from Side 1 that goes to the east-most stairwell before Dardrus or Bresda will join Side 3."
                [/objectives]
                [item]
                    image=items/gohere.png
                    x,y=28,2
                [/item]
                [item]
                    image=items/gohere.png~RC(ellipse_red > green)
                    x,y=66,44
                [/item]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=28,1-2
                        side=1
                        canrecruit=yes
                    [/filter]
                    [if]
                        [have_unit]
                            x,y=66,43-44
                            side=3
                            canrecruit=yes
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message=_"Now, let us put an end to that evil Seth!"
                            [/message]
                            [message]
                                x,y=66,43-44
                                message=_"We are in position.  Fate be with you!"
                            [/message]
                            [endlevel]
                                {CONTINUE}
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
                                speaker=unit
                                message=_"Hurry up!  We need to storm the lower level at the same time, lest the first give away the element of surprise for the second."
                            [/message]
                            [message]
                                speaker=Bresda
                                message=_"We are trying!"
                            [/message]
                        [/else]
                    [/if]
                [/event]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=66,43-44
                        side=3
                        canrecruit=yes
                    [/filter]
                    [if]
                        [have_unit]
                            x,y=28,1-2
                            side=1
                            canrecruit=yes
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message=_"Now, let us put an end to that evil Seth!"
                            [/message]
                            [message]
                                x,y=28,1-2
                                message=_"We are in position.  Fate be with you!"
                            [/message]
                            [endlevel]
                                {CONTINUE}
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
                                speaker=unit
                                message=_"Hurry up!  We need to storm the lower level at the same time, lest the first give away the element of surprise for the second."
                            [/message]
                            [message]
                                speaker=Haldrad
                                message=_"We are trying!"
                            [/message]
                        [/else]
                    [/if]
                [/event]
                [event] # put to recall list of side 3
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=28,1-2
                        side=1,3
                        [not]
                            canrecruit=yes
                        [/not]
                    [/filter]
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=ptr1
                        kill=yes
                    [/store_unit]
                    [set_variable]
                        name=ptr1.side
                        value=1
                    [/set_variable]
                    [set_variable]
                        name=ptr1.x
                        value=recall
                    [/set_variable]
                    [set_variable]
                        name=ptr1.y
                        value=recall
                    [/set_variable]
                    [unstore_unit]
                        variable=ptr1
                        find_vacant=no
                    [/unstore_unit]
                    {CLEAR_VARIABLE ptr1}
                [/event]
                [event] # put to recall list of side 3
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=66,43-44
                        side=1,3
                        [not]
                            canrecruit=yes
                        [/not]
                    [/filter]
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=ptr3
                        kill=yes
                    [/store_unit]
                    [set_variable]
                        name=ptr3.side
                        value=3
                    [/set_variable]
                    [set_variable]
                        name=ptr3.x
                        value=recall
                    [/set_variable]
                    [set_variable]
                        name=ptr3.y
                        value=recall
                    [/set_variable]
                    [unstore_unit]
                        variable=ptr3
                        find_vacant=no
                    [/unstore_unit]
                    {CLEAR_VARIABLE ptr3}
                [/event]
            [/then]
        [/if]
    [/event]
[/scenario]
