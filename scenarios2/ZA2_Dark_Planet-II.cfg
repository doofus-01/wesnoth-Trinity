#textdomain wesnoth-Trinity

[scenario]
    id="Dark_Planet_2"
    name= _ "Dark Planet (II)"
    map_data="{~add-ons/Trinity/maps/Dark_Planet_Lower_Seth.map}"
    next_scenario=Dark_Planet_2b
    victory_when_enemies_defeated=no
    {TURNS 85 70 60}

    [music]
        name="legends_of_the_north.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    {BMR_RESTORE_SIDE 1}
    {UNDERGROUND}

    ###############################################
    # Sides
    ###############################################
    # Haldrad
    [side]
        type=Spearman
        id=Fooby
        name= _ "Haldrad"
        side=1
        canrecruit=yes
        controller=human
        fog=no
        shroud=yes
        scroll_to_leader=no
        recruit="Spearman,Bowman,Peasant,Ruffian,Heavy Infantryman"
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 10 7 4}
        #        {GOLD 390 270 160}
        team_name=Human
        #        [village]
        #            x,y=64,57
        #        [/village]
    [/side]

    [side]
        type=Seth
        id=Seth
        name= _ "Seth"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit="Tomb Slave,Tomb Dancer,Tomb Huntress,Tomb Shade,Tower Dancer,Skeleton Archer,Skeleton"
        [unit]
            type=Seth Beast3
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Shield
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Shield
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Wing
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Master
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Protector
            x,y=recall,recall
        [/unit]
        [unit]
            type=Tomb Sentinel
            x,y=recall,recall
        [/unit]
        [unit]
            type=Spectre
            x,y=recall,recall
        [/unit]
        [unit]
            type=Wraith
            x,y=recall,recall
        [/unit]
        {INCOME 4 6 8}
        {GOLD 50 150 250}
        team_name=Phantom
    [/side]

    [side] # I'm not sure if it works to have a no_leader side, then give it a canrecruit=yes unit later
        type=Seth_Shade
        id=Seth_S
        name= _ "Seth"
        side=3
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit="Tomb Shade"
        {INCOME 4 8 12} # needed?
        {GOLD 100 120 150} # not sure this matters
        team_name=Phantom
        hidden=yes
    [/side]

    # leaderless others
    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
        hidden=yes
    [/side]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Find and Defeat Seth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad, Ponce, or Lyron"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time runs out"
                show_turn_counter=yes
            [/objective]
        [/objectives]
        [music]
            name=the_deep_path.ogg
            append=yes
            immediate=no
        [/music]
        [music]
            name=into_the_shadows.ogg
            append=yes
            immediate=no
        [/music]
        [item]
            image=items/bones.png
            x,y=15,21
        [/item]
        [event]
            name=moveto
            [filter]
                side=1
                x,y=15,21
            [/filter]
            [message]
                speaker=unit
                message=_"This skeleton is even bigger and denser than that of an orc...  Whoever this was, he or she was pretty big."
            [/message]
        [/event]
        [item]
            image=items/chest-plain-closed.png
            x,y=14,20
        [/item]
        [event]
            name=moveto
            [filter]
                side=1
                # testing
                #		x,y=25,3
                x,y=14,20
            [/filter]
            [remove_item]
                image=items/chest-plain-closed.png
                x,y=14,20
            [/remove_item]
            [item]
                image=items/chest-plain-open.png
                x,y=14,20
            [/item]
            [message]
                speaker=unit
                message=_"This chest is filled with dust and what was once long hair, probably padding that has rotted away long ago ... Aha!  I think I've found treasure!  It's a bronze ball with a thumb-sized red jewel set into it."
            [/message]
            [message]
                speaker=Haldrad
                message=_"Well, maybe it's a bomb - Press that red jewel and we can blow up Seth like we did with the door to his chamber..."
            [/message]
            [message]
                speaker=unit
                message=_"Maybe...  There is an etching of what looks like an hour-glass, just to one side of the jewel.  The rest of the ball is smooth."
            [/message]
            [message]
                speaker=narrator
                message=_"To use this mystery device, use the right-click menu over the unit carrying it, and select 'Press Jewel'.  Prince Haldrad has no idea what this device does, but it is still a good idea to get closer to Seth before activating it."
            [/message]
            [unit_overlay]
                id=$unit.id
                image=misc/blank-hex.png~BLIT(items/ball-green.png~SCALE(26,26),46,0)
            [/unit_overlay]
            [set_variable]
                name=jewel
                value=$unit.id
            [/set_variable]
            [event]
                name=die
                [filter]
                    id=$jewel
                [/filter]
                [item]
                    image=items/ball-green.png
                    x,y=$x1,$y1
                [/item]
                [event]
                    name=moveto
                    delayed_variable_substitution=no
                    [filter]
                        side=1
                        x,y=$x1,$y1
                    [/filter]
                    [remove_item]
                        image=items/ball-green.png
                        x,y=$x1,$y1
                    [/remove_item]
                    [unit_overlay]
                        id=$|unit.id
                        image=misc/blank-hex.png~BLIT(items/ball-green.png~SCALE(26,26),46,0)
                    [/unit_overlay]
                    [set_variable]
                        name=jewel
                        value=$|unit.id
                    [/set_variable]
                [/event]
            [/event]
            [set_menu_item]
                id=tri_time_jewel
                description=_"Press Jewel"
                image=items/ball-green.png~SCALE(36,36)
                [show_if]
                    [have_unit] # is there going to be a problem with delayed_variable_substitution?
                        id=$jewel
                        x,y=$x1,$y1
                    [/have_unit]
                [/show_if]
                [command]
                    [remove_unit_overlay]
                        x,y=$x1,$y1
                        image=misc/blank-hex.png~BLIT(items/ball-green.png~SCALE(26,26),46,0)
                    [/remove_unit_overlay]
                    [set_variable] # there is surely a better way to do this, but let's just get this to work at all for now.
                        name=jxp
                        value=$x1
                    [/set_variable]
                    [set_variable]
                        name=jxn
                        value=$x1
                    [/set_variable]
                    [set_variable]
                        name=jyp
                        value=$y1
                    [/set_variable]
                    [set_variable]
                        name=jyn
                        value=$y1
                    [/set_variable]
                    [set_variable]
                        name=jxp
                        add=3
                    [/set_variable]
                    [set_variable]
                        name=jxn
                        add=-3
                    [/set_variable]
                    [set_variable]
                        name=jyp
                        add=3
                    [/set_variable]
                    [set_variable]
                        name=jyn
                        add=-3
                    [/set_variable]
                    [store_unit]
                        [filter]
                            x=$jxn|-$jxp|
                            y=$jyn|-$jyp|
                        [/filter]
                        variable=jf_TEMP
                        kill=no
                    [/store_unit]
                    [clear_menu_item]
                        id=tri_time_jewel
                    [/clear_menu_item]
                    {FOREACH jf_TEMP ji}
                        [object]
                            #			    id=jewel_active
                            duration=turn
                            [filter]
                                id=$jf_TEMP[$ji].id
                            [/filter]
                            silent=yes
                            [effect]
                                apply_to=movement
                                increase=8
                            [/effect]
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_attacks=6
                            [/effect]
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_attacks=6
                            [/effect]
                            #			    [effect] # this does not get reset, though the other stuff does.
                            #				apply_to=image_mod
                            #				add=~CS(-20,0,90)
                            #			    [/effect]
                            [effect]
                                apply_to=halo
                                halo=halo/the-destroyer-spark5.png
                            [/effect]
                        [/object]
                        [set_variable]
                            name=moves_TEMP
                            value=$jf_TEMP[$ji].max_moves
                        [/set_variable]
                        [modify_unit]
                            [filter]
                                id=$jf_TEMP[$ji].id
                            [/filter]
                            moves=$moves_TEMP
                        [/modify_unit]
                        {CLEAR_VARIABLE moves_TEMP}
                    {NEXT ji}
                    {FLASH_BLUE (
                        [message]
                            speaker=narrator
                            message=_"After the red jewel was pressed, a blue light radiated from the brass ball.  Those who were standing outside the radius of the blue light seemed to slow down, at least from the perspective of those inside."
                        [/message] )}
                    [/command]
                [/set_menu_item]
            [/event]
            [item]
                image=items/chest-plain-closed.png
                x,y=14,40
            [/item]
            [event]
                name=moveto
                [filter]
                    side=1
                    x,y=14,40
                [/filter]
                [remove_item]
                    image=items/chest-plain-closed.png
                    x,y=14,40
                [/remove_item]
                [item]
                    image=items/chest-plain-open.png
                    x,y=14,40
                [/item]
                [message]
                    speaker=unit
                    message=_"This chest is full of a smelly powder...  It smells a little bit like lava pits, a little like swamp water, and something else... It's difficult to explain."
                [/message]
                [message]
                    speaker=unit
                    message=_"It is either the rotted dust of something organic, or it is a useful substance...  I'll collect it, just in case."
                [/message]
                [message]
                    speaker=narrator
                    image=icons/potion_red_medium.png~GS()~SCALE(300,300)
                    message=_"$unit.name| collected the dust in a bottle."
                [/message]
                [unit_overlay]
                    id=$unit.id
                    image=misc/blank-hex.png~BLIT(items/potion-grey.png~SCALE(36,36),36,0)
                [/unit_overlay]
                [set_variable]
                    name=powder
                    value=$unit.id
                [/set_variable]
                [event]
                    name=enter_hex
                    [filter]
                        id=$powder
                        x,y=28,38
                    [/filter]
                    [allow_undo][/allow_undo]
                    [message]
                        speaker=unit
                        message=_ "Why is everyone just standing around?"
                    [/message]
                    [message]
                        speaker=Haldrad
                        message=_ "Our path forward is unclear."
                    [/message]
                    [message]
                        id=$not_powder
                        message=_ "We think we found the passage over by that brazier, but it's sealed shut."
                    [/message]
                    [message]
                        speaker=unit
                        message=_ "Let me investigate."
                    [/message]
                [/event]                        
                [event]
                    name=die
                    [filter]
                        id=$powder
                    [/filter]
                    [item]
                        image=items/potion-grey.png
                        x,y=$x1,$y1
                    [/item]
                    [event]
                        name=moveto
                        delayed_variable_substitution=no
                        [filter]
                            side=1
                            x,y=$x1,$y1
                        [/filter]
                        [remove_item]
                            image=items/potion-grey.png
                            x,y=$x1,$y1
                        [/remove_item]
                        [unit_overlay]
                            id=$|unit.id
                            image=misc/blank-hex.png~BLIT(items/potion-grey.png~SCALE(26,26),46,0)
                        [/unit_overlay]
                        [set_variable]
                            name=powder
                            value=$|unit.id
                        [/set_variable]
                    [/event]
                [/event]
            [/event]

            [item]
                image=items/chest-plain-closed.png
                x,y=54,19
            [/item]
            [event]
                name=moveto
                [filter]
                    side=1
                    x,y=54,19
                [/filter]
                [remove_item]
                    image=items/chest-plain-closed.png
                    x,y=54,19
                [/remove_item]
                [item]
                    image=items/chest-plain-open.png
                    x,y=54,19
                [/item]
                [message]
                    speaker=unit
                    message=_"These gold coins have a strange stamp, but gold is gold, right?  I'd say we have the equivilent of 200 gold here."
                [/message]
                {ZERO_GOLD 1}
                [gold]
                    side=1
                    amount=200
                [/gold]
            [/event]
            [item]
                image=items/chest-plain-closed.png
                x,y=10,31
            [/item]
            [event]
                name=moveto
                [filter]
                    side=1
                    x,y=10,31
                [/filter]
                [remove_item]
                    image=items/chest-plain-closed.png
                    x,y=10,31
                [/remove_item]
                [item]
                    image=items/chest-plain-open.png
                    x,y=10,31
                [/item]
                [message]
                    speaker=unit
                    message=_"Is this some sort of joke?  There's just a scrap of paper, with a badly drawn animal..."
                [/message]
                [message]
                    speaker=narrator
                    message=_"$unit.name| put the scrap back into the chest, and felt a hot, rasping breath from behind..."
                [/message]
                {MODIFY_UNIT (id=$unit.id) facing se}
                [delay]
                    time=150
                [/delay]
                {MODIFY_UNIT (id=$unit.id) facing sw}
                [delay]
                    time=150
                [/delay]
                {MODIFY_UNIT (id=$unit.id) facing se}
                [delay]
                    time=150
                [/delay]
                {MODIFY_UNIT (id=$unit.id) facing sw}
                [delay]
                    time=150
                [/delay]
                [message]
                    speaker=unit
                    message=_"There's no monster behind me...  Just my mind playing tricks on me..."
                [/message]
                [message]
                    speaker=narrator
                    image=portraits/seth.png~O(0.3)
                    message=_"<i> Haha... </i>"
                [/message]
            [/event]
            [item]
                image=scenery/summoning-center.png~O(0.6)
                x,y=11,44
            [/item]
            [event]
                name=moveto
                first_time_only=no
                [filter]
                    side=1
                    x,y=11,44
                [/filter]
                [teleport]
                    [filter]
                        x,y=11,44
                    [/filter]
                    x,y=54,20
                    animate=yes
                [/teleport]
            [/event]
            [item]
                image=scenery/summoning-center.png~O(0.6)
                x,y=54,20
            [/item]
            [event]
                name=moveto
                first_time_only=no
                [filter]
                    side=1
                    x,y=54,20
                [/filter]
                [teleport]
                    [filter]
                        x,y=54,20
                    [/filter]
                    x,y=11,44
                    animate=yes
                [/teleport]
            [/event]
            [store_unit]
                [filter]
                    id=Seth
                [/filter]
                variable=seth
                kill=yes
            [/store_unit]
            [store_unit]
                [filter]
                    id=Seth_S
                [/filter]
                variable=seth_s
                kill=yes
            [/store_unit]
        [/event]

        [event]
            name=start
            [recall]
                side=1
                x,y=28,1
            [/recall]
            [message]
                speaker=Haldrad
                message=_"We haven't much time!  Those metal monsters won't be content to stay up there."
            [/message]
            {MODIFY_UNIT (id=Haldrad) facing se}
            [terrain]
                terrain=Ce
                x,y=28-29,4-5
            [/terrain]
            [terrain]
                terrain=Ke
                x,y=27,4
            [/terrain]
            [unit]
                type=Seth_Shade
                id=Seth_
                name=Seth
                x,y=32,5
                facing=nw
            [/unit]
            [message]
                speaker=Seth_
                message=_"Well, well, well...  Hello, Prince Haldrad!  I would apologize for what I did to your palace, but I am not really sorry, and it was my dear Echidna and her Khthon that had trashed the place anyway.  Your kingdom was quite unimpressive, compared to those that I have previously vanquished...  But I like you, for some reason-"
            [/message]
            [message]
                speaker=Haldrad
                message=_"<i>Enough!</i>  I do not have the time to listen to your-"
            [/message]
            [message]
                speaker=Seth_
                message=_"<b>Silence!</b>  You have all the time in the world, as far as I am concerned!  Now, where were we?  Ah yes, have you heard the parable of the rich man and the tiger?"
            [/message]
            [message]
                speaker=Haldrad
                message=_"...  I have no idea what a 'tiger' is, so no, I have not ..."
            [/message]
            [message]
                speaker=Seth_
                message=_"Well, a tiger is a beast that can easily kill a man, that is all you need to know.  ...  Actually, forget it, no stories for you!  Just choose a path, and accept the consequneces!"
            [/message]
            [kill]
                id=Seth_
                animate=yes
            [/kill]
            [unit]
                side=2
                type=Spirit Dove
                x,y=32,5
                facing=nw
            [/unit]
            {MOVE_UNIT (id=Haldrad) 27 4}
            {MODIFY_UNIT (id=Haldrad) facing se}
            #        [message]
            #            speaker=narrator
            #            message=_"This scenario isn't really written yet."
            #        [/message]
        [/event]

        [event]
            name=moveto
            first_time_only=no
            [filter]
                side=1
                x,y=30-31,6
            [/filter]
            [filter_condition]
                [have_location]
                    x,y=31,7
                    terrain=Urfz^Gtye
                [/have_location]
            [/filter_condition]
            {QUAKE "rumble.ogg"}
            [terrain]
                terrain=Urfz
                x,y=31,7
            [/terrain]
            [if]
                [have_unit]
                    x,y=34,5
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            x,y=34,5
                        [/filter]
                        variable=g1_TMP
                        kill=yes
                    [/store_unit]
                    [terrain]
                        terrain=Urfz^Gtye
                        x,y=34,5
                    [/terrain]
                    [unstore_unit]
                        variable=g1_TMP
                        find_vacant=yes
                    [/unstore_unit]
                    [redraw]
                        side=1
                    [/redraw]
                    {CLEAR_VARIABLE g1_TMP}
                [/then]
                [else]
                    [terrain]
                        terrain=Urfz^Gtye
                        x,y=34,5
                    [/terrain]
                    [redraw]
                        side=1
                    [/redraw]
                [/else]
            [/if]
        [/event]

        [event]
            name=moveto
            first_time_only=no
            [filter]
                side=1
                x,y=32-33,5
            [/filter]
            [filter_condition]
                [have_location]
                    x,y=34,5
                    terrain=Urfz^Gtye
                [/have_location]
            [/filter_condition]
            {QUAKE "rumble.ogg"}
            [terrain]
                terrain=Urfz
                x,y=34,5
            [/terrain]
            [if]
                [have_unit]
                    x,y=31,7
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            x,y=31,7
                        [/filter]
                        variable=g1_TMP
                        kill=yes
                    [/store_unit]
                    [terrain]
                        terrain=Urfz^Gtye
                        x,y=31,7
                    [/terrain]
                    [unstore_unit]
                        variable=g1_TMP
                        find_vacant=yes
                    [/unstore_unit]
                    [redraw]
                        side=1
                    [/redraw]
                    {CLEAR_VARIABLE g1_TMP}
                [/then]
                [else]
                    [terrain]
                        terrain=Urfz^Gtye
                        x,y=31,7
                    [/terrain]
                    [redraw]
                        side=1
                    [/redraw]
                [/else]
            [/if]
        [/event]

        ##############
        # Enemy spawning events
        ##############

        [event]
            name=enter_hex
            [filter]
                side=1
                x,y=29,8-9
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Sentinel
                side=3
                x,y=21,5
            [/unit]
            [unit]
                type=Tomb Sentinel
                side=3
                x,y=20,5
            [/unit]
        [/event]
        [event]
            name=enter_hex
            [filter]
                side=1
                x,y=22,6
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Wing
                side=3
                x,y=17,3
            [/unit]
            [unit]
                type=Tomb Shield
                side=3
                x,y=16,3
            [/unit]
        [/event]
        [event]
            name=enter_hex
            [filter]
                side=1
                x,y=16,3-4
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Wing
                side=3
                x,y=10,4
            [/unit]
#ifdef HARD
            [unit]
                type=Tomb Protector
                side=3
                x,y=15,7
            [/unit]
#endif
            [unit]
                type=Seth Beast
                side=3
                x,y=9,7
                id=Beast1
            [/unit]
#ifndef EASY
            [unit]
                type=Seth Beast3
                side=3
                x,y=10,7
            [/unit]
#endif
            [event]
                name=die
                [filter]
                    id=Beast1
                [/filter]
                [message]
                    speaker=Ponce
                    message=_"What was that thing?  It was a beast, but it wore clothing, armor, gold, and jewelry, it seems..."
                [/message]
                [set_variable]
                    name=x_TEMP
                    value=$x1
                [/set_variable]
                [set_variable]
                    name=y_TEMP
                    value=$y1
                [/set_variable]
                [item]
                    image=items/ring-gold.png
                    x,y=$x1,$y1
                [/item]
                [message]
                    speaker=second_unit
                    message=_"The beast dropped some coins...  Strange, but gold is gold, and with this, we'll be able to secure some contracts for supplies."
                [/message]
                {ZERO_GOLD 1}
                [gold]
                    side=1
                    amount=120
                [/gold]
                {PICKUPPABLE_ITEM ring_of_beast $x_TEMP $y_TEMP side=1 items/ring-gold.png
                   _"The giant beast dropped a ring.  Oddly enough it's the right size for a human." 
                   _"Beast Ring^Take it"
                   _"Beast Ring^Leave it"
                   _"The giant beast dropped a ring.  Oddly enough it's the right size for a human." 
                   (
                   [object]
                        name=_"Gold Ring"
                        image=icons/ring_gold.png
                        description="The wearer of this ring can move more quickly than before (gains 1MP, cave terrain move costs set to 1)."
                        [then]

                            [remove_item]
                                x,y=$x_TEMP,$y_TEMP
                                image=items/ring-gold.png
                            [/remove_item]
                            {CLEAR_VARIABLE x_TEMP}
                            {CLEAR_VARIABLE y_TEMP}
                        [/then]
                        [effect]
                            apply_to=movement
                            increase=1
                        [/effect]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            [movement_costs]
                                cave=1
                            [/movement_costs]
                        [/effect]
                   [/object]
                )}
                [terrain]
                    terrain=Urfz
                    x=31,34
                    y=7,5
                [/terrain]
                [redraw]
                    side=1
                [/redraw]
            [/event]
            [event]
                name=moveto
                [filter]
                    side=1
                    x,y=8,8
                [/filter]
                [message]
                    speaker=unit
                    message=_ "The hallway beyond seems to have collapsed, we'll have to turn back."
                [/message]
            [/event]
        [/event]

        [event]
            name=exit_hex
            [filter]
                x,y=35,6
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Seth Beast3
                x,y=45,5
                side=3
            [/unit]
            [unit]
                type=Seth Beast3
                x,y=45,7
                side=3
            [/unit]
            [unit]
                type=Tomb Wing
                x,y=42,11
                side=3
            [/unit]
            [unit]
                type=Tomb Shield
                x,y=40,10
                side=3
            [/unit]
            [unit]
                type=Tomb Sentinel
                x,y=55,4
                side=3
            [/unit]
            [unit]
                type=Tomb Guard
                x,y=56,4
                side=3
            [/unit]
            [unit]
                type=Tomb Dancer
                x,y=58,4
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_1
                x,y=55,5
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_2
                x,y=56,5
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_1
                x,y=57,5
                side=3
            [/unit]
        [/event]

        [event]
            name=exit_hex
            [filter]
                x,y=50-52,14
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Shield
                x,y=54,21
                side=3
            [/unit]
            [unit]
                type=Tomb Wing
                x,y=50,19
                side=3
            [/unit]
            [unit]
                type=Tomb Archer
                x,y=52,21
                side=3
            [/unit]
            [unit]
                type=Tomb Dancer
                x,y=47,21
                side=3
            [/unit]
            [unit]
                type=Tomb Guard
                x,y=48,19
                side=3
            [/unit]
        [/event]
        [event]
            name=exit_hex
            [filter]
                x,y=60-63,6
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Stalker
                x,y=54,10
                side=3
            [/unit]
            [unit]
                type=Tomb Stalker
                x,y=56,11
                side=3
            [/unit]
            [unstore_unit]
                variable=seth_s
                x,y=51,22
            [/unstore_unit]
            # these were on the recall list, but they were causing trouble.
            [unit]
                type=Tomb Shade_11
                side=3
                x,y=55,21
                ai_special=guardian
            [/unit]
            [unit]
                type=Tomb Shade_12
                side=3
                x,y=45,21
                ai_special=guardian
            [/unit]
            [unit]
                type=Tomb Shade_13
                side=3
                x,y=46,24
                ai_special=guardian
            [/unit]
            [gold]
                side=3
                amount=100
            [/gold]
            [event] # will this work?
                name=sighted
                [filter]
                    id=Seth_S
                [/filter]
                [filter_second]
                    side=1
                [/filter_second]
                [message]
                    speaker=Seth_S
                    message=_"Your journey ends here..."
                [/message]
                [music]
                    name=New_Wesnoth_Battle_Music.ogg
                    immediate=yes
                    append=yes
                [/music]
            [/event]
            # this die event does not fire - fixed unit file, does it now?
            # 2020-07-04 - this event fires, but the base frame plops back in after any animation I've tried.  Looks really stupid and confusing.  Does [kill] work?
            # no, still got the stupid base frame standing there.  Try Lua unit:erase()? -> don't bother, [kill] tag already uses it and that doesn't work. 
            # Nothing seems to be working, maybe overwriting him with a fog clearer helps?  Success.
            [event]
                name=die
                [filter]
                    id=Seth_S
                [/filter]
                [unit]
                    type=Fog Clearer
                    placement=map
                    overwrite=yes
                    x,y=$x1,$y1
                    side=2
                    id=Foggy_TEMP
                    xp_bar_scaling=0.01
                    hp_bar_scaling=0.01
                    ellipse=none
                [/unit]
                {FADE_TO_BLACK}
                [kill]
                    [and]
                        type=Tomb Shade_1,Tomb Shade_2,Tomb Shade_3,Tomb Shade_4
                        x,y=48-58,13-23
                    [/and]
                    animate=no
                [/kill]
                #[kill]
                #    id=Seth
                #    animate=no
                #[/kill]
                [redraw]
                    side=1
                [/redraw]
                [kill]
                    id=Foggy_TEMP
                    animate=no
                [/kill]
                [delay]
                    time=300
                [/delay]
                {FADE_IN}
                [message]
                    speaker=Ponce
                    message=_"Well, that was strange..."
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"I don't think that's the last we've seen of him."
                [/message]
            [/event]
        [/event]
        [event]
            name=exit_hex
            [filter]
                x,y=45-47,25
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Bone Shooter
                x,y=38,31
                side=3
            [/unit]
            [unit]
                type=Draug
                x,y=39,32
                side=3
            [/unit]
            [unit]
                type=Shadow
                x,y=36,33
                side=3
            [/unit]
            [unit]
                type=Shadow
                x,y=36,34
                side=3
            [/unit]
        [/event]
        [event]
            name=exit_hex
            [filter]
                x=7,9
                y=35,40
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Shield
                x,y=3,38
                side=3
            [/unit]
            [unit]
                type=Tomb Wing
                x,y=1,37
                side=3
            [/unit]
            [unit]
                type=Tomb Archer
                x,y=5,37
                side=3
            [/unit]
            [unit]
                type=Tomb Dancer
                x,y=2,38
                side=3
            [/unit]
            [unit]
                type=Seth Beast3
                x,y=3,36
                side=3
            [/unit]
        [/event]
        [event]
            name=exit_hex
            [filter]
                x=7,13
                y=35,35
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Tomb Shield
                x,y=9,33
                side=3
            [/unit]
            [unit]
                type=Tomb Protector
                x,y=10,34
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_21
                x,y=10,33
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_21
                x,y=11,33
                side=3
            [/unit]
            [unit]
                type=Tomb Shade_22
                x,y=11,34
                side=3
            [/unit]
        [/event]
        [event]
            name=exit_hex
            [filter]
                x,y=26,38-39
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unit]
                type=Giant Spider
                x,y=1,37
                side=3
            [/unit]
        [/event]
        ##############
        # end spawning
        ##############

        [event]
            name=turn 30
            [unit]
                side=4
                type=Tri_Mech_Cyborg
                id=Cyborg
                x,y=28,2
            [/unit]
            [unit]
                side=4
                type=Tri_Mech_Sentinel
                id=Mech
                x,y=28,1
            [/unit]
            {MOVE_UNIT (id=Cyborg) 31 5}
            {MOVE_UNIT (id=Mech) 30 4}
            [message]
                speaker=Cyborg
                message=_"Ghuunng...  (mummble)..."
            [/message]
            [message]
                speaker=Mech
                message=_"Error!<i>*Bzzt*</i> too much <i>*Bzzzt</i> interference! <i>*Bzzzt</i> Cannot report! <i>*Bzzzt</i> Returning to base!"
            [/message]
            {MOVE_UNIT (id=Mech) 28 1}
            [kill]
                id=Mech
            [/kill]
            {MODIFY_UNIT (id=Cyborg) facing nw}
            [message]
                speaker=Cyborg
                message=_"Whrumph?   ... (mummble)..."
            [/message]
        [/event]

        [event]
            name=moveto
            [filter]
                x=30,31,33,34
                y=34,34,33,32
                side=1
                [not]
                    id=$powder
                [/not]
            [/filter]
            [message]
                speaker=unit
                message=_"This is clearly the main passage, but it is walled off, and I don't see any way to open it."
            [/message]
            [set_variable]
                 name=not_powder
                 value=$unit.id
            [/set_variable]
        [/event]

        [event]
            name=moveto
            [filter]
                x=30,31,33,34
                y=34,34,33,32
                id=$powder
            [/filter]
            [message]
                speaker=unit
                message=_"This is clearly the main passage, but it is walled off...  Hey, I can use that rocket powder to blow it open!"
            [/message]
            [message]
                speaker=Haldrad
                message=_"<i>Rocket</i> powder?"
            [/message]
            [message]
                speaker=unit
                message=_"Right, that foul-smelling powder I found, I knew it was familiar.  It's what the cannons in Elensefar used!  If we toss it into this brazier, it could blow these doors wide open!"
            [/message]
            [message]
                speaker=Haldrad
                message=_"Sounds dangerous.  Well, go ahead.  Everyone else, get down!"
            [/message]
            {MOVE_UNIT (id=$unit.id) 33 34}
            {MODIFY_UNIT (id=$unit.id) facing nw}
            {FLASH_RED (
                {QUAKE "rumble.ogg"}
                [terrain]
                    terrain=Ur^Es
                    x=30,33
                    y=33,32
                [/terrain]
                [redraw]
                    side=1
                [/redraw]
                [unit]
                    side=3
                    x,y=33,32
                    type=Mummy Unbound
                [/unit]
                [remove_unit_overlay]
                    id=$powder
                    image="misc/blank-hex.png~BLIT(items/potion-grey.png~SCALE(36,36),36,0)"
                [/remove_unit_overlay]
                {CLEAR_VARIABLE powder}
                {CLEAR_VARIABLE not_powder}
            )}
        [/event]

        [event]
            name=moveto
            [filter]
                side=1
                x,y=16,11-12
            [/filter]
            [message]
                speaker=unit
                message=_"Do I really have to go down there?  It's dark and ...  I just ... really feel I should not go down there."
            [/message]
        [/event]

        [event]
            name=moveto
            [filter]
                side=1
                x,y=20,30-31
            [/filter]
            [message]
                speaker=unit
                message=_"This wall has been patched over, and not very well.  I think I can claw the rubble aside..."
            [/message]
            [terrain]
                x,y=19,31
                terrain=Uu
            [/terrain]
            [redraw]
                side=1
            [/redraw]
        [/event]

        ####################
        # Seth Battle
        ####################

#define TRI_SETH_FIRE_EXP X Y BX BY
    [item]
        halo=misc/fire_ring_blank.png~BLIT("projectiles/fire-breath-[1~10].png~CS(-120,30,190)~SCALE(72,72)","{BX}","{BY}"):[100*10]
        #	halo=misc/fire_ring_blank.png~BLIT("projectiles/fire-burst-small-[1~8].png~CS(-120,30,190)~SCALE(72,72)","{BX}","{BY}"):[100*8]
        x,y={X},{Y}
    [/item]
    [sound]
        name=thunderstick.ogg
    [/sound]
    [delay]
        time=1000
    [/delay]
    [remove_item]
        halo=misc/fire_ring_blank.png~BLIT("projectiles/fire-breath-[1~10].png~CS(-120,30,190)~SCALE(72,72)","{BX}","{BY}"):[100*10]
        #	halo=misc/fire_ring_blank.png~BLIT("projectiles/fire-burst-small-[1~8].png~CS(-120,30,190)~SCALE(72,72)","{BX}","{BY}"):[100*8]
        x,y={X},{Y}
    [/remove_item]
#enddef

#define TRI_SETH_FIRE_LINK X Y BX BY
    [item]
        halo=misc/fire_ring_blank.png~BLIT("scenery/fire[1~8].png~CROP(0,0,72,45)~CS(-120,30,190)~SCALE(72,72)","{BX}","{BY}"):[100*8]
        x,y={X},{Y}
    [/item]
#enddef

        # this is a fix for the top flame, which looks wrong as a halo over the northmost recruited unit
#define TRI_SETH_FIRE_LINK_O X Y BX BY
    [item]
        halo=misc/fire_ring_blank.png~BLIT("scenery/fire[1~8].png~CROP(0,0,72,45)~CS(-120,30,190)~SCALE(72,72)~O(0.4)","{BX}","{BY}"):[100*8]
        x,y={X},{Y}
    [/item]
#enddef

#define TRI_SETH_FIRE_RING X Y
    [scroll_to]
        x,y={X},{Y}
    [/scroll_to]
    [delay]
        time=250
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    [delay]
        time=250
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 111 0}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK_O {X} {Y} 111 0}
    [delay]
        time=80
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 199 77}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK_O {X} {Y} 111 0}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 77}
    [delay]
        time=80
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 199 148}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK_O {X} {Y} 111 0}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 77}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 148}
    [delay]
        time=80
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 111 216} # 219 was better centered, but is too big for 288X288 base image
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK_O {X} {Y} 111 0}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 77}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 148}
    {TRI_SETH_FIRE_LINK {X} {Y} 111 216}
    [delay]
        time=80
    [/delay]
    {TRI_SETH_FIRE_EXP {X} {Y} 22 148}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 77}
    {TRI_SETH_FIRE_LINK_O {X} {Y} 111 0}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 77}
    {TRI_SETH_FIRE_LINK {X} {Y} 199 148}
    {TRI_SETH_FIRE_LINK {X} {Y} 111 216}
    {TRI_SETH_FIRE_LINK {X} {Y} 22 148}
    [delay]
        time=80
    [/delay]
#enddef

#define TRI_SETH_KEEP X Y
    [terrain]
        terrain=Ds^Cov
        layer=overlay
        [and]
            radius=1
            x,y={X},{Y}
        [/and]
        [not]
            terrain=Xos
        [/not]
    [/terrain]
    [terrain]
        terrain=Ds^Kov
        layer=overlay
        x,y={X},{Y}
    [/terrain]
    [animate_unit]
        flag=summon
        [filter]
            id=Seth
        [/filter]
        #	facing=n
    [/animate_unit]
    {TRI_SETH_FIRE_RING {X} {Y}}
    # why did I move this to afterward?
    #    [animate_unit]
    #        flag=summon
    #        [filter]
    #            id=Seth
    #        [/filter]
    #    [/animate_unit]
#enddef

        [event]
            # testing
            #            	name=turn 2
            name=enter_hex
            [filter]
                side=1
                x,y=20-36,29
            [/filter]
            [allow_undo]
            [/allow_undo]
            [unstore_unit]
                variable=seth
            [/unstore_unit]
            [remove_shroud]
                side=1
                x,y=20-38,12-32
            [/remove_shroud]
            [message]
                speaker=Seth
                message=_"You've made a big mistake coming here...  "
            [/message]
            [message]
                speaker=Haldrad
                message=_"No, you've made the mistake!  Your foul presence should never have darkened our skies!"
            [/message]
            [message]
                speaker=Seth
                message=_"They will be my skies soon.  You brought me Echidna, and now I shall extract what I need from you so that I may free her."
            [/message]
            [message]
                speaker=Haldrad
                message=_"That means nothing to me, but then, I do not care to have a chat with an evil madman.  Enough talking, now we fight!"
            [/message]
            [music]
                name=gathering_storm.ogg
                append=no
                immediate=yes
            [/music]
            [music]
                name=the_dangerous_symphony.ogg
                append=yes
                immediate=no
            [/music]
            [message]
                speaker=Seth
                message=_"On that last remark, we both agree..."
            [/message]
        [/event]
        [event]
            name=side 2 turn
            first_time_only=no
            [filter_condition]
                [have_unit]
                    id=Seth
                    [filter_adjacent] # so he can't be ganged up on
                        is_enemy=yes
                        count=5,6
                    [/filter_adjacent]
                [/have_unit]
            [/filter_condition]
            [store_unit]
                [filter]
                    id=Seth
                [/filter]
                variable=seth
                kill=no
            [/store_unit]
            [store_locations] # find a place in the chamber that is clear
                [and]
                    x=21-38
                    y=14-29
                    terrain=Urb,Rrc,Ur
                    [filter_adjacent_location]
                        [not]
                            [filter]
                            [/filter]
                        [/not]
                    [/filter_adjacent_location]
                [/and]
                variable=seth_tel_loc
            [/store_locations]
            [set_variable]
                name=random_stl_index
                rand=0..$seth_tel_loc.length
            [/set_variable]
            [teleport]
                [filter]
                    id=Seth
                [/filter]
                x,y=$seth_tel_loc[$random_stl_index].x|,$seth_tel_loc[$random_stl_index].y|
                animate=yes
            [/teleport]
            {CLEAR_VARIABLE seth_tel_loc}
            {CLEAR_VARIABLE random_stl_index}
            {CLEAR_VARIABLE seth}
        [/event]
        [event]
            name=side 2 turn refresh
            first_time_only=no
            [filter_condition]
                [have_unit]
                    id=Seth
                    [filter_adjacent] # to slow down recruiting
                        is_enemy=no
                        count=0
                    [/filter_adjacent]
                    [not]
                        [filter_adjacent] # for when he is surrounded
                            is_enemy=yes
                            count=6
                        [/filter_adjacent]
                    [/not]
                [/have_unit]
            [/filter_condition]
            [store_unit]
                [filter]
                    id=Seth
                [/filter]
                variable=seth
                kill=no
            [/store_unit]
            {TRI_SETH_KEEP $seth.x $seth.y}
        [/event]
        [event]
            #            name=turn end
            name=exit_hex
            first_time_only=no
            [filter]
                [filter_location]
                    terrain=*^Cov
                [/filter_location]
                side=2
            [/filter]
            [filter_condition]
                [have_unit]
                    id=Seth
                [/have_unit]
            [/filter_condition]
            [allow_undo][/allow_undo]
            [remove_item]
                x,y=$seth.x|,$seth.y|
            [/remove_item]
            # this was used during debug?
            #            [wml_message]
            #                logger=err
            #                message=_"looking for seth.x"
            #            [/wml_message]
            [terrain] # trying to clear the castle/keep overlays
                terrain=Ds
                layer=overlay
                [and]
                    terrain=*^Kov,*^Cov
                [/and]
            [/terrain]
            {CLEAR_VARIABLE seth}
        [/event]
        [event]
            name=last_breath
            [filter]
                id=Seth
            [/filter]
            [message]
                speaker=Seth
                message=_"You are stronger than I gave you credit for..."
            [/message]
            [kill]
                id=Seth
                animate=yes
            [/kill]
            [message]
                speaker=Haldrad
                message=_"The evil one is defeated!  Secure your positions, we need to get back to the Sky Mountain and be rid of this place!"
            [/message]
            # a hack to get rid of the time-stop jewel objects
            [event]
                name=new turn
                [endlevel]
                    result=victory
                [/endlevel]
            [/event]
        [/event]
        [event]
            name=last_breath
            [filter]
                id=Haldrad, Ponce, Lyron
            [/filter]
            [message]
                speaker=unit
                message=_"Uhg... My journey ends here..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/scenario]
