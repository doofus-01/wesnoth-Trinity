#textdomain wesnoth-Trinity

[scenario]
    id="Dark_Planet_1b"
    name= _ "Dark Planet - Mechanical Guard"
    map_data="{~add-ons/Trinity/maps/Dark_Planet2.map}"
    next_scenario=Dark_Planet_2
    victory_when_enemies_defeated=no
    turns=-1
    #	{TURNS 8 10 12}

    [music]
        name="New_Wesnoth_Battle_Music.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    {BMR_STORE_SIDE 3}
    {BMR_RESTORE_SIDE 1}
    {BMR_RESTORE_SIDE 3}
    {BMR_RESTORE_SIDE 5}
    {TRINITY_DP_SCHEDULE}
    [story]
        [part]
            story= _ "Prince Haldrad's forces regrouped at the ice mountain, as that was the only path to safe retreat."
#            [background_layer]
#                image="story/Trinity_DP1.jpg"
#            [/background_layer]
        [/part]
    [/story]

    ###############################################
    # Sides - not all of these sides are relevant for this scenario, but they will be later
    ###############################################
    # Haldrad
    [side]
        type=Spearman
        id=Fooby1
        name= _ "Haldrad"
        side=1
        canrecruit=yes
        controller=human
        fog=no
        shroud=yes
        scroll_to_leader=no
        recruit="Spearman,Bowman,Peasant,Ruffian,Heavy Infantryman"
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 10 7 4}
        {GOLD 390 270 160}
        team_name=Human
        [village]
            x,y=64,57
        [/village]
    [/side]

    # phantoms, lower
    [side]
        no_leader=yes
        side=2
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
    [/side]

    # Bresda & Dardrus
    [side]
        type=Spearman
        id=Fooby3
        name= _ "Dardrus"
        side=3
        canrecruit=yes
        controller=human
        recall_cost=10
        fog=no
        shroud=yes
        recruit=""
        {INCOME 10 7 4}
        {GOLD 360 250 150}
        team_name=Primeval
    [/side]

    # Mechs, lower
    [side]
        no_leader=yes
        side=4
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
    [/side]

    # Keldan
    [side]
        type=Spearman
        id=Fooby5
        name= _ "Keldan"
        side=5
        canrecruit=yes
        controller=ai
        fog=no
        shroud=yes
        recruit="Elvish Fighter,Elvish Archer, Elvish Shaman, Elvish Scout"
        recall_cost=10
        {INCOME 4 7 10}
        {GOLD 100 120 160}
        team_name=Human
        [village]
            x,y=23,27
        [/village]
        [village]
            x,y=25,32
        [/village]
    [/side]

    # Mechs, upper
    [side]
        no_leader=yes
        side=6
        controller=ai
        fog=no
        shroud=no
        team_name=Phantom
        [ai]
            aggression=0.8
        [/ai]
        [unit]
            type=Tri_Mech_Drone
            x,y=25,28
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            x,y=25,28
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            x,y=25,36
        [/unit]
    [/side]

    ##########################################################
    # teleport pads, to cut down on the slogging across the map
    # in an event below, but I leave these because I think it helps with usability.
    ##########################################################
    # west
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,62
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,62
        [/teleport]
    [/event]
    # east
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=64,50
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=36,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=36,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=64,50
        [/teleport]
    [/event]
    #######################################

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Find a way into the enemy stronghold"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lyron"
            [/objective]
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Find a way into the enemy stronghold"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
        [terrain]
            terrain=Qxu^Scfz
            x=50,49-51
            y=35,36
        [/terrain]
        [unit]
            side=6
            type=Mechanical Dragon
            id=Mech_D
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=48,38
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=38,32
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=40,29
            facing=nw
        [/unit]
        [unit]
            side=6
            type=Tri_Mech_Defender
            x,y=37,42
            facing=nw
        [/unit]
        [recall]
            side=5
            level=2
        [/recall]
        {TELEPORT_UNIT (
             side=5
             level=2
        ) 36 31 }
        [recall]
            side=5
            level=1
        [/recall]
        {TELEPORT_UNIT (
             side=5
             level=1
        ) 36 31 }
        {TELEPORT_UNIT id=Keldan 35 32 }
        [recall]
            side=5
            level=1
            race=thrall_khthon
            x,y=25,29
        [/recall]
        [recall]
            side=5
            level=1
            race=thrall_khthon
            x,y=39,29
        [/recall]
        [recall]
            id=Kerrnyn
        [/recall]
        [recall]
            id=E_Caldera
        [/recall]
        [recall]
            id=Ponce
        [/recall]
        [recall]
            id=Lyron
        [/recall]
        {MODIFY_UNIT (side=3
        [not]
            canrecruit=yes
        [/not]) facing se}
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=34,21
        [/item]
        [item]
            halo=units/gun-a-s.png
            x,y=40,23
        [/item]
        [item]
            halo=units/gun-a-s.png
            x,y=19,24
        [/item]
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=52,34
        [/item]
        [item]
            halo=units/gun-a.png~FL(horiz)
            x,y=62,22
        [/item]
        [remove_shroud]
            side=1,3,5
            x,y=1-68,1-68
        [/remove_shroud]
        # sw structure
        [place_shroud]
            side=1,3,5
            x=3-13,4-11,5-12
            y=60-66,59,67
        [/place_shroud]
        # big structure
        [place_shroud]
            side=1,3,5
            x=19-35,40-47,48-53,54-56,13-18
            y=1-11,8-20,15-23,18-22,11-18
        [/place_shroud]
        [tunnel]
            id=tunnel_west
            bidirectional=yes
            [source]
                x,y=22,62
            [/source]
            [target]
                x,y=22,15
            [/target]
            [filter]
            [/filter]
        [/tunnel]
        [tunnel]
            id=tunnel_east
            bidirectional=yes
            [source]
                x,y=64,50
            [/source]
            [target]
                x,y=36,15
            [/target]
            [filter]
            [/filter]
        [/tunnel]
    [/event]

#######################
# events for side 5
    {ARCHAIC_KHTHON_RECRUITS (
        side=5
        [not]
            race=khthon
        [/not]
    )}

    # save the khthon for later
    [event]
        name=die
        first_time_only=no
        [filter]
            side=5
            canrecruit=no
        [/filter]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            mode=append
            variable=keldan_khthon_list
        [/store_unit]
    [/event]

# end side 5 events
###################

    [event]
        name=start
# choose the right music
#        [music]
#            name="casualties_of_war.ogg"
#            immediate=yes
#            append=no
#        [/music]
# this shouldn't be needed
#ifdef __UNUSED__
        [if]
            [have_unit]
                id=Keldan
            [/have_unit]
            [else]
                [unit]
                    side=5
                    type=Keldan
                    name=Keldan
                    id=Keldan
                    canrecruit=yes
                    x,y=35,32
                    experience=35
                [/unit]
            [/else]
        [/if]
#endif
        #################################################################
        # recall/leaders for side 3 were also screwed up, this is a patch
        # the tower scenario needs to be fixed
        #################################################################

        [recall]
            id=Bresda
        [/recall]
        [recall]
            id=Dardrus
        [/recall]
        {FOREACH leader_3 index}
            [if]
                [have_unit]
                    id=$leader_3[$index].id
                [/have_unit]
                [then]
                    {CLEAR_VARIABLE leader_3[$index]}
                [/then]
                [else]
                    [unstore_unit]
                        variable=leader_3[$index]
                        x,y=7,63
                        find_vacant=yes
                    [/unstore_unit]
                [/else]
            [/if]
        {NEXT index}
        {MODIFY_UNIT (canrecruit=yes
        side=3
        [not]
            id=Bresda,Dardrus
        [/not]) canrecruit no}
        # we are no longer in the Tower
        [disallow_extra_recruit]
            id=Bresda
            extra_recruit=Tower Ladyboy
        [/disallow_extra_recruit]
        [store_unit]
            [filter]
                id=Dardrus
            [/filter]
            variable=dardrus
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Bresda
            [/filter]
            variable=bresda
            kill=yes
        [/store_unit]
        {PUT_TO_RECALL_LIST (side=3)}
        #################################################################
        #################################################################

        {MODIFY_UNIT (id=Keldan) facing se}
        [message]
            speaker=Keldan
            message= _ "Ah, your're back, I thought you'd abandoned me!"
        [/message]
        [message]
            speaker=E_Caldera
            message= _ "The Crown of Weldyn would never abandon an ally in a battle!"
        [/message]
        {MODIFY_UNIT (id=Haldrad) facing nw}
        [message]
            speaker=Haldrad
            message= _ "We have to consider fleeing, you might want to make your way here, Elf."
        [/message]
        [message]
            speaker=Kerrnyn
            message= _ "How can you even contemplate bringing <i>them</i> with us?!"
        [/message]
        {MODIFY_UNIT (id=Ponce) facing nw}
        [message]
            speaker=Ponce
            message= _ "These are strange times, my friend.  We can't take on everyone at once, just be patient."
        [/message]
        [message]
            speaker=E_Caldera
            message= _ "We are shaken because this enemy is so strange, but let's probe the defenses a bit more.  We defeated their phantom army, why would they need that if the second wave was so strong?"
        [/message]
        [message]
            speaker=Lyron
            message= _ "Be very careful, Prince, I suspect all is not as it seems.  And I don't mean the enemy out there."
        [/message]
        [message]
            speaker=E_Caldera
            message= _ "Just what do you mean, Advisor?"
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Enough!  We'll continue to push onward, but we'll be ready to flee."
        [/message]
    [/event]

    [event]
        name=side 3 turn
        [unstore_unit]
            variable=dardrus
        [/unstore_unit]
        [unstore_unit]
            variable=bresda
        [/unstore_unit]
        {CLEAR_VARIABLE dardrus}
        {CLEAR_VARIABLE bresda}
        [music]
            name=legends_of_the_north.ogg
            immediate=yes
            append=yes
        [/music]
        [item]
            image=scenery/summoning-center.png
            x,y=8,64
        [/item]
        [remove_shroud]
            side=1,3,5
            x,y=2-14,57-68
        [/remove_shroud]
        [recall]
            side=3
        [/recall]
        [unit]
            side=3
            type=Primeval Swiftfoot
            id=Tanyche
            name=Tanyche
            profile=portraits/tanyche.png
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
            x,y=5,67
            facing=ne
        [/unit]
        [redraw]
            side=3
        [/redraw]
        [message]
            speaker=Bresda
            message=_"Where are we?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"I don't know, but I recognize some of the architecture.  This is territory of The Pantheon, or at least it once was."
        [/message]
        {MODIFY_UNIT (id=Bresda) facing se}
        [message]
            speaker=Bresda
            message=_"That's fascinating..."
        [/message]
        {MOVE_UNIT (id=Bresda) 12 66}
        {MODIFY_UNIT (id=Bresda) facing se}
        [message]
            speaker=Bresda
            message=_"How do we open these doors and get out?"
        [/message]
        [message]
            speaker=Tanyche
            message=_"You have come!  Let us be on our way!"
        [/message]
        {MOVE_UNIT (id=Tanyche) 13 66}
        [set_variable]
            name=gate1_open
            value=yes
        [/set_variable]
        [terrain]
            terrain=Urb
            x=13,14
            y=67,66
        [/terrain]
        [redraw][/redraw]
        [message]
            speaker=Dardrus
            message=_"Who are you?"
        [/message]
        [message]
            speaker=Tanyche
            message=_"Why, I am the scout to guide you, the vanguard of our revenge against the pilot!"
        [/message]
        [message]
            speaker=Bresda
            message=_"(Dardrus, what is she talking about?)"
        [/message]
        [message]
            speaker=Dardrus
            message=_"(I have no idea...)"
        [/message]
        [message]
            speaker=Tanyche
            message=_"What are you waiting for?  You <i>are</i> our vanguard, are you not?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Yes, of course we are!  Now, let us find and destroy this ... pilot."
        [/message]
        [message]
            speaker=Tanyche
            message=_"We'll need to get to the lower level of the main structure to the north."
        [/message]
    [/event]

    [event]
        name=enter_hex
        [filter]
            id=Tanyche
            x=20
        [/filter]
        [message]
            speaker=Tanyche
            message=_"Those wooden patches will transport you somewhere distant, if you stand on it and stop moving.  This one will take us to the main structure."
        [/message]
        [message]
            speaker=Dardrus
            message=_"Yes, we have recently seen such things."
        [/message]
    [/event]

    [event]
        name=side 1 turn
        [filter_condition]
            [have_unit]
                id=Dardrus
            [/have_unit]
        [/filter_condition]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=68,68
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=42,68
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=68,50
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=50,68
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=16,61
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=15,61
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=17,61
        [/unit]
        [unit]
            side=2
            type=Tomb Stalker
            x,y=27,68
        [/unit]
        [message]
            speaker=E_Caldera
            message=_"So, my red-eyed enemies are here...  <i>Keldan, we will soon be trapped between a hammer and an anvil, if we don't act now...</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"<i>Yes, Echidna.  What do you wish me to do?</i>"
        [/message]
        [terrain]
            terrain=Ce
            x,y=63,59
        [/terrain]
        [message]
            speaker=E_Caldera
            message=_"<i>Create a distraction, just like when we destroyed the human capital.</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"<i>Yes, Echidna, as you command...</i>"
        [/message]
        [message]
            speaker=Keldan
            message=_"So, Red-eyed daemon!  You have joined our little adventure!  No doubt you have come to the aid of your evil master!  Prince, we must destroy these newcomers!"
        [/message]
        [kill]
            id=E_Caldera
            animate=no
            fire_event=no
        [/kill]
        [message]
            speaker=Bresda
            message=_"(What is <i>he</i> doing here?)"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Prince Haldrad!  Don't be fooled, we are not enemies!  It is the green-eyed ones such as him that are not to be trusted."
        [/message]
        [message]
            speaker=Haldrad
            message=_"It has been a while, Dardrus, and you did leave me in prison.  But should I trust you any less than these evil elves?"
        [/message]
        [message]
            speaker=Ponce
            message=_"Speaking of 'trust', where did the Queen go?"
        [/message]
        [unit]
            side=5
            type=AR_Owl
            x,y=66,64
            facing=nw
        [/unit]
        [unit]
            side=5
            type=AR_Owl
            x,y=68,64
            facing=nw
        [/unit]
        [unit]
            side=5
            type=AR_LittleThing
            x,y=67,63
            facing=nw
        [/unit]
        [unit]
            side=5
            type=Weasadillo
            x,y=67,64
            facing=nw
        [/unit]
        {ARCHAIC_KHTHONIZED (x=66,68,67,67
        y=64,64,63,64)}
        [music]
            name=In_the_Land_of_Madness.ogg
            append=no
            immediate=yes
        [/music]
# need to push away any side 1 units trying to block this
        [terrain]
            terrain=Ke
            x,y=68,63
        [/terrain]
        [terrain]
            terrain=Ce
            x=68,68,67
            y=62,64,63-64
        [/terrain]
        [redraw]
            side=1
        [/redraw]
        [unit]
            side=5
            type=Echidna_Queen
            x,y=68,63
            id=Echidna
            name=Echidna
            facing=nw
            canrecruit=yes
        [/unit]
        [message]
            speaker=Echidna
            message=_"I'm right here!  I need this Sceptre, <i>my son</i>, you shall soon understand."
        [/message]
        [message]
            speaker=Haldrad
            message=_"So, I must now slay my own mother.  Fate can be cruel..."
        [/message]
        [message]
            speaker=narrator
            message=_"Some of the light seemed to go out of Echidna's eyes as she heard Haldrad's words.  Maybe it was because some fragment of Queen Caldera remained, maybe it was because Echidna saw herself as a mother, or maybe it was some other reason that would only make sense to the Khthon.  In any case, Echidna lost some of her haughty attitude."
        [/message]
        [message]
            speaker=Echidna
            message=_"Yes, yes it can.  I'm sorry, my child, but I cannot let you get in the way of our better world.  A world full of life, and free of all the schemes of factions, free of the iron yoke of consciousness!"
        [/message]
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "No, Echidna...  Such corruption as that can never be!  You shall join me..."
        [/message]
        {MODIFY_UNIT (id=Echidna) facing nw}
        [message]
            speaker=Echidna
            message=_"You've made a mistake in your little game, Seth!  You thought to lure me in, but you are getting weaker, while I've grown stronger!"
        [/message]
        [set_recruit]
            side=5
            recruit=""
        [/set_recruit]
        [set_extra_recruit]
            id=Keldan
            extra_recruit="Elvish Fighter,Elvish Archer, Elvish Shaman, Elvish Scout"
        [/set_extra_recruit]
        [set_extra_recruit]
            id=Echidna
            extra_recruit="Spearman,Bowman,Horse,Peasant,Ruffian"
        [/set_extra_recruit]
        [gold]
            side=5
            amount=320
        [/gold]
        [modify_side]
            side=1
            controller=human
            team_name=Primeval
        [/modify_side]
        [modify_side]
            side=5
            controller=ai
            team_name=Khthon
        [/modify_side]
        [music]
            name=New_Wesnoth_Battle_Music.ogg
            append=no
            immediate=no
        [/music]
        [music]
            name=siege_of_laurelmor.ogg
            append=yes
            immediate=no
        [/music]
        [message]
            speaker=Haldrad
            message=_"Our troops can't join us in this battle while she's blocking the path out of the mountain..."
        [/message]
        [message]
            speaker=Lyron
            message=_"Everyone, protect the King!"
        [/message]
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Defeat Khthon Leaders and regain the Sceptre"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lyron"
            [/objective]
            note=_"The Khthon will not attack side 1 for a few turns, unless side 1 attacks them."
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Defeat Khthon Leaders and regain the Sceptre"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Mech_D
            [not]
                x,y=49-51,35-36
            [/not]
        [/filter]
        [terrain]
            terrain=Qxu^Scoz
            x=50,49-51
            y=35,36
        [/terrain]
        [set_variable]
            name=spawn_side_6
            value=yes
        [/set_variable]
        [redraw]
            side=1
        [/redraw]                   
    [/event]

    [event]
        # this mimics a recruiting side, the spawning stops once there are a certain number of units on the map
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=spawn_side_6
                equals=yes
            [/variable]
        [/filter_condition]
        [set_variable]
            name=mech_type
            rand=Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Defender,Tri_Mech_Defender,Tri_Mech_Sentinel
        [/set_variable]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=49,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            type=$mech_type
            side=6
            x,y=50,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            side=6
            x,y=51,36
            facing=nw
        [/unit]
        {CLEAR_VARIABLE mech_type}
        [if]
            [have_unit]
                side=6
                count=9-99 # this can be changed, for difficulty levels and balancing
            [/have_unit]
            [then]
                {CLEAR_VARIABLE spawn_side_6}
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=6
        [/filter]
        [if]
            [have_unit]
                side=6
                count=0,1,2,3,4
            [/have_unit]
            [then]
                [set_variable]
                    name=spawn_side_6
                    value=yes
                [/set_variable]
            [/then]
        [/if]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Keldan
        [/filter]
        [message]
            speaker=unit
            message=_"So this is the end...  I'll never know..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"No doubt he was a good man back when he was an elf, but the elves have suffered a very strange illness.  I hope that in death, they find peace and freedom from the green-eyed daemons."
        [/message]
        [message]
            speaker=Echidna
            message=_"We are not <i>daemons!</i>  But you are sad little animals, and your silly little kingdoms fold when confronted, just like how my dear Seth's little circus-show is now collapsing!"
        [/message]
        [message]
            speaker=unit
            message=_"No...  Don't be fooled...  Seth will win...  unless you destroy...  the source."
        [/message]
        [message]
            speaker=Haldrad
            message=_"What source, where?  What are you saying?"
        [/message]
        [message]
            speaker=unit
            message=_"Underground... <i>*gasp!*</i> ..."
        [/message]
        # FLAG
        [message]
            speaker=narrator
            image=portraits/seth.png~O(0.5)
            caption=Seth
            message= _ "Hahaha...  Nice try, Keldan, but you shall pay for that!  And you cannot escape your service to me by death, we had a deal..."
        [/message]
        [item]
            halo="halo/holy/light-beam-[1~6,2,5].png~CS(-100,-150,10):[80*8]"
            x,y=$x1,$y1
        [/item]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=unit
            message=_"I never made...  deal...  damn you..."
        [/message]
        [delay]
            time=100
        [/delay]
        [kill]
            id=Keldan
            animate=yes
        [/kill]
        [remove_item]
            halo="halo/holy/light-beam-[1~6,2,5].png~CS(-100,-150,10):[80*8]"
            x,y=$x1,$y1
        [/remove_item]
        [message]
            speaker=Haldrad
            message=_"That was creepy...  But, it seems we need to destroy something underground."
        [/message]
        [message]
            speaker=second_unit
            message=_"Or it is a trap, his last attempt to harm us."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Hrmm..."
        [/message]
        # this wasn't tested, hopefully it doesn't sound too cheesy in context.  In any case, I felt something more was needed.
        [message]
            speaker=second_unit
            message=_"We've defeated the pretenders wearing friendly faces, isn't that enough?  We are on some rock up in the sky, we don't belong here..."
        [/message]
        [message]
            speaker=Dardrus
            message= _ "But there will be more pretenders to haunt us if we leave and let these odd fellows regroup.  Let us finish this here and now."
        [/message]
        [message]
            speaker=Bresda
            message= _ "Yes, this world needs to be cleansed!  In the name of Ishtu!"
        [/message]
        [message]
            speaker=Kerrnyn
            message= _ "In the name of Ishtu!"
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Have no doubt, we'll defeat this foe...  This Mister Seth...  Keep your eyes open, we know he does not play fair."
        [/message]
        [set_variable]
            name=spawn_side_6
            value=yes
        [/set_variable]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Echidna
        [/filter]
        [message]
            speaker=unit
            message=_"This is not the end of me..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"Sure looks like the end to me!"
        [/message]
        [message]
            speaker=Dardrus
            message=_"I wouldn't be so sure, Prince Haldrad.  Keep your guard up!"
        [/message]
        #    [set_variable]
        #        name=gateB_open
        #        value=yes
        #    [/set_variable]
        #    [set_variable]
        #        name=gateE_open
        #        value=yes
        #    [/set_variable]
        [kill]
            id=Echidna
            animate=yes
        [/kill]
        [item]
            image=items/sceptre-of-fire.png
            x,y=$x1,$y1
        [/item]
        # there is probably a more elegant way to deal with this, but let's worry about that later
        [set_variable]
            name=sceptre_x
            value=$x1
        [/set_variable]
        [set_variable]
            name=sceptre_y
            value=$y1
        [/set_variable]
        [event]
            name=moveto
            [filter]
                side=1,3
                x,y=$sceptre_x|,$sceptre_y|
            [/filter]
            [if]
                [variable]
                    name=unit.side
                    equals=3
                [/variable]
                [then]
                    [message]
                        speaker=unit
                        message=_"This mighty wand can shoot explosive fire, I've seen it with my own eyes!  We'll fry the enemy now!"
                    [/message]
                    [message]
                        speaker=Haldrad
                        message=_"We could do that, but that thing also attracts all sorts of attention, and if we lose it, we can't go home.  We need to keep it hidden."
                    [/message]
                    [message]
                        speaker=unit
                        message=_"Right, I see.  I'll pass it along as soon as I can."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Haldrad
                        message=_"We need the Sceptre to power the flying mountain to get home.  It's a powerful weapon, but we'll need to keep it hidden for now."
                    [/message]
                [/else]
            [/if]
            [message]
                speaker=Haldrad
                message=_"Now we have to focus our efforts on defeating the lord of this strange world, lest it come back to attack us again."
            [/message]
            [remove_item]
                x,y=$sceptre_x|,$sceptre_y|
                image=items/sceptre-of-fire.png
            [/remove_item]
            [set_variable]
                name=spawn_side_6
                value=yes
            [/set_variable]
        [/event]
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Find and Defeat Seth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Lyron"
            [/objective]
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Find and Defeat Seth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
        [/objectives]
    [/event]

# Tristien shows up, player has to flee underground
    [event]
        #       name=turn 2
        # # ifdef __UNUSED__
        name=new_turn
        [filter_condition]
            [and]
                [not]
                    [have_unit]
                        id=Echidna
                    [/have_unit]
                [/not]
            [/and]
            [and]
                [not]
                    [have_unit]
                        id=Keldan
                    [/have_unit]
                [/not]
            [/and]
        [/filter_condition]
        # # endif
        [unit]
            x,y=24,21
            id=Tristien
            type=Tri_Cyan_Cyborg
            name=Tristien
            side=6
            facing=se
        [/unit]
        [terrain]
            terrain=Qxu^Scoz
            x=50,49-51
            y=35,36
        [/terrain]
        [music]
            name=vengeful.ogg
            append=no
            immediate=yes
        [/music]
        [message]
            speaker=Tristien
            message=_"<i>Remember me?!</i>  I've been given a chance to show you how wrong you were to reject our master!"
        [/message]
        [store_unit]
            [filter]
                id=Tristien
            [/filter]
            kill=no
            variable=temp_animtest
        [/store_unit]
        [set_variable]
            name=temp_animtest.experience
            value=200
        [/set_variable]
        [unstore_unit]
            variable=temp_animtest
            find_vacant=no
            advance=yes
        [/unstore_unit]
        {CLEAR_VARIABLE temp_animtest}
        [remove_item]
            x,y=52,34
        [/remove_item]
        [remove_item]
            x,y=34,21
        [/remove_item]
        [remove_item]
            x,y=40,23
        [/remove_item]
        [remove_item]
            x,y=19,24
        [/remove_item]
        [remove_item]
            x,y=62,22
        [/remove_item]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun0
            side=6
            x,y=52,34
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun1
            side=6
            x,y=34,21
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun2
            side=6
            x,y=40,23
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun3
            side=6
            x,y=19,24
        [/unit]
        [unit]
            type=Tri_Mech_Arty_Gun_a
            id=Gun3
            side=6
            x,y=62,22
        [/unit]
        [message]
            speaker=Tristien
            message=_"My people could have crushed you like the primitive heathens you are, yet even we were nothing compared to Seth...  And now, well, enough talk!"
        [/message]

        [micro_ai]
            side=6
            ai_type=goto
            action=add
            ca_id=tris1
            [filter]
                id=Tristien
            [/filter]
            [filter_location]
                x,y=25,63
            [/filter_location]
        [/micro_ai]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=25,63
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=64,50
                [/filter_location]
            [/micro_ai]
        [/event]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=64,50
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=46,29
                [/filter_location]
            [/micro_ai]
        [/event]
        [event]
            name=enter_hex
            first_time_only=no
            [filter]
                id=Tristien
                x,y=46,29
            [/filter]
            [allow_undo][/allow_undo]
            [micro_ai]
                side=6
                ai_type=goto
                action=change
                ca_id=tris1
                [filter]
                    id=Tristien
                [/filter]
                [filter_location]
                    x,y=25,63
                [/filter_location]
            [/micro_ai]
        [/event]
    [/event]

    [event]
        name=last breath
        [filter]
            canrecruit=yes
            [filter_side]
                controller=human
            [/filter_side]
            [not]
                id=$temp_leader_id
            [/not]
        [/filter]
        [message]
            speaker=unit
            message=_"Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=E_Caldera,Ponce,Lyron
        [/filter]
        [message]
            speaker=unit
            message=_"Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        # testing
        #	name=turn 3
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                id=Tristien
            [/have_unit]
            [not]
                [variable]
                    name=run_dialog
                    equals=yes
                [/variable]
            [/not]
        [/filter_condition]
        [set_variable]
            name=mech_type
            rand=Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Drone,Tri_Mech_Defender,Tri_Mech_Defender,Tri_Mech_Sentinel
        [/set_variable]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=49,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            side=6
            x,y=50,35
            facing=nw
        [/unit]
        [unit]
            type=$mech_type
            side=6
            x,y=50,36
            facing=nw
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            side=6
            x,y=51,36
            facing=nw
        [/unit]
        {CLEAR_VARIABLE mech_type}
        [if]
            [have_unit]
                side=6
                # testing
                #		 count=2-99
                count=12-99 # this may need adjustment
            [/have_unit]
            [then]
                [set_variable]
                    name=run_dialog
                    value=yes
                [/set_variable]
                [message]
                    speaker=Ponce
                    message=_"We are just going to get overwhelmed by these machines if we stay here - I don't see how we can defeat them!"
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"You're right...  We need to get into Seth's compound and take this fight to him!  Everyone, head to the large building, we're going in!"
                [/message]
                [message]
                    speaker=Dardrus
                    message=_"Prince!  There is that smaller building that also has passage to the underground, shouldn't some of us check that out as well?"
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"I don't like the idea of splitting our forces, but it might be for the best, since we don't know the layout of Seth's lair...  Very well, you take the small compound, I'll take the larger one."
                [/message]
                [objectives]
                    side=1
                    [objective]
                        condition=win
                        description=_ "Haldrad reaches north-most stairwell (red-ringed indicator image - may be hidden by shroud)"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Haldrad"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Ponce"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Lyron"
                    [/objective]
                    note=_"Any unit from Side 3 that goes to the north-most stairwell before Haldrad will join Side 1."
                [/objectives]
                [objectives]
                    side=3
                    [objective]
                        condition=win
                        description=_ "Dardrus or Bresda reaches east-most stairwell (green-ringed indicator image)"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Dardrus"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Death of Bresda"
                    [/objective]
                    note=_"Any unit from Side 1 that goes to the east-most stairwell before Dardrus or Bresda will join Side 3."
                [/objectives]
                [item]
                    image=items/gohere.png
                    x,y=28,2
                [/item]
                [item]
                    image=items/gohere.png~RC(ellipse_red > green)
                    x,y=66,44
                [/item]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=28,1-2
                        side=1
                        canrecruit=yes
                    [/filter]
                    [if]
                        [have_unit]
                            x,y=66,43-44
                            side=3
                            canrecruit=yes
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message=_"Now, let us put an end to that evil Seth!"
                            [/message]
                            [message]
                                x,y=66,43-44
                                message=_"We are in position.  Fate be with you!"
                            [/message]
                            [endlevel]
                                {CONTINUE}
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
                                speaker=unit
                                message=_"Hurry up!  We need to storm the lower level at the same time, lest the first give away the element of surprise for the second."
                            [/message]
                            [message]
                                speaker=Bresda
                                message=_"We are trying!"
                            [/message]
                        [/else]
                    [/if]
                [/event]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=66,43-44
                        side=3
                        canrecruit=yes
                    [/filter]
                    [if]
                        [have_unit]
                            x,y=28,1-2
                            side=1
                            canrecruit=yes
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message=_"Now, let us put an end to that evil Seth!"
                            [/message]
                            [message]
                                x,y=28,1-2
                                message=_"We are in position.  Fate be with you!"
                            [/message]
                            [endlevel]
                                {CONTINUE}
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
                                speaker=unit
                                message=_"Hurry up!  We need to storm the lower level at the same time, lest the first give away the element of surprise for the second."
                            [/message]
                            [message]
                                speaker=Haldrad
                                message=_"We are trying!"
                            [/message]
                        [/else]
                    [/if]
                [/event]
                [event] # put to recall list of side 3
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=28,1-2
                        side=1,3
                        [not]
                            canrecruit=yes
                        [/not]
                    [/filter]
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=ptr1
                        kill=yes
                    [/store_unit]
                    [set_variable]
                        name=ptr1.side
                        value=1
                    [/set_variable]
                    [set_variable]
                        name=ptr1.x
                        value=recall
                    [/set_variable]
                    [set_variable]
                        name=ptr1.y
                        value=recall
                    [/set_variable]
                    [unstore_unit]
                        variable=ptr1
                        find_vacant=no
                    [/unstore_unit]
                    {CLEAR_VARIABLE ptr1}
                [/event]
                [event] # put to recall list of side 3
                    name=moveto
                    first_time_only=no
                    [filter]
                        x,y=66,43-44
                        side=1,3
                        [not]
                            canrecruit=yes
                        [/not]
                    [/filter]
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=ptr3
                        kill=yes
                    [/store_unit]
                    [set_variable]
                        name=ptr3.side
                        value=3
                    [/set_variable]
                    [set_variable]
                        name=ptr3.x
                        value=recall
                    [/set_variable]
                    [set_variable]
                        name=ptr3.y
                        value=recall
                    [/set_variable]
                    [unstore_unit]
                        variable=ptr3
                        find_vacant=no
                    [/unstore_unit]
                    {CLEAR_VARIABLE ptr3}
                [/event]
            [/then]
        [/if]
    [/event]
[/scenario]
