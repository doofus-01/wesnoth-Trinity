#textdomain wesnoth-Trinity

[scenario]
    id="Tower_3_Pb"
    name= _ "A Different Triumph"
    map_data="{~add-ons/Trinity/maps/Sky_Mountain4.map}"
    next_scenario=Tower_3_Pb2
    victory_when_enemies_defeated=no
    {TURNS 6 10 12}

    [music]
        name="New_Wesnoth_Battle_Music.ogg"
    [/music]

    #    {BMR_STORE_SIDE 1}
    #    {BMR_RESTORE_SIDE 1}
    {DAWN}
    [story]
        [part]
            story= _ "As Keldan fell into the cold clutches of Seth, the flying mountain drifted closer to the ominous tower.  Within the mountain, Echidna was busy trying to tie up a loose end..."
            background="story/Trinity_tower_crash0.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Survive to end of turns"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Kerrnyn"
            [/objective]
        [/objectives]
        [store_unit]
            [filter]
                id=Kerrnyn
            [/filter]
            variable=kerrnyn
            kill=no
        [/store_unit]
        [music]
            name="New_Wesnoth_Battle_Music.ogg"
            append=no
            immediate=yes
        [/music]
        [item]
            image=items/sword.png
            x,y=3,8
        [/item]
        [event]
            name=moveto
            [filter]
                id=Kerrnyn
                x,y=3,8
            [/filter]
            [object]
                name=_"Silver Sword"
                image=items/sword.png
                [effect]
                    [filter]
                        id=Kerrnyn
                    [/filter]
                    apply_to=attack
                    range=melee
                    increase_damage=2
                    set_parry=10
                [/effect]
                [then]
                    [remove_item]
                        image=items/sword.png
                        x,y=3,8
                    [/remove_item]
                [/then]
            [/object]
            [message]
                speaker=narrator
                image=attacks/sword-holy.png~SCALE(240,240)
                caption=_"Silver Sword"
                message= _ "Kerrnyn picked the sword up from the frigid tile floor, noting its fine craftsmanship and perfect balance.  It was a much finer blade than anything a human could have forged, it was a gift from the gods."
            [/message]
            [message]
                speaker=Kerrnyn
                message= _ "Thank you, My Goddess..."
            [/message]
        [/event]
    [/event]

    [side]
        side=1
        no_leader=yes
        controller=ai
        fog=no
        team_name=Other
        [ai]
            caution=.5
            [goal]
                name=target
                [criteria]
                    side=2
                [/criteria]
                value=90
            [/goal]
            [goal]
                name=target
                [criteria]
                    side=3
                [/criteria]
                value=1
            [/goal]
        [/ai]
        [unit]
            type=AR_Owl
            x,y=18,20
        [/unit]
        [unit]
            type=Weasadillo
            x,y=2,5
            [modifications]
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        [unit]
            type=AR_LittleThing
            x,y=30,21
        [/unit]
        [unit]
            type=AR_Owl
            id=Owl1
            x,y=16,2
        [/unit]
        [unit]
            type=AR_Owl
            x,y=11,2
        [/unit]
        [unit]
            type=AR_Owl
            x,y=14,14
        [/unit]
        [unit]
            type=AR_Owl
            x,y=15,21
        [/unit]
        [unit]
            type=Weasadillo
            x,y=12,20
        [/unit]
        [unit]
            type=AR_LittleThing
            x,y=21,21
        [/unit]
        [unit]
            type=Weasadillo
            x,y=20,12
        [/unit]
    [/side]

    [side]
        type=Seaman_Khthon
        name="Echidna"
        id=Echidna_
        facing=sw
        side=2
        canrecruit=yes
        recruit=""
        controller=ai
        fog=no
        team_name=Khthon
        [ai]
            [goal]
                name=target
                [criteria]
                    id=Kerrnyn
                [/criteria]
                value=5
            [/goal]
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=7
            [/goal]
            [goal]
                name=target_location
                [criteria]
                    x,y=$kerrnyn.x|,$kerrnyn.y|
                [/criteria]
                value=10
            [/goal]
        [/ai]
    [/side]

    [side]
        type=Kerrnyn
        name="Kerrnyn"
        id=Kerrnyn
        facing=ne
        [modifications]
            {ARCHAIC_TRAIT_ZEALOUS}
            {ARCHAIC_TRAIT_FEARLESS2}
        [/modifications]
        side=3
        canrecruit=yes
        recruit=""
        controller=human
        fog=yes
        team_name=Primeval
    [/side]

    # band-aid - which doesn't even seem to work anyway, so screw it.
    #    {FORCE_CHANCE_TO_HIT (side=1) (id=Kerrnyn) 25 ()}

    [event]
        name=start
        [lift_fog]
            side=3
            x,y=13-30,1-5
        [/lift_fog]
        [message]
            speaker=Echidna_
            message= _ "Come here!"
        [/message]
        [message]
            speaker=Kerrnyn
            message= _ "Hah!  I'm not so stupid, you daemon!"
        [/message]
        {MOVE_UNIT (id=Kerrnyn) 17 3}
        {MODIFY_UNIT (id=Kerrnyn) facing nw}
        [message]
            speaker=Echidna_
            message= _ "I've slain your beloved 'goddess', you cannot hope to prevail..."
        [/message]
        {MOVE_UNIT (id=Echidna_) 23 4}
        {MODIFY_UNIT (id=Echidna_) facing nw}
        [message]
            speaker=Echidna_
            message= _ "You are simply wasting time!"
        [/message]
        {MOVE_UNIT (id=Echidna_) 20 4}
        {MODIFY_UNIT (id=Echidna_) facing nw}
        {MOVE_UNIT (id=Kerrnyn) 10 5}
        {MODIFY_UNIT (id=Kerrnyn) facing ne}
        [message]
            speaker=Kerrnyn
            message= _ "If wasting your time is what I can do, then I will waste your time!"
        [/message]
        {MOVE_UNIT (id=Echidna_) 17 4}
        {MODIFY_UNIT (id=Echidna_) facing sw}
        [message]
            speaker=Echidna_
            message= _ "(*<i>snarl</i>*)"
        [/message]
        {MOVE_UNIT (id=Echidna_) 17 3}
        {MODIFY_UNIT (id=Echidna_) facing nw}
        [message]
            speaker=Echidna_
            message= _ "Fortunately, there is wildlife, even in this frozen hell.  I need your help, little winged one..."
        [/message]
        [animate_unit]
            flag=attack
            [filter]
                id=Echidna_
            [/filter]
            [primary_attack]
                name=khthon_vector
            [/primary_attack]
            hits=yes
        [/animate_unit]
        {MODIFY_UNIT (id=Owl1) side 2}
        {ARCHAIC_KHTHONIZED (id=Owl1)}
        [redraw]
            side=3
        [/redraw]
        [message]
            speaker=Kerrnyn
            message= _ "Oh, that's not good..."
        [/message]
    [/event]

    # to make this a little more threatening
    [event]
        name=side 2 turn
        first_time_only=no
        [if]
            [have_unit]
                side=1
                [filter_adjacent]
                    side=2
                    [not]
                        type=AR_Owl
                    [/not]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {ARCHAIC_KHTHONIZED (
                    [and]
                        side=1
                        [filter_adjacent]
                            side=2
                            [not]
                                type=AR_Owl
                            [/not]
                        [/filter_adjacent]
                    [/and]
                )}
                {MODIFY_UNIT (race=thrall_khthon) side 2}
            [/then]
        [/if]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [store_unit]
            [filter]
                id=Kerrnyn
            [/filter]
            variable=kerrnyn
            kill=no
        [/store_unit]
        [unit]
            type=AR_Owl
            x,y=14,14
        [/unit]
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter]
            id=Echidna_
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        {MODIFY_UNIT (id=$second_unit.id) side 2}
        {ARCHAIC_KHTHONIZED (id=$second_unit.id)}
    [/event]

    [event]
        name=defender_hits
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            id=Echidna_
        [/filter_second]
        {MODIFY_UNIT (id=$unit.id) side 2}
        {ARCHAIC_KHTHONIZED (id=$unit.id)}
    [/event]

    [event]
        name=side 3 turn 2
        [message]
            speaker=Kerrnyn
            message= _ "(My Goddess, what am I supposed to do?  I beg you to give me a sign.)"
        [/message]
        [unit]
            type=Tri_Bronze_Bird
            side=3
            x,y=29,1
        [/unit]
        [unit]
            type=Tri_Bronze_Bird
            side=3
            x,y=29,2
        [/unit]
        [message]
            x,y=29,2
            message= _ "<i>Kee!  Kee!</i>"
        [/message]
        [unit]
            type=Tri_Silver_Bird
            side=3
            x,y=8,12
        [/unit]
        [message]
            x,y=8,12
            message= _ "<i>Kee!  Kee!</i>"
        [/message]
        [redraw]
            side=3
        [/redraw]
        [scroll_to]
            x,y=30,1
        [/scroll_to]
        [delay]
            time=150
        [/delay]
        [message]
            speaker=Kerrnyn
            message= _ "(I've seen those before...)  Yes, Goddess, with the help of your winged gifts, I will face this daemon!"
        [/message]
        [message]
            speaker=Echidna_
            message= _ "Oh please!  Little mechanical toys will not help you!"
        [/message]
    [/event]

#ifndef HARD

    [event]
        name=die
        [filter]
            side=3
        [/filter]
        [filter_condition]
            [have_unit]
                side=3
                count=2
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=Kerrnyn
            message= _ "My Goddess, if you can hear me, I could use a little more help..."
        [/message]
        [unit]
            type=Tri_Bronze_Bird
            side=3
            x,y=29,1
        [/unit]
        [scroll_to]
            x,y=29,1
        [/scroll_to]
        [delay]
            time=150
        [/delay]
        [message]
            speaker=Kerrnyn
            message= _ "Thank you."
        [/message]
    [/event]

#endif

    [event]
        name=time_over
        {QUAKE "rumble.ogg"}
        [modify_side]
            side=3
            fog=no
        [/modify_side]
        [redraw]
            side=3
        [/redraw]
        [message]
            speaker=Echidna_
            message= _ "What was that?"
        [/message]
        {COLOR_ADJUST 10 -10 -10}
        [delay]
            time=150
        [/delay]
        [unit]
            type=Nemesis_Wounded
            id=Nemesis_
            name=Nemesis
            side=3
            x,y=30,1
            facing=sw
        [/unit]
        [message]
            speaker=Nemesis_
            message= _ "That... was us... reaching our... destination..."
        [/message]
        [message]
            speaker=Echidna_
            message= _ "What have you done?  Why aren't you dead?"
        [/message]
        {QUAKE "rumble.ogg"}
        {COLOR_ADJUST 0 -50 -50}
        [delay]
            time=70
        [/delay]
        [message]
            speaker=Nemesis_
            message= _ "You cannot kill... a <i>god!</i>"
        [/message]
        {COLOR_ADJUST -30 -100 -100}
        [delay]
            time=70
        [/delay]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The airborne combatants were thrown into the walls and ceiling, those on the ground were thrown from their feet, as a jarring series of impacts shook the entire cavern."
        [/message]
        {QUAKE "rumble.ogg"}
        {COLOR_ADJUST -100 -200 -200}
        [delay]
            time=70
        [/delay]
        {COLOR_ADJUST -200 -255 -255}
        [delay]
            time=70
        [/delay]
        {QUAKE "rumble.ogg"}
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Kerrnyn suffered a head-wound, and knew his time was over, but as his vision faded, he had the satisfaction of seeing the evil green-eyed daemon disappear under a collapsing section of the cavern.  He had served his goddess well...

So he was a little surprised to see his goddess staring down at him, blood trickling down the side of her head, and an angry look on her face.  'Don't die now, we are not finished here!'  Then she grabbed him by the collar and dragged him deeper into the cold caverns."
        [/message]
        {COLOR_ADJUST -255 -255 -255}
        [kill]
            side=1
        [/kill]
        [kill]
            side=2
        [/kill]
        [store_unit]
            [filter]
                side=3
                [not]
                    id=Nemesis_
                [/not]
            [/filter]
            variable=skm_survivors
            kill=yess
        [/store_unit]
        [endlevel]
            {CONTINUE}
        [/endlevel]
    [/event]
[/scenario]

[scenario]
    id="Tower_3_Pb2"
    name= _ "Battle Plans"
    map_data="{~add-ons/Trinity/maps/Weldyn_Outskirts.map}"
    next_scenario=Tower_3_P_main
    victory_when_enemies_defeated=no
    turns=-1

    [music]
        name="the_king_is_dead.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    {BMR_RESTORE_SIDE 1}
    {DAWN}
    [story]
        [part]
            story= _ "While Echidna had been effecting her plans to destroy her old Nemesis, the forces on the ground at the tower continued about their respective tasks."
            background="story/Trinity_tower_crash0.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Dummy"
            [/objective]
            [objective]
                condition=lose
                description=_ "Dummy"
            [/objective]
        [/objectives]
        [recall]
            id=Caldera
            x,y=5,14
        [/recall]
        {MODIFY_UNIT (id=Caldera) facing ne}
        [recall]
            id=Ponce
            x,y=4,14
        [/recall]
        {MODIFY_UNIT (id=Ponce) facing se}
        [recall]
            id=Lyron
            x,y=6,14
        [/recall]
        {MODIFY_UNIT (id=Lyron) facing sw}
        [recall]
            side=1
            x,y=6,15
        [/recall]
        {MODIFY_UNIT (x,y=6,15) facing ne}
        {MODIFY_UNIT (id=Haldrad) facing ne}
    [/event]

    [side]
        side=1
        type=Spearman
        canrecruit=yes
        id=Fooby
        name="Fooby"
        controller=human
        fog=no
        team_name=Human
    [/side]

    [side]
        side=2
        controller=ai
        no_leader=yes
        fog=no
        team_name=Primeval
        [unit]
            type=Primevalist Fanatic
            id=Prime1
            x,y=10,4
            facing=sw
        [/unit]
        [unit]
            type=Primevalist Follower
            id=Prime1
            x,y=11,5
            facing=sw
        [/unit]
        [unit]
            type=SouthSeas Rover
            id=Prime3
            x,y=16,6
            facing=sw
        [/unit]
        [unit]
            type=SouthSeas Seaman
            id=Prime4
            x,y=19,7
            facing=sw
        [/unit]
    [/side]

    [event]
        name=start
        [message]
            speaker=Haldrad
            message= _ "We've just about circled the entire vicinity of Weldyn-"
        [/message]
        [message]
            speaker=Lyron
            message= _ "Or at least where Weldyn used to be."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Right, well, as I was saying: we've made a complete circle and there seems to be no way in."
        [/message]
        [message]
            speaker=Caldera
            message= _ "Wherever the undead aren't amassed, there are these foreign fighters..."
        [/message]
        [message]
            speaker=Prime1
            message= _ "Hey, you there!  Move along!"
        [/message]
        [message]
            speaker=Prime3
            message= _ "Or we'll split ye from bow to stern!"
        [/message]
        [message]
            speaker=Prime4
            message= _ "Heh."
        [/message]
        [message]
            speaker=Prime2
            message= _ "Don't you recognize them?  Those are the deposed rulers of this land!   They should be back at the port, what are they doing here?"
        [/message]
        [message]
            speaker=Caldera
            message= _ "I don't like how they are talking and looking at us, we should get away from here."
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Agreed.  We don't have the army to fight them.  ... Or that tower."
        [/message]
        [message]
            speaker=Caldera
            message= _ "You seem thoughtful, what is on your mind?"
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Our forces are decimated, and we face some sort of invasion.  If the refugees are to be believed, the elves have been enslaved, and can offer no assistance.  But the dwarves may still be free.  We should send an ambassador to enlist their aid."
        [/message]
        [message]
            speaker=Caldera
            message= _ "The dwarves, huh?  We aren't on such good terms with them lately.  ...  Ponce!  You're clearly not from around here, they might listen to you!"
        [/message]
        [message]
            speaker=Ponce
            message= _ "Oh no!  I've met the dwarves before, I will not be any more welcome than you.  No, none of us sailors will be going to visit the dwarves in their burrows."
        [/message]
        [message]
            speaker=Lyron
            message= _ "If I may...  There is another force we are overlooking.  The orcs.  And Ponce would be the perfect envoy to the Frozen North."
        [/message]
        [message]
            speaker=Ponce
            message= _ "<i>Frozen North!?</i>  And just why would we be the perfect envoys for that?"
        [/message]
        [message]
            speaker=Lyron
            message= _ "The Royal House and the orcs have a hostile relationship, but you are clearly not one of us-"
        [/message]
        [message]
            speaker=Ponce
            message= _ "(So you keep reminding me.)"
        [/message]
        [message]
            speaker=Lyron
            message= _ "-so they may listen to you.  Be sure to let them know that the elf-land woods could be available, if we are triumphant."
        [/message]
        [message]
            speaker=Caldera
            message= _ "Advisor!  We wouldn't betray the Elves with such treachery!"
        [/message]
        [message]
            speaker=Lyron
            message= _ "Of course not, but the orcs don't know that!"
        [/message]
        [message]
            speaker=Haldrad
            message= _ "Enough!  Ponce, please make plans to head north as quickly as possible.  Lyron, since you have such a silver tongue and crafty mind, you are the perfect man to visit the Dwarves."
        [/message]
        [message]
            speaker=Ponce
            message= _ "How far away is the Frozen North?  How long will this take?  It sounds cold, I don't have any warm clothes-"
        [/message]
        [message]
            speaker=Lyron
            message= _ "Uh, I'm not the best envoy, but I know someone who-"
        [/message]
        [message]
            speaker=Caldera
            message= _ "<i>Silence!</i>  You will work out the details and be on your way as soon as you are able!  The rest of our forces will circle those laying siege to our former home."
        [/message]
        [endlevel]
            {CONTINUE}
            replay_save=no
        [/endlevel]
    [/event]
[/scenario]

[scenario]
    id="Tower_3_P_main"
    name= _ "Tower - Upper Levels"
    map_data="{~add-ons/Trinity/maps/damned_tower/outside.map}"
    next_scenario=Tower_Peak
    victory_when_enemies_defeated=no
    turns=-1
    #	{TURNS 8 10 12}

    [music]
        name="breaking_the_chains.ogg"
    [/music]

    {BMR_STORE_SIDE 3}
    {BMR_RESTORE_SIDE 3}
    #    {BMR_STORE_SIDE 5}
    #    {BMR_RESTORE_SIDE 5}
    #    {TRI_STORE_TOWER_TEAM 3 31-34 20}
    {FIRST_WATCH}

#define TRI_TOWER_INSIDE FILTER

    [store_unit]
        [filter]
            [not]
                {FILTER}
            [/not]
            [not]
                x,y=recall,recall
            [/not]
        [/filter]
        variable=units_outside_tower
        kill=yes
    [/store_unit]
    [store_items]
        variable=items_outside_tower
        x,y=1-35,27-90
    [/store_items]
    [remove_item] # will this get rid of everything?
        x,y=1-35,27-90
    [/remove_item]
    [replace_map]
        map="{~add-ons/Trinity/maps/damned_tower/inside.map}"
    [/replace_map]
    # moving the shroud update before [replace_map]
    [modify_side]
        side=3
        shroud=yes
    [/modify_side]
    {FOREACH items_inside_tower iitx}
        # I need to do something about items with halos...
        [item]
            image=$items_inside_tower[$iitx].image
            x=$items_inside_tower[$iitx].x
            y=$items_inside_tower[$iitx].y
        [/item]
    {NEXT iitx}
    {CLEAR_VARIABLE items_inside_tower}
    [if]
        [variable]
            name=fountain1_found
            equals=yes
        [/variable]
        [then]
            [terrain]
                terrain=Brym^Bryu
                x,y=27,53
            [/terrain]
            [terrain]
                terrain=Fyp
                x,y=22-23,53
            [/terrain]
            [redraw]
                side=3
            [/redraw]
        [/then]
    [/if]
    [if]
        [variable]
            name=fountain2_found
            equals=yes
        [/variable]
        [then]
            [terrain]
                terrain=Brym^Bryu
                x,y=25,53
            [/terrain]
            [terrain]
                terrain=Fyp
                x,y=17-18,53
            [/terrain]
            [redraw]
                side=3
            [/redraw]
        [/then]
    [/if]
    # is this still needed?
    #    [if]
    #        [variable]
    #            name=gold_found
    #            equals=yes
    #        [/variable]
    #        [else]
    #            [item]
    #                image=items/gold-coins-large.png
    #                x,y=32,56
    #            [/item]
    #        [/else]
    #    [/if]
    # is this still needed?
    #    [if]
    #        [variable]
    #            name=scout_found
    #            equals=yes
    #        [/variable]
    #        [else]
    #            [item]
    #                image=misc/chest-metal-closed.png
    #                x,y=29,52
    #            [/item]
    #        [/else]
    #    [/if]
    [if]
        [have_unit]
            {FILTER}
            y=1-58
        [/have_unit]
        [then]
            [music]
                name=transience.ogg
                immediate=yes
                append=no
            [/music]
            [music]
                name=underground.ogg
                immediate=no
                append=no
            [/music]
        [/then]
        [else]
            [music]
                name=the_deep_path.ogg
                immediate=yes
                append=no
            [/music]
        [/else]
    [/if]
    {FOREACH units_inside_tower index}
        [unstore_unit]
            variable=units_inside_tower[$index]
            find_vacant=yes
        [/unstore_unit]
    {NEXT index}
    {CLEAR_VARIABLE units_inside_tower}
    # this is a hack to prevent game from ending if both real leaders are off map.
    #    [if]
    #        [have_unit]
    #            side=3
    #            canrecruit=yes
    #        [/have_unit]
    #        [else]
    #            {MODIFY_UNIT (side=3) canrecruit yes}
    #        [/else]
    #    [/if]
    # and to clean it up afterward
    #    [if]
    #        [have_unit]
    #            id=Dardrus,Bresda
    #        [/have_unit]
    #        [then]
    #            {MODIFY_UNIT (
    #                side=3
    #                [not]
    #                    id=Dardrus,Bresda
    #                [/not]
    #                canrecruit=yes
    #            ) canrecruit no}
    #        [/then]
    #    [/if]
    [redraw]
        side=3
    [/redraw]
#enddef

#define TRI_TOWER_OUTSIDE FILTER

    [store_unit]
        [filter]
            [not]
                {FILTER}
            [/not]
            [not]
                x,y=recall,recall
            [/not]
        [/filter]
        variable=units_inside_tower
        kill=yes
    [/store_unit]
    [store_items]
        variable=items_inside_tower
        x,y=1-35,27-90
    [/store_items]
    [remove_item] # will this get rid of everything?
        x,y=1-35,27-90
    [/remove_item]
    [replace_map]
        map="{~add-ons/Trinity/maps/damned_tower/outside.map}"
    [/replace_map]
    {FOREACH items_outside_tower iitx}
        # I need to do something about items with halos...
        [item]
            image=$items_outside_tower[$iitx].image
            x=$items_outside_tower[$iitx].x
            y=$items_outside_tower[$iitx].y
        [/item]
    {NEXT iitx}
    {CLEAR_VARIABLE items_outside_tower}
    # is this still needed?
    #    [remove_item]
    #        image=items/gold-coins-large.png
    #        x,y=32,56
    #    [/remove_item]
    #    [remove_item]
    #        x,y=29,52
    #    [/remove_item]
    [if]
        [have_unit]
            {FILTER}
            y=1-51
        [/have_unit]
        [then]
            [music]
                name=In_the_Land_of_Madness.ogg
                immediate=yes
                append=no
            [/music]
        [/then]
        [else]
            [music]
                name=legends_of_the_north.ogg
                immediate=yes
                append=no
            [/music]
        [/else]
    [/if]
    {FOREACH units_outside_tower index}
        [unstore_unit]
            variable=units_outside_tower[$index]
            find_vacant=yes
        [/unstore_unit]
    {NEXT index}
    {CLEAR_VARIABLE units_outside_tower}
    # this is a hack to prevent game from ending if both leaders are off map.
    #    [if]
    #        [have_unit]
    #            side=3
    #            canrecruit=yes
    #        [/have_unit]
    #        [else]
    #            #		{MODIFY_UNIT ({FILTER}) canrecruit yes}
    #            # if the FILTER value is a dummy, that causes trouble.  Just use side=3, it shouldn't hurt...
    #            {MODIFY_UNIT (side=3) canrecruit yes}
    #        [/else]
    #    [/if]
    # and to clean it up afterward
    #    [if]
    #        [have_unit]
    #            id=Dardrus,Bresda
    #        [/have_unit]
    #        [then]
    #            {MODIFY_UNIT (
    #                side=3
    #                [not]
    #                    id=Dardrus,Bresda
    #                [/not]
    #                canrecruit=yes
    #            ) canrecruit no}
    #        [/then]
    #    [/if]
    [modify_side]
        side=3
        shroud=no
    [/modify_side]
    [redraw]
        side=3
    [/redraw]

#enddef

    [story]
        [part]
            story= _ "Meanwhile, back in the tower, Bresda and Dardrus were continuing their trek to the upper levels."
            background="story/Trinity_tower_crash0.jpg"
        [/part]
    [/story]

    [event]
        name=prestart
        [objectives]
            side=0
            [objective]
                condition=win
                description=_ "Reach the top of the tower"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
            note=_"The veterans on the recall list are waiting on the floor below, you can recall them if Dardrus or Bresda is near the starting doorway.
Author's Note:  The inside/outside map-switching is a work in progress, it currently uses a menu item that is available when appropriate."
        [/objectives]
        [item]
            halo=misc/sand-skull-glo-1.png:200,misc/sand-skull-glo-2.png:200
            x,y=12,79
        [/item]
        [item]
            halo=misc/sand-skull-glo-1.png:200,misc/sand-skull-glo-2.png:200
            x,y=18,79
        [/item]
        #
        [item]
            x,y=15,74
            image=misc/skull-banner.png
        [/item]
        [item]
            x,y=29,63
            image=misc/red-banner.png
        [/item]
        # the items inside the tower
        [set_variables]
            mode=replace
            name=items_inside_tower
            [value]
                image=items/gold-coins-large.png
                x=32
                y=56
            [/value]
            [value]
                image=misc/chest-metal-closed.png
                x=29
                y=52
            [/value]
        [/set_variables]
        [teleport]
            [filter]
                id=Dardrus
            [/filter]
            x,y=28,65
        [/teleport]
        [teleport]
            [filter]
                id=Bresda
            [/filter]
            x,y=29,65
        [/teleport]
        [if]
            [have_unit]
                side=3
                y=80-90
            [/have_unit]
            [then]
                [teleport]
                    [filter]
                        side=3
                        y=80-90
                    [/filter]
                    x,y=30,65
                [/teleport]
            [/then]
        [/if]
        #        {MODIFY_UNIT (side=3) attacks_left 1}
        #        {MODIFY_UNIT (id=Dardrus) moves 6}
        #        {MODIFY_UNIT (id=Bresda) moves 6}
        # WTF is she doing on the recall list??
        [kill]
            id=Seaman1
        [/kill]
        [set_variable]
            name=tri_tower_are_inside
            value=no
        [/set_variable]
        [set_variable]
            name=tri_tower_select
            value=0
        [/set_variable]
        #    [set_variables]
        #	name=tri_tower_unit_list
        #	mode=append
        #	[value]
        #	    id=none
        #	[/value]
        #    [/set_variables]
        [terrain]
            terrain=Tphz^Tyod
            x=15,26,21,20
            y=57,50,45,38
        [/terrain]
        [terrain]
            terrain=Tptz^Kov
            x,y=28-30,65
        [/terrain]
        [unit]
            side=1
            type=Tomb Guard
            x,y=20,64
        [/unit]
        [unit]
            side=1
            type=Tomb Guard
            x,y=18,57
            ai_special=guardian
        [/unit]
        [unit]
            side=1
            type=Tomb Shield
            x,y=13,65
            ai_special=guardian
        [/unit]
        [unit]
            side=1
            type=Tomb Dancer
            x,y=18,64
        [/unit]
        [unit]
            side=1
            type=Tomb Dancer
            x,y=22,58
            ai_special=guardian
        [/unit]
        [unit]
            side=1
            type=Tomb Wing
            x,y=32,54
        [/unit]
        [unit]
            side=1
            type=Tomb Sentinel
            x,y=30,50
            ai_special=guardian
        [/unit]
        [unit]
            side=1
            type=Tomb Master
            x,y=32,58
        [/unit]
        [unit]
            side=1
            type=Tomb Protector
            x,y=17,51
            ai_special=guardian
        [/unit]
        [set_menu_item]
            id=tri_tower_go_outside
            description = _"Return to Outside Map"
            image=icons/action/ornate_play_turn_25-pressed.png~CS(-50,-50,100)
            [show_if]
                [variable]
                    name=tri_tower_are_inside
                    equals=yes
                [/variable]
                [not]
                    [have_unit]
                        id=$tri_tower_unit_list_var
                        count=$tri_tower_unit_list.length
                    [/have_unit]
                [/not]
            [/show_if]
            [default_hotkey]
                key=o
                #                shift=yes
            [/default_hotkey]
            [command]
                [set_variable]
                    name=tri_tower_are_inside
                    value=no
                [/set_variable]
                {TRI_TOWER_OUTSIDE (id=dummy)}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=tri_tower_go_inside
            description = _"Return to Inside Map"
            image=icons/action/ornate_play_turn_25-pressed.png~CS(-150,50,100)
            [show_if]
                [variable]
                    name=tri_tower_are_inside
                    equals=no
                [/variable]
                [not]
                    [have_unit]
                        id=$tri_tower_unit_list_var
                        count=$tri_tower_unit_list.length
                    [/have_unit]
                [/not]
            [/show_if]
            [default_hotkey] # can this be the same as the thing above? nope
                key=o
                shift=yes
            [/default_hotkey]
            [command]
                [set_variable]
                    name=tri_tower_are_inside
                    value=yes
                [/set_variable]
                {TRI_TOWER_INSIDE (id=dummy)}
            [/command]
        [/set_menu_item]
        # this is development stuff that should be removed when possible
        ###############
        #        [clear_menu_item]
        #            id=crawl_ai_on
        #        [/clear_menu_item]
        #        [clear_menu_item]
        #            id=crawl_ai_off
        #        [/clear_menu_item]
        ############
    [/event]

    # side 1 is outside tower, all others are inside
    # phantom
    [side]
        no_leader=yes
        side=1
        controller=ai
        team_name=Enemy
        user_team_name=Phantoms
    [/side]

    # blue mages
    [side]
        no_leader=yes
        side=2
        controller=ai
        fog=no
        team_name=Enemy
        user_team_name=Azure Order
        [ai]
            [goal]
                name=target_location
                [criteria]
                    x=18,15,27
                    y=48,47,48
                [/criteria]
                value=6
            [/goal]
        [/ai]
    [/side]

    # player
    [side]
        type=Primeval Nemesislow
        id=Nemesis_
        name= _ "Nemesis2"
        side=3
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit=""
        {GOLD 250 200 180}
        {INCOME 8 6 4}
        team_name=Primeval
        recall_cost=10
        # adding this makes canrecuit goofiness no longer needed between maps?
        defeat_condition=no_units_left # or would 'never' be better?
    [/side]

    # mechs
    [side]
        no_leader=yes
        side=4
        controller=ai
        team_name=Enemy
        user_team_name=Machines
    [/side]

    # undead
    [side]
        no_leader=yes
        side=5
        controller=ai
        team_name=Enemy
        user_team_name=Undead
    [/side]

    # others
    [side]
        no_leader=yes
        side=6
        controller=ai
        team_name=Enemy
        user_team_name=Enemy
    [/side]

    [event]
        name=start
        [message]
            speaker=Bresda
            message= _ "The fog has cleared!"
        [/message]
        [message]
            speaker=Dardrus
            message= _ "I would be glad, but I suspect it means our host has something planned..."
        [/message]
        [message]
            speaker=Bresda
            message= _ "Hrm, I think you are right, let us proceed with caution.  If we need to call our followers, they await our signal at the door we just came from."
        [/message]
        [message]
            speaker=narrator
            message= _ "Two units can be recalled at the doorway under the red banner.  Recall cost is reduced, because the veterans are mostly equipped already, they are just waiting to be called out."
        [/message]
        [music]
            name=legends_of_the_north.ogg
            immediate=yes
            append=no
        [/music]
    [/event]

    # was I starting something here?
    #    [event]
    #	name=

    [event]
        name=moveto
        [filter]
            side=3
            x,y=32,56
        [/filter]
        [filter_condition]
            [not]
                [variable]
                    name=gold_found
                    equals=yes
                [/variable]
            [/not]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"These dragons do seem to love collecting gold...  There must be 2,000 pieces here!"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Or the tower maker likes to portray them that way.  Remember that this is all a construct."
        [/message]
        [gold]
            amount=2000
            side=3
        [/gold]
        [remove_item]
            image=items/gold-coins-large.png
            x,y=32,56
        [/remove_item]
        [set_variable]
            name=gold_found
            value=yes
        [/set_variable]
    [/event]

    # this is to give the player an expendable unit to deal with the mine
    [event]
        name=moveto
        [filter]
            side=3
            x,y=29,52
        [/filter]
        [filter_condition]
            [not]
                [variable]
                    name=scout_found
                    equals=yes
                [/variable]
            [/not]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"Some sort of blocky thing is in here...  It has wheels, it's like a little cart...  It's kind of heavy, I don't think I want to carry it."
        [/message]
        [unit]
            type=Tri_Mech_Scout
            id=MScout
            side=3
            x,y=30,52
        [/unit]
        [message]
            speaker=MScout
            message=_"Beep!  <i>whirrrrr</i>"
        [/message]
        [message]
            speaker=unit
            message=_"It moves when I make a gesture...  Ha!  It's waiting for orders!  This could be fun!"
        [/message]
        [message]
            speaker=MScout
            message=_"Beep!"
        [/message]
        [remove_item]
            image=misc/chest-metal-closed.png
            x,y=29,52
        [/remove_item]
        [item]
            image=misc/chest-metal-open.png
            x,y=29,52
        [/item]
        [set_variable]
            name=scout_found
            value=yes
        [/set_variable]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=3
            [filter_location]
                terrain=Tphz^Tyod,Rr^Tyog,Rrc
                [not]
                    x,y=29,64
                [/not]
            [/filter_location]
        [/filter]
# check that the hex doesn't have someone sitting on it on the other side
        [set_variable]
            name=idb
            value=0
        [/set_variable]
        [while]
            [variable]
                name=idb
                less_than=$door_blocked.length
            [/variable]
            [do]
                [if]
                    [variable]
                        name=door_blocked[$idb].x
                        equals=$x1
                    [/variable]
                    [and]
                    [variable]
                        name=door_blocked[$idb].y
                        equals=$y1
                    [/variable]
                    [/and]
                    [then]
                        [set_variable]
                            name=door_blocked_TEMP
                            value=yes
                        [/set_variable]
                    [/then]
                [/if]
                [set_variable]
                    name=idb
                    add=1
                [/set_variable]
            [/do]
        [/while]
# either way, this unit is now standing on that hex
                [set_variables]
                     name=door_blocked
                     mode=append
                     [value]
                         x=$x1
                         y=$y1
                         id=$unit.id
                     [/value]
                [/set_variables]
# but if there _is_ someone on the other side...
        [if]
            [variable]
                name=door_blocked_TEMP
                equals=yes
            [/variable]
                [then]
                    [message]
                        speaker=unit
                        message= _"There is no room for me to pass..."
                    [/message]
                [/then]
                [else]
# if the path is clear...
        [if]
            [variable]
                name=tri_tower_are_inside
                equals=no
            [/variable]
            [then]
                [set_variable]
                    name=tri_tower_are_inside
                    value=yes
                [/set_variable]
                {TRI_TOWER_INSIDE (id=$unit.id)}
            [/then]
            [else]
                [set_variable]
                    name=tri_tower_are_inside
                    value=no
                [/set_variable]
                {TRI_TOWER_OUTSIDE (id=$unit.id)}
            [/else]
        [/if]
                [/else]
        [/if]
        {CLEAR_VARIABLE door_blocked_TEMP}
        {CLEAR_VARIABLE idb}
    [/event]

# now if a unit moves off the portal, we clear that blocking variable
    [event]
        name=exit_hex
        first_time_only=no
        [filter]
            side=3
            [filter_location]
                terrain=Tphz^Tyod,Rr^Tyog,Rrc
                [not]
                    x,y=29,64
                [/not]
            [/filter_location]
        [/filter]
        [set_variable]
            name=idb
            value=0
        [/set_variable]
        [while]
            [variable]
                name=idb
                less_than=$door_blocked.length
            [/variable]
            [do]
                [if]
                    [variable]
                        name=door_blocked[$idb].id
                        equals=$unit.id
                    [/variable]
                    [then]
                        {CLEAR_VARIABLE door_blocked[$idb]}
                    [/then]
                [/if]
                [set_variable]
                    name=idb
                    add=1
                [/set_variable]
            [/do]
        [/while]
        {CLEAR_VARIABLE idb}
    [/event]

    #############################################################################################
    # bookkeeping to track whether there is any active side 3 (player) unit on the map not shown.
    #############################################################################################
    # put the unit on the list, if it isn't already on there
    [event]
        name=select
        first_time_only=no
        [filter]
            side=3
        [/filter]
        [filter_condition]
            [not]
                [variable]
                    name=tri_tower_unit_list_var
                    contains=$unit.id
                [/variable]
            [/not]
        [/filter_condition]
        [set_variables]
            name=tri_tower_unit_list
            mode=append
            [value]
                id=$unit.id
            [/value]
        [/set_variables]
        {CLEAR_VARIABLE tri_tower_unit_list_var}
        [set_variable]
            name=tri_tower_unit_list_var
            [join]
                variable=tri_tower_unit_list
                key=id
                separator=","
            [/join]
        [/set_variable]
    [/event]

    # update the unit list
    [event]
        name=die
        first_time_only=no
        [filter]
            side=3
        [/filter]
        {LOOKUP_INDEX tri_tower_unit_list id $unit.id u_index}
        {CLEAR_VARIABLE tri_tower_unit_list[$u_index]}
        {CLEAR_VARIABLE tri_tower_unit_list_var}
        [set_variable]
            name=tri_tower_unit_list_var
            [join]
                variable=tri_tower_unit_list
                key=id
                separator=","
            [/join]
        [/set_variable]
    [/event]
    #############################################################################################

# side 1 is always outside
# sides 2,4,5,6 are always inside
# at the end of side 2 turn, we are inside, so side 3 starts inside, and side 3 healing is only inside
# therefore, store heal-able units on side 3 at end of side 1 turn

    [event]
        name=side 1 turn end
        first_time_only=no
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=no
            [/variable]
        [/filter_condition]
        [store_unit]
            [filter]
                side=3
                [filter_adjacent]
                    side=3
                   # ability= # unfortunately, we can't use this because heals+4 and heals+8 have the same id 
                   type=Primevalist Celebrant,SouthSeas Caster
                [/filter_adjacent]
           [/filter]
           variable=to_heal_4_TEMP
           kill=no
        [/store_unit]
        {CLEAR_VARIABLE tri_tower_to_heal_4_ids}
        [set_variable]
            name=tri_tower_to_heal_4_ids
            [join]
                variable=to_heal_4_TEMP
                key=id
                separator=","
            [/join]
        [/set_variable]
        {CLEAR_VARIABLE to_heal_4_TEMP}
        [store_unit]
            [filter]
                side=3
                [filter_adjacent]
                    side=3
                   type=SouthSeas Zephyrist,SouthSeas SkyCaller
                [/filter_adjacent]
           [/filter]
           variable=to_heal_8_TEMP
           kill=no
        [/store_unit]
        {CLEAR_VARIABLE tri_tower_to_heal_8_ids}
        [set_variable]
            name=tri_tower_to_heal_8_ids
            [join]
                variable=to_heal_8_TEMP
                key=id
                separator=","
            [/join]
        [/set_variable]
        {CLEAR_VARIABLE to_heal_8_TEMP}
    [/event]
           
    # this prevents off-map units from getting stuck, but it gives you extra turns compared to AI sides, and can be exploited
    # actually, I think I have a partial work-around - see 'side x turn' events below
    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
            [then]
                {FOREACH units_outside_tower index}
                    [set_variable]
                        name=units_outside_tower[$index].moves
                        value=$units_outside_tower[$index].max_moves
                    [/set_variable]
                    [set_variable]
                        name=units_outside_tower[$index].attacks_left
                        value=$units_outside_tower[$index].max_attacks
                    [/set_variable]
# simulated healing, poison not dealt with yet
                    [if]
                        [variable]
                            name=tri_tower_to_heal_8_ids
                            contains=$units_outside_tower[$index].id
                        [/variable]
                        [then]
                            [set_variable]
                                name=units_outside_tower[$index].hitpoints
                                add=8
                            [/set_variable]
                        [/then]
                        [else]
                           [if]
                               [variable]
                                   name=tri_tower_to_heal_4_ids
                                   contains=$units_outside_tower[$index].id
                               [/variable]
                               [then]
                                   [set_variable]
                                        name=units_outside_tower[$index].hitpoints
                                        add=4
                                   [/set_variable]
                               [/then]
                           [/if]
                        [/else]
                    [/if]
                    [if]
                        [variable]
                            name=units_outside_tower[$index].hitpoints
                            greater_than=$units_outside_tower[$index].max_hitpoints
                        [/variable]
                        [then]
                            [set_variable]
                                name=units_outside_tower[$index].hitpoints
                                value=$units_outside_tower[$index].max_hitpoints
                            [/set_variable]
                        [/then]
                    [/if]
                {NEXT index}
            [/then]
            [else]
                {FOREACH units_inside_tower index}
                    [set_variable]
                        name=units_inside_tower[$index].moves
                        value=$units_inside_tower[$index].max_moves
                    [/set_variable]
                    [set_variable]
                        name=units_inside_tower[$index].attacks_left
                        value=$units_inside_tower[$index].max_attacks
                    [/set_variable]
                {NEXT index}
            [/else]
        [/if]
    [/event]

    [event]
        name=side 1 turn
        first_time_only=no
        [filter_condition]
            # so it only fires if not everyone is present
            # but if someone is [kill]ed, and it doesn't fire the die event, this list will be wrong, so it will fire then as well
            [not]
                [have_unit]
                    id=$tri_tower_unit_list_var
                    count=$tri_tower_unit_list.length
                [/have_unit]
            [/not]
        [/filter_condition]
        [if]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
            [then]
                [set_variable]
                    name=tri_tower_are_inside
                    value=no
                [/set_variable]
                {TRI_TOWER_OUTSIDE (id=dummy)}
            [/then]
            [else]
            [/else]
        [/if]
    [/event]

    [event]
        name=side 2 turn,side 4 turn,side 5 turn,side 6 turn
        first_time_only=no
        [filter_condition]
            [not]
                [have_unit]
                    id=$tri_tower_unit_list_var
                    count=$tri_tower_unit_list.length
                [/have_unit]
            [/not]
        [/filter_condition]
        [if]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                [set_variable]
                    name=tri_tower_are_inside
                    value=yes
                [/set_variable]
                {TRI_TOWER_INSIDE (id=dummy)}
            [/else]
        [/if]
    [/event]

    ##############################

    # this is firing INSIDE as well, need to fix <-done?
    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                side=1
                count=0-3
            [/have_unit]
            [variable]
                name=tri_tower_are_inside
                equals=no
            [/variable]
        [/filter_condition]
        [unit]
            side=1
            type=Tomb Master
            x,y=1,42
        [/unit]
        [unit]
            side=1
            type=Tomb Master
            x,y=35,30
        [/unit]
    [/event]

    [event]
        name=moveto
        [filter]
            side=3
            x,y=27,54
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"I can use the water from the fountain to quench this brazier."
        [/message]
        [terrain]
            terrain=Brym^Bryu
            x,y=27,53
        [/terrain]
        [terrain]
            terrain=Fyp
            x,y=22-23,53
        [/terrain]
        [redraw]
            side=3
        [/redraw]
        [set_variable]
            name=fountain1_found
            value=yes
        [/set_variable]
    [/event]

    [event]
        name=moveto
        [filter]
            side=3
            x,y=25,54
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"I can use the water from the fountain to quench this brazier."
        [/message]
        [terrain]
            terrain=Brym^Bryu
            x,y=25,53
        [/terrain]
        [terrain]
            terrain=Fyp
            x,y=17-18,53
        [/terrain]
        [redraw]
            side=3
        [/redraw]
        [set_variable]
            name=fountain2_found
            value=yes
        [/set_variable]
    [/event]

    [event]
        name=moveto
        [filter]
            side=3
            x=14,16
            y=46,46
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=unit
            message=_"There's a small candle tucked in the corner...  I can use it to light that brazier."
        [/message]
        [terrain]
            terrain=Rrc^Bryl
            x,y=15,46
        [/terrain]
        [redraw][/redraw]
        [set_variable]
            name=tri_tower_b_lit
            value=yes
        [/set_variable]
        [event]
            name=enter_hex
            [filter]
                 side=3
                 x=24
            [/filter]
            [filter_condition]
                [not]
                [variable]
                    name=tri_tower_are_inside
                    equals=yes
                [/variable]
                [/not]
            [/filter_condition]
            
        [unit]
            side=2
            type=Blue_Dragon
            id=B_Dragon
            x,y=27,58
        [/unit]
        [message]
            speaker=B_Dragon
            message=_"*<i>Snarl!</i>*"
        [/message]
        {MOVE_UNIT (id=B_Dragon) 15 58}
        [store_unit]
            [filter]
                id=B_Dragon
            [/filter]
            variable=b_dragon
            kill=yes
        [/store_unit]
        [redraw]
            side=3
        [/redraw]
        [delay]
            time=100
        [/delay]
        [message]
            speaker=unit
            message=_"Great, one of those things on the loose again..."
        [/message]
        [/event]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=18,48
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=tri_tower_b_lit
                equals=yes
            [/variable]
            [then]
                [teleport]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    clear_shroud=yes
                    x,y=28,50
                    animate=yes
                [/teleport]
            [/then]
            [else]
                [teleport]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    clear_shroud=yes
                    x,y=15,50
                    animate=yes
                [/teleport]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=15,47
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=23,51
        [/teleport]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=27,48
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=23,51
        [/teleport]
    [/event]

    # I might need to split this up for each floor -> done
    # level 1
    [event]
        name=moveto
        [filter]
            side=3
            x,y=15,64
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        #	{TRI_TOWER_INSIDE (id=$unit.id)}
        [unit]
            side=5
            type=Skeleton
            x,y=13,60
        [/unit]
        [unit]
            side=5
            type=Skeleton
            x,y=22,59
        [/unit]
        [unit]
            side=5
            type=Deathblade
            x,y=19,62
        [/unit]
        [unit]
            side=5
            type=Skeleton Archer
            x,y=11,61
        [/unit]
        [unit]
            side=5
            type=Bone Shooter
            x,y=16,59
        [/unit]
        [unit]
            side=5
            type=Zombie Dragon
            id=Z_Dragon
            x,y=32,56
        [/unit]
        [unit]
            side=5
            type=Revenant
            x,y=21,63
        [/unit]
        [unit]
            side=5
            type=Draug
            x,y=26,62
        [/unit]
        [unit]
            side=5
            type=Draug
            x,y=26,61
        [/unit]
    [/event]

    # level 2
    [event]
        name=moveto
        [filter]
            side=3
            x,y=15,57
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        #	{TRI_TOWER_INSIDE (id=$unit.id)}
        [unit]
            side=4
            type=Tri_Mech_Cyborg
            x,y=13,54
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Cyborg
            gender=female
            x,y=13,57
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Cyborg
            gender=female
            x,y=17,57
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Cyborg
            x,y=20,55
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Drone
            x,y=14,54
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Drone
            x,y=20,56
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=18,52
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=22,52
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Mine
            x,y=20,51
        [/unit]
    [/event]

    # level 3
    [event]
        name=moveto
        [filter]
            side=3
            x=26,15
            y=50,51
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        #	{TRI_TOWER_INSIDE (id=$unit.id)}
        [unit]
            side=2
            type=Tri_Blue_Mage
            x,y=22,49
        [/unit]
        [unit]
            side=2
            type=Tri_Blue_Mage
            x,y=24,46
        [/unit]
        [unit]
            side=2
            type=Tri_Azure_Mage
            x,y=21,48
        [/unit]
        [unit]
            side=2
            type=Tri_Azure_Mage
            x,y=28,50
        [/unit]
    [/event]

    # level 4
    [event]
        name=moveto
        [filter]
            side=3
            x,y=21,45
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        #	{TRI_TOWER_INSIDE (id=$unit.id)}
        [unit]
            side=6
            type=AR_Owl
            x,y=20,42
        [/unit]
        [unit]
            side=6
            type=AR_Sabrecat
            x,y=26,39
        [/unit]
        [unit]
            side=6
            type=AR_Snowcat
            x,y=25,42
        [/unit]
    [/event]

    # level 5
    [event]
        name=moveto
        [filter]
            side=3
            x,y=20,38
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        #	{TRI_TOWER_INSIDE (id=$unit.id)}
        [unit]
            side=6
            type=Tomb HighArcher
            x,y=22,36
        [/unit]
        [unit]
            side=6
            type=Tomb Stalker
            x,y=26,35
        [/unit]
        [unit]
            side=6
            type=Tomb Stalker
            x,y=22,38
        [/unit]
    [/event]

    [event]
        name=attack
        [filter]
            id=Z_Dragon
        [/filter]
        [message]
            side=3
            message=_"If nothing else, the lord of this tower should be slain for pushing that giant pile of rotting carrion upon us!"
        [/message]
    [/event]

    [event]
        name=enter_hex
        [filter]
            side=3
            x,y=22,33
        [/filter]
        [filter_condition]
            [variable]
                name=tri_tower_are_inside
                equals=yes
            [/variable]
        [/filter_condition]
        [message]
            speaker=narrator
            image=wesnoth-icon.png~CS(100,-50,-50)
            message=_"NOTE: Due to a bug, side 3 will be screwed up if you go out through this door and leave both Bresda and Dardrus inside. - Get one of them through first."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=3
            x=23,24,25
            y=33,33,33
            [not]
                race=mechanical
            [/not]
        [/filter]
        [message]
            speaker=unit
            message=_"What do I have to do to open this door?"
        [/message]
        [if]
            [have_unit]
                id=Dardrus
                [not]
                    y=33
                [/not]
            [/have_unit]
            [then]
                [teleport]
                    [filter]
                        id=Dardrus
                    [/filter]
                    x,y=22,33
                [/teleport]
            [/then]
        [/if]
        [if]
            [have_unit]
                id=Bresda
                [not]
                    y=33
                [/not]
            [/have_unit]
            [then]
                [teleport]
                    [filter]
                        id=Bresda
                    [/filter]
                    x,y=22,33
                [/teleport]
            [/then]
        [/if]
        [message]
            speaker=Dardrus
            message=_"Maybe there was something we missed in the levels below..."
        [/message]
        [message]
            speaker=Bresda
            message=_"I'll be pretty angry if this is just a dead-end!"
        [/message]
        [terrain]
            terrain=Tphz^Tyod
            x,y=24,32
        [/terrain]
        [redraw][/redraw]
        [message]
            speaker=unit
            message=_"Well, that was convenient..."
        [/message]
        [message]
            speaker=Bresda
            message=_"Let's go!"
        [/message]
        {MOVE_UNIT (id=Bresda) 24 32}
        {FOREACH units_inside_tower ix}
            [if]
                [variable]
                    name=units_inside_tower[$ix].side
                    equals=3
                [/variable]
                [then]
                    [unstore_unit]
                        variable=units_inside_tower[$ix]
                        find_vacant=no
                        x,y=recall,recall
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT ix}
        {CLEAR_VARIABLE units_inside_tower}
        [clear_menu_item]
            id=tri_tower_go_inside
        [/clear_menu_item]
        [clear_menu_item]
            id=tri_tower_go_outside
        [/clear_menu_item]
        [endlevel]
            {CONTINUE}
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Dardrus, Bresda
        [/filter]
        [message]
            speaker=unit
            message= _ "Oh, what a world..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
[/scenario]
