#textdomain wesnoth-Trinity

# to do:
# 1.  Mech_D starts sparking after Tristien dies
# 2.  Nemesis picks up Mech_D
# 3.  Rift and forest terrain, as hexes are surrounded

# current bugs:

[scenario]
    id="Dark_Planet_3b"
    name= _ "Dark Planet (III)"
    map_data="{~add-ons/Trinity/maps/Dark_Planet_Finale.map}"
    next_scenario=Coda
    victory_when_enemies_defeated=no
    turns=-1
    #    {TURNS 85 70 60}

    [music]
        name="legends_of_the_north.ogg"
    [/music]

    {BMR_STORE_SIDE 1}
    #    {BMR_STORE_SIDE 3}
    {BMR_STORE_SIDE 5}
    #    {BMR_STORE_SIDE 5}
    {BMR_RESTORE_SIDE 1}
    {BMR_RESTORE_SIDE 3}
    {BMR_RESTORE_SIDE 5}
    {TRINITY_DP_SCHEDULE}
    #    {TRI_RADIOACTIVE}

    [story]
        [part]
            story= _ "Dardrus, Bresda, and the sailors fled down the metal hallways away from the broken core machine, well aware that the rising ambient rumble, as well as the occasional siren or hissing pipe, was a harbinger of coming destruction."
            [background_layer]
                image="story/Trinity_cave-metal.jpg"
            [/background_layer]
        [/part]
        [part]
            story= _ "Meanwhile, Haldrad's forces escaped from Seth's lair via a back chamber.  Haldrad was pleased with how his forces had fought the unfamiliar enemy, but had an itching feeling that though he had won that battle, the war was not over.  He hoped Dardrus, and his fiery new companion Bresda, were having success in their assault..."
            [background_layer]
                image="story/Trinity_cave2.jpg"
            [/background_layer]
        [/part]
    [/story]

    ###############################################
    # Sides
    ###############################################

    [side]
        type=Spearman
        id=Leader_1_ID
        name= _ "Prince Haldrad"
        side=1
        canrecruit=yes
        fog=no
        shroud=no
        controller=human
        scroll_to_leader=no
        recruit="Spearman,Bowman,Peasant,Ruffian,Archaic_Orcish Grunt,Dwarvish Fighter,Heavy Infantryman"
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 10 7 4}
        {GOLD 390 270 160}
        team_name=Humans
        #	[unit]
        #	type=Primeval Nemesis2
        #	id=Nemesis
        #	profile=portraits/nemesis_2.png
        #	name=Nemesis
        #	x,y=63,59
        #	facing=nw
        #	[/unit]
    [/side]

    [side]
        type=Trinity Avatar
        id=Avatar
        name= _ "The Destroyer"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit=""
        extra_recruit="Tomb Slave,Tomb Archer,Tomb Dancer,Tomb Guard,Spirit Dove"
        {INCOME 7 10 14}
        {GOLD 350 450 550}
        team_name=Evil
        [ai]
            [goal]
                name=target_location
                [criteria]
                    x=2,12,47,32
                    y=57,57,4,58
                [/criteria]
                value=6
            [/goal]
        [/ai]
        hidden=yes
    [/side]

    # makes the daemon recruits weaker to arcane, and bad on forest terrain but good on unwalkable
#define TRI_DP_AVATAR_GLOW_OVERLAY
    [object]
        silent=yes
        [filter]
            id=$unit.id
        [/filter]
        [effect]
            apply_to=halo
            halo=halo/the-destroyer-spark4.png~CS(30,-40,30)~O(0.6)
        [/effect]
        [effect]
            apply_to=defense
            replace=yes
            [defense]
                forest=80
                unwalkable=50
            [/defense]
        [/effect]
        [effect]
            apply_to=movement_costs
            replace=yes
            [movement_costs]
                forest=4
                unwalkable=4
            [/movement_costs]
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                arcane=20
            [/resistance]
        [/effect]
        [effect]
            apply_to=status
            add=unpoisonable
        [/effect]
        [effect]
            apply_to=status
            add=undrainable
        [/effect]
        [effect]
            apply_to=status
            add=unplagueable
        [/effect]
    [/object]
#enddef

    [side]
        type=Spearman
        id=Leader_3_ID
        name= _ "Bresda"
        side=3
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit=""
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 12 8 4} # needed?
        {GOLD 180 160 120} # not sure this matters
        team_name=Humans
    [/side]

    [side]
        type=Tri_Cyan_Cyborg_Flyer
        id=Tristien
        name= _ "General Tristien"
        side=4
        canrecruit=yes
        controller=ai
        fog=no
        shroud=no
        recruit=""
        [unit]
            type=Mechanical Dragon
            #            type=Mech_Seth Dragon2
            id=Mech_D
            name=Mechanical Dragon
            x,y=39,47
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            x,y=36,46
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Drone
            x,y=38,45
            facing=sw
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg_Captain
            id=Mech_Captain
            x,y=57,56
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            x,y=29,28
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            x,y=55,35
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Android
            x,y=37,47
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Defender
            x,y=33,29
            facing=sw
        [/unit]
        [unit]
            type=Tri_Mech_Tank
            x,y=55,57
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=27,27
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=22,32
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=31,30
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=58,56
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=53,55
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=57,51
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Cyborg
            x,y=57,57
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            x,y=52,54
            facing=se
        [/unit]
        [unit]
            type=Tri_Mech_Battle_Android
            x,y=34,44
            facing=se
        [/unit]
        {INCOME 7 10 14}
        {GOLD 350 450 550}
        team_name=Evil
        # this will be modified later on
        [ai]
            [goal]
                name=target_location
                [criteria]
                    x,y=68,58-63
                [/criteria]
                value=6
            [/goal]
            [goal]
                name=target
                [criteria]
                    id=Haldrad
                [/criteria]
                value=6
            [/goal]
            [leader_goal]
                x,y=37,47
                id=0
                auto_remove=yes
            [/leader_goal]
        [/ai]
        [village]
            x,y=25,32
        [/village]
        [village]
            x,y=33,32
        [/village]
        [village]
            x,y=23,27
        [/village]
        [village]
            x,y=35,27
        [/village]
    [/side]

    [side]
        type=Keldan_Cyborg
        id=Keldan
        name= _ "Keldan"
        side=5
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit="Tri_Mech_Manbot"
        recall_cost=10
        village_gold=2
        village_support=2
        {GOLD 250 200 180}
        {INCOME 8 6 4}
        team_name=Khthon
        hidden=yes
    [/side]

    [side]
        type=Primeval Nemesis2
        id=Nemesis
        name=_"Nemesis"
        x,y=63,59
        facing=nw
        side=6
        canrecruit=yes
        controller=human
        fog=no
        shroud=no
        recruit="Tri_Bronze_Bird"
        recall_cost=10
        village_gold=2
        village_support=2
        {INCOME 12 8 4}
        {GOLD 380 310 200}
        team_name=Humans
        #	hidden=yes
    [/side]

    #    [side]
    #	no_leader=yes
    #	side=7
    #	controller=ai
    #	team_name=Panic
    #	[ai]
    #	    aggression=0.1
    #	    caution=1.0
    #	[/ai]
    #    [/side]

    # one of the teleport pads still works, so that side 3 can actually help
    # moveto events here to help, but also a [tunnel] in prestart
    # 20151212 reinstalling the western telepad, so Keldan can reach the action
    # 20191012 commenting these out, the AI sometimes gets trapped by this
    # west
#ifdef __UNUSED__
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,62
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=22,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=22,62
        [/teleport]
    [/event]
    # east
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=64,50
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=36,15
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=36,15
        [/filter]
        [teleport]
            [filter]
                x,y=$x1,$y1
            [/filter]
            clear_shroud=yes
            animate=yes
            x,y=64,50
        [/teleport]
    [/event]
    #
#endif

    [event]
        name=prestart
        # moving side 6 recall list (I don't think it makes sense for any followers to be with her, does it?) to some array.
        [store_unit]
            [filter]
                side=6
                x,y=recall,recall
            [/filter]
            variable=s6_recall_list
            kill=yes
        [/store_unit]
        [tunnel]
            id=tunnel_east
            bidirectional=yes
            [source]
                x,y=64,50
            [/source]
            [target]
                x,y=36,15
            [/target]
            [filter]
                [not]
                    type="Primeval Nemesis2_MD"
                [/not]
            [/filter]
        [/tunnel]
        [tunnel]
            id=tunnel_west
            bidirectional=yes
            [source]
                x,y=22,62
            [/source]
            [target]
                x,y=22,15
            [/target]
            [filter]
                [not]
                    type="Primeval Nemesis2_MD"
                [/not]
            [/filter]
        [/tunnel]

        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad or allied heroes"
            [/objective]
            [objective]
                condition=lose
                description=_ "Enemy captures Sky Mountain (the snow terrain region in southeast corner)"
            [/objective]
            #            [objective]
            #                condition=lose
            #                description=_ "Time runs out"
            #                show_turn_counter=yes
            #            [/objective]
            #note= _"This last scenario is under construction.  It is playable, and should even be possible to win, but some changes are still needed."
        [/objectives]
        [objectives]
            side=3
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda or Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Enemy captures Sky Mountain (the snow terrain region in southeast corner)"
            [/objective]
            note= _"The ring of stones at the starting position denotes a temporary castle for initial recruiting."
        [/objectives]
        [objectives]
            side=5
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Enemy captures Sky Mountain (the snow terrain region in southeast corner)"
            [/objective]
            # note= _"This last scenario is under construction.  It is playable, and should even be possible to win, but some changes are still needed."
        [/objectives]
        [objectives]
            side=6
            [objective]
                condition=win
                description=_ "Defeat Enemy Leaders"
            [/objective]
            [objective]
                condition=lose
                description=_ "Enemy captures Sky Mountain (the snow terrain region in southeast corner)"
            [/objective]
            # note= _"This last scenario is under construction.  It is playable, and should even be possible to win, but some changes are still needed."
        [/objectives]
        [recall]
            id=Ponce
            x,y=16,13
        [/recall]
        [recall]
            id=Lyron
            x,y=18,12
        [/recall]
        [recall]
            side=1
            x,y=19,12
        [/recall]
        [recall]
            side=1
            x,y=15,13
        [/recall]
        [store_unit]
            [filter]
                id=Keldan
            [/filter]
            kill=yes
            variable=keldan
        [/store_unit]
        [store_unit]
            [filter]
                id=Avatar
            [/filter]
            kill=yes
            variable=avatar
        [/store_unit]
        [store_unit]
            [filter]
                id=Fear
            [/filter]
            kill=yes
            variable=fear
        [/store_unit]
        [store_unit]
            [filter]
                id=Hunger
            [/filter]
            kill=yes
            variable=hunger
        [/store_unit]
        [store_unit]
            [filter]
                id=Cruel
            [/filter]
            kill=yes
            variable=cruel
        [/store_unit]
        # where did these folks come from?
        #        [kill]
        #            [and]
        #                side=5
        #                x,y=recall,recall
        #            [/and]
        #        [/kill]
        [kill]
            [and]
                side=4
                x,y=recall,recall
            [/and]
        [/kill]
        [set_recruit]
            side=4
            recruit="Tri_Mech_Drone,Tri_Mech_Cyborg,Tri_Mech_Scout"
            #        recruit="Tri_Mech_Drone,Tri_Mech_Cyborg,Tri_Mech_Scout,Mage,Tri_Blue_Mage,Blue_Drake"
        [/set_recruit]
        [teleport]
            [filter]
                id=Tristien
            [/filter]
            x,y=29,18
            animate=no
        [/teleport]
        [item]
            x,y=38,48
            image=misc/chest-metal-closed.png
        [/item]
        [item]
            x,y=15,14
            image=items/bones.png
        [/item]
    [/event]

    [event]
        name=start
        # testing###########
        #        [unit]
        #        type=Trinity Fear
        #        x,y=11,41
        #	side=2
        #	animate=yes
        #        [/unit]
        #        [unit]
        #        type=Trinity Stupid
        #        x,y=11,42
        #	side=2
        #	animate=yes
        #        [/unit]
        #        [unit]
        #        type=Trinity Cruel
        #        x,y=11,43
        #	side=2
        #	animate=yes
        #        [/unit]
        ##########
        {MOVE_UNIT (id=Haldrad) 18 21}
        {MODIFY_UNIT (id=Haldrad) facing se}
        [message]
            speaker=Haldrad
            message=_"What have we here?"
        [/message]
        [scroll_to]
            x,y=33,29
        [/scroll_to]
        [delay]
            time=200
        [/delay]
        [scroll_to]
            x,y=58,57
        [/scroll_to]
        [delay]
            time=200
        [/delay]
        [message]
            speaker=Tristien
            message=_"What's the hold-up?!"
        [/message]
        [message]
            speaker=Mech_Captain
            message=_"There is ... an ... obstacle..."
        [/message]
        [message]
            speaker=Nemesis
            message=_"*(snort!)* I'm more than an obstacle...  I am a <b><i>God</i>!</b>"
        [/message]
        [message]
            speaker=Bresda
            message=_"Isht- I mean- Nemesis!  You're here!"
        [/message]
        {MOVE_UNIT (id=Dardrus) 66 45}
        {MODIFY_UNIT (id=Dardrus) facing sw}
        [message]
            speaker=Dardrus
            message=_"Prince!  We need to leave this place!  Right now!"
        [/message]
        [message]
            speaker=Bresda
            message=_"We've destroyed the nest of the machines, but, ah, there have been complications."
        [/message]
        [message]
            speaker=Nemesis
            message=_"Bresda, Dardrus ...  I don't know how you got here, but the Sky Mountain is the only way I know of off this rock, and we must defend it at all costs.  However, before we leave, we must destroy the evil spirit that calls himself 'Seth'."
        [/message]
        [message]
            speaker=Haldrad
            message=_"We've defeated that evil lord!  He won't be causing us any more trouble."
        [/message]
        [message]
            speaker=Nemesis
            message=_"I find it hard to believe Seth could fall to the likes of you..."
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Nemesis
            message=_"But I've seen powerful gods fall to inferior beings because of the vice of pride.  Very well, let's get out of here.  Make your way to the Sky Mountain."
        [/message]
        [music]
            name=the_dangerous_symphony.ogg
            append=yes
            immediate=no
        [/music]
        [music]
            name=into_the_shadows.ogg
            append=yes
            immediate=no
        [/music]
        [message]
            speaker=Tristien
            message=_"Stop them!"
        [/message]
        [message]
            speaker=Mech_D
            message=_"<i>Acquiring targets...</i>"
        [/message]
    [/event]

    # this was broken, causing moves -> 0.  Was it needed at some point?  I'll leave it here because I don't get what happened...
    #    [event]
    #	name=side 3 turn
    #	{MODIFY_UNIT (side=3) (moves) ($MODIFY_UNIT_store[$MODIFY_UNIT_i].max_moves|)}
    #    [/event]

    [event]
        name=moveto
        [filter]
            side=1,3,5
            x,y=15,14
        [/filter]
        [message]
            speaker=unit
            message=_"These are remains of a fighter.  They've been here for a long time, but there are some valuable metals that could be of use.  I'd say about 86g worth."
        [/message]
        [gold]
            side=$unit.side
            amount=86
        [/gold]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,3,5
            x,y=38,48
        [/filter]
        [message]
            speaker=unit
            message=_"These must be supplies for the metal fortress the machines were setting up.  I'd say they are worth about 120g."
        [/message]
        [gold]
            side=$unit.side
            amount=120
        [/gold]
        [remove_item]
            x,y=38,48
            image=misc/chest-metal-closed.png
        [/remove_item]
        [item]
            x,y=38,48
            image=misc/chest-metal-open.png
        [/item]
    [/event]

    [event]
        name=turn 2
        [unit]
            side=4
            type=Tri_Mech_Drone
            x,y=51,36
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=50,35
        [/unit]
        [unit]
            side=4
            id=Mech1
            type=Tri_Mech_Sentinel
            x,y=49,36
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=50,36
        [/unit]
        [message]
            speaker=Mech1
            message=_"Core has been compromised!  Link is down!"
        [/message]
        [message]
            speaker=Tristien
            message=_"...  Confirmed!  Link is down!  All units, attack the enemy, continue to make your way to the foreign mountain!  It may be our only escape!"
        [/message]
        [message]
            speaker=Mech_D
            message=_"Orders confirmed..."
        [/message]
        #	[message]
        #	speaker=Tristien
        #	message=_"Once we reach the mountain, we'll need to set up a new core..."
        #	[/message]
    [/event]

    [event]
        name=turn 3
        [unit]
            side=4
            type=Tri_Mech_Drone
            x,y=51,36
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=50,35
        [/unit]
        [unit]
            side=4
            id=Mech2
            type=Tri_Mech_Sentinel
            x,y=49,36
        [/unit]
        [unit]
            side=4
            type=Tri_Mech_Defender
            x,y=50,36
        [/unit]
        [message]
            speaker=Mech2
            message=_"We are the last, the others will not make it!"
        [/message]
        {QUAKE "rumble.ogg"}
        [message]
            speaker=Tristien
            message=_"All units, cut standard transmissions and switch to local link only."
        [/message]
        [message]
            speaker=Bresda
            message=_"He says such strange things..."
        [/message]
        {FLASH_RED (
            [replace_map]
                map="{~add-ons/Trinity/maps/Dark_Planet_Finale2.map}"
            [/replace_map]
            {QUAKE "rumble.ogg"}
        )}
        [message]
            speaker=Dardrus
            message=_"What is that?"
        [/message]
        [scroll_to]
            x,y=28,3
        [/scroll_to]
        [delay]
            time=1200
        [/delay]
        [scroll_to_unit]
            id=Haldrad
        [/scroll_to_unit]
    [/event]

    [event]
        name=turn 4
        {FLASH_WHITE (
            [delay]
                time=500
            [/delay]
        )}
        {QUAKE "rumble.ogg"}
        {FLASH_RED (
            [replace_map]
                map="{~add-ons/Trinity/maps/Dark_Planet_Finale3.map}"
            [/replace_map]
            [message]
                id=Mech2
                message=_"System flood...  cannot ..."
            [/message]
            [kill]
                id=Mech2
                animate=yes
            [/kill]
            [music]
                name=FranticSketch.ogg
                append=no
                immediate=yes
            [/music]
            [music]
                name=northerners.ogg
                append=yes
                immediate=no
            [/music]
            [music]
                name=siege_of_laurelmor.ogg
                append=yes
                immediate=no
            [/music]
        )}
        [message]
            speaker=Tristien
            message=_"I said to <i>sever standard transmissions</i>!  The core is on fire, anyone linked to it will be overwhelmed!"
        [/message]
    [/event]

    [event]
        name=turn 5
        [unstore_unit]
            variable=avatar
        [/unstore_unit]
        {QUAKE "rumble.ogg"}
        {FLASH_RED (
            [replace_map]
                map="{~add-ons/Trinity/maps/Dark_Planet_Finale4.map}"
            [/replace_map]
            [music]
                name=weight_of_revenge.ogg
                append=yes
                immediate=yes
            [/music]
            [terrain]
                terrain=Qxua^Rzft
                x=28,29
                y=11,11-12
            [/terrain]
            [redraw]
                side=1
            [/redraw]
        )}
        [message]
            speaker=Avatar
            message=_"General Tristien... I hadn't expected you to still be here."
        [/message]
        [message]
            speaker=Tristien
            message=_"Lord Seth, is that you?"
        [/message]
        [message]
            speaker=Avatar
            message=_"In a sense, yes..."
        [/message]
        [message]
            speaker=Tristien
            message=_"They've damaged the core, we are unstable...  Can you help?"
        [/message]
        [message]
            speaker=Avatar
            message=_"We no longer need the core, Tristien.  You shall become part of something much greater than you have ever known, if only we can take what we need from these invaders."
        [/message]
        [message]
            speaker=Tristien
            message=_"I see...  What do I need to do?"
        [/message]
        [message]
            speaker=Avatar
            message=_"Carry on in your fight to capture the ice mountain, and believe in me."
        [/message]
        [message]
            speaker=Tristien
            message=_" ...  "
        [/message]
#ifdef __UNUSED__
        [delay]
            time=1200
        [/delay]
        [message]
            speaker=Tristien
            message=_"(Oh, Creator, what have I done? ...)"
        [/message]
        [delay]
            time=1200
        [/delay]
        [message]
            speaker=Tristien
            message=_"Attention all units!  We've been mislead by lies and false promises!  The enemy are the ghosts and phantoms, not the invaders!  Change targets!"
        [/message]
        [message]
            speaker=Mech_D
            message=_"Understood!  Acquiring <i><b>new</b></i> targets..."
        [/message]
        [modify_side]
            side=4
            team_name=Mechs
        [/modify_side]
        [modify_ai]
            side=4
            action=delete
            path=goal[*]
        [/modify_ai]
        # move towards side 2, especially leaders
        [modify_ai]
            side=4
            action=add
            path=goal
            [goal]
                name=target
                [criteria]
                    side=2
                [/criteria]
                value=6
            [/goal]
        [/modify_ai]
        [modify_ai]
            side=4
            action=add
            path=goal
            [goal]
                name=target
                [criteria]
                    id=Avatar,Stupid,Fear,Cruel
                [/criteria]
                value=8
            [/goal]
        [/modify_ai]
        # only attack side 2
        [modify_ai]
            side=4
            action=add
            path=aspect[attacks].facet[]
            [facet]
                invalidate_on_gamestate_change=yes
                #            [filter_own]
                #                type=
                #            [/filter_own]
                [filter_enemy]
                    side=2
                [/filter_enemy]
            [/facet]
        [/modify_ai]
#endif
        [set_variable]
            name=weaknesses
            value=0
        [/set_variable]
    [/event]

    [event]
        name=turn 6
        [unstore_unit]
            variable=keldan
            find_vacan=no
        [/unstore_unit]
        {MODIFY_UNIT (id=Keldan) facing ne}
        [message]
            speaker=Mech_D
            message=_"Transponders detected, coming from the south!"
        [/message]
        [message]
            speaker=Tristien
            message=_"Yes, that would be our heavy armor.  I'm glad they made it out before the- wait, something is wrong."
        [/message]
        [message]
            speaker=Keldan
            message=_"I see that the battle continues..."
        [/message]
#ifdef __UNUSED__
        [terrain]
            terrain=Ce
            x=34-38
            y=68
        [/terrain]
        [terrain]
            terrain=Ke
            x,y=36,68
        [/terrain]
        [redraw]
            side=1
        [/redraw]
#endif
        {MOVE_UNIT (id=Keldan) 27 62}
        [recall]
            side=5
            race=primeval
            x,y=27,61
        [/recall]
        [recall]
            side=5
            race=khthon
            x,y=28,61
        [/recall]
        [recall]
            side=5
            x,y=26,61
        [/recall]
        [unit]
            side=5
            type=Tri_Mech_Manbot
            x,y=26,62
        [/unit]
        [unit]
            side=5
            type=Tri_Mech_Manbot
            x,y=27,63
        [/unit]
        [unit]
            side=5
            type=Tri_Mech_Manbot
            x,y=28,62
        [/unit]
        [message]
            speaker=Bresda
            message=_"Look who has joined us!"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Him again, he's certainly seen better days."
        [/message]
        [message]
            speaker=Bresda
            message=_"Hoi, Green Daemon!  What are you doing here?  And what happened to your face?"
        [/message]
        [message]
            speaker=Keldan
            message=_"I'm not completely sure.  But the lord of this pit is sadistic and evil, I'm sure it was for no good purpose."
        [/message]
        [message]
            speaker=Tristien
            message=_"No, Green-eyed beast!  How I tried to teach you, bring you to the light that is Seth...  But you do not see, and there can be no peace between our clean metal and the green scum you represent."
        [/message]
        [message]
            speaker=Dardrus
            message=_"That is strange, I never thought I'd see my people fight side-by-side with the Khthon Plague."
        [/message]
        [message]
            x,y=27,61
            message=_"The mechanical ones did the same to us, I think they were trying to make a new race of slaves!"
        [/message]
        [message]
            speaker=Keldan
            message=_"As you can see, these are strange times.  Again let us fight our common enemy instead of each other."
        [/message]
        [message]
            speaker=Nemesis
            message=_"We can never be allies, Khthon."
        [/message]
        [message]
            speaker=Bresda
            message=_"Indeed, last we met, you were switching sides so fast, your head must have been spinning!"
        [/message]
        [message]
            speaker=Keldan
            message=_"Yes, but this time will be different, you have my word."
        [/message]
        [message]
            speaker=Avatar
            message=_"How charming..."
        [/message]
        [if]
            [have_unit]
                side=1,3,5
                x,y=29,18
            [/have_unit]
            [then]
                [message]
                    x,y=29,18
                    message=_"Ouch!  What the-"
                [/message]
                {MOVE_UNIT (x,y=29,18) 29 21}
            [/then]
        [/if]
        [teleport]
            [filter]
                id=Avatar
            [/filter]
            x,y=29,18
            animate=yes
        [/teleport]
        [message]
            speaker=Avatar
            message=_"... and yet, how irrelevant!"
        [/message]
        [message]
            speaker=Haldrad
            message=_"I sense some bitterness."
        [/message]
        [message]
            speaker=Avatar
            message=_"<i>Damn right I'm bitter!</i>  I don't enjoy being locked in this mundane form, I long to cleanse myself of your poison!"
        [/message]
        [modify_side]
            side=5
            team_name=Humans
            hidden=no
        [/modify_side]
    [/event]

    [event]
        name=prerecruit
        first_time_only=no
        [filter]
            side=5
            [not]
                type=Tri_Mech_Manbot
            [/not]
        [/filter]
        {ARCHAIC_KHTHONIZED (x,y=$x1,$y1)}
        {MODIFY_UNIT (x,y=$x1,$y1) race tri_outlander}
    [/event]

#define TRI_TELEPORT_CLEAR_LOC X Y
    [if]
        [variable] # check that a location hasn't already been assigned
            name=tele_x
            equals=0
        [/variable]
        [not]
            [have_unit] # check that the hex is clear
                x,y={X},{Y}
            [/have_unit]
        [/not]
        [then]
            [set_variable]
                name=tele_x
                value={X}
            [/set_variable]
            [set_variable]
                name=tele_y
                value={Y}
            [/set_variable]
        [/then]
    [/if]
#enddef

    [event]
        name=avatar_to_keep
        first_time_only=no
        [set_variable]
            name=tele_x
            value=0
        [/set_variable]
        [set_variable]
            name=tele_y
            value=0
        [/set_variable]
        {TRI_TELEPORT_CLEAR_LOC 25 29}
        {TRI_TELEPORT_CLEAR_LOC 33 29}
        {TRI_TELEPORT_CLEAR_LOC 37 47}
        {TRI_TELEPORT_CLEAR_LOC 29 18}
        {TRI_TELEPORT_CLEAR_LOC 8 61}
        [if]
            [variable] # if all keeps were occupied, (and we don't want to check that this fallback hex is clear)
                name=tele_x
                equals=0
            [/variable]
            [then]
                [teleport]
                    [filter]
                        id=$unit.id
                    [/filter]
                    x,y=36,39
                    animate=yes
                [/teleport]
                [terrain]
                    terrain=Cty
                    x=35,36,37
                    y=39-40,38-40,39-40
                [/terrain]
                [terrain]
                    terrain=Kty
                    x,y=36,39
                [/terrain]
                [redraw]
                    side=1,3,5
                [/redraw]
            [/then]
            [else]
                [teleport]
                    [filter]
                        id=$unit.id
                    [/filter]
                    x,y=$tele_x|,$tele_y|
                    animate=yes
                [/teleport]
            [/else]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            side=2
        [/filter]
        [event]
            name=side 2 turn
            [message]
                speaker=Avatar
                message=_"Now this battle is properly engaged.  Come, Fear..."
            [/message]
            [unit]
                side=2
                type=Trinity Fear
                x,y=29,5
                id=Fear
                name=_ "Fear"
                canrecruit=yes
                extra_recruit="Ghost,Walking Corpse,Skeleton,Wraith,Phantom Unease,Phantom Horseman"
                animate=yes
                [modifications]
                    {TRI_TRAIT_ELEMENTAL_BLUE}
                    {TRAIT_QUICK}
                [/modifications]
            [/unit]
            [fire_event]
                name=avatar_to_keep
                [primary_unit]
                    id=Fear
                [/primary_unit]
            [/fire_event]
            [message]
                speaker=Fear
                message="<i>"+ _"(indecipherable whisper...)" + "</i>"
            [/message]
            #		[terrain]
            #		    terrain=Qxua^Rzft
            #		    x,y=28,11
            #		[/terrain]
            [gold]
                amount=110
                side=2
            [/gold]
            [event]
                name=recruit
                first_time_only=no
                [filter]
                    side=2
                    type="Ghost,Walking Corpse,Skeleton,Wraith,Phantom Unease,Phantom Horseman"
                [/filter]
                {TRI_DP_AVATAR_GLOW_OVERLAY}
            [/event]
            # Fear is slain, causes a chill to go over the battlefield, and there is panic randomly affecting non-hero units for two turns
            [event]
                name=last_breath
                [filter]
                    id=Fear
                [/filter]
                [message]
                    speaker=Fear
                    message=_"<i>"+_"(indistinct whispering)"+"</i>"
                [/message]
                [kill]
                    id=Fear
                    animate=yes
                [/kill]
                [terrain]
                    terrain=Uu^Ryft
                    x,y=$x1|,$y1|
                [/terrain]
                [terrain]
                    terrain=Urb
                    x,y=28,11
                [/terrain]
                [redraw]
                    side=1,3,5
                [/redraw]
                [message]
                    speaker=narrator
                    message=_"A chill wind blew across the battlefield, causing some of the combatants to freeze up with fear..."
                [/message]
                [set_variable]
                    name=panick_turn
                    value=$turn_number
                [/set_variable]
                [store_unit]
                    [filter]
                        # makes no sense for side 5 to freeze up, since they are not really living
                        #                        [not]
                        side=1,3
                        #                        [/not]
                        [not]
                            canrecruit=yes
                        [/not]
                    [/filter]
                    variable=panicky_TEMP
                    kill=no
                [/store_unit]
                {FOREACH panicky_TEMP pti}
                    [set_variable]
                        name=chance_TEMP
                        rand=1..4
                    [/set_variable]
                    [if]
                        [variable]
                            name=chance_TEMP
                            equals=1
                        [/variable]
                        [then]
                            [set_variable]
                                name=panicky_TEMP[$pti].status.slowed
                                value=yes
                            [/set_variable]
                            [unstore_unit]
                                variable=panicky_TEMP[$pti]
                                text=_"Panic!"
                                red,green,blue="150,50,100"
                                find_vacant=no
                            [/unstore_unit]
                        [/then]
                    [/if]
                {NEXT pti}
                {CLEAR_VARIABLE panicky_TEMP}
                # after some time (two turns?) the panic effect wears off
                [event]
                    name=new turn
                    first_time_only=no
                    id=panic_over_event
                    [set_variable]
                        name=panic_turn
                        add=-$turn_number
                    [/set_variable]
                    [if]
                        [variable]
                            name=panic_turn
                            less_than=-2
                        [/variable]
                        [then]
                            [store_unit]
                                [filter]
                                    side=7
                                [/filter]
                                variable=panicky_TEMP
                                kill=no
                            [/store_unit]
                            {FOREACH panicky_TEMP pti}
                                [set_variable]
                                    name=panicky_TEMP[$pti].status.slowed
                                    value=yes
                                [/set_variable]
                                [unstore_unit]
                                    variable=panicky_TEMP[$pti]
                                    text=_"Restored"
                                    {COLOR_HEAL}
                                    find_vacant=no
                                [/unstore_unit]
                            {NEXT pti}
                            {CLEAR_VARIABLE panicky_TEMP}
                        [/then]
                        [else]
                            [set_variable]
                                name=panic_turn
                                add=$turn_number
                            [/set_variable]
                        [/else]
                    [/if]
                [/event]
            [/event]
        [/event]
    [/event]

    # for testing
    #    [event]
    #	name=start
    #	[terrain]
    #	    terrain=Dsmz^Ryft
    #	    x,y=49,64
    #	[/terrain]
    #    [/event]

    # creeping terrains
    # don't simply expand, make it slower by only converting some of the adjacent terrains (randomly)
#define TRI_CREEPING_TERRAIN TERRAIN TERRAIN2 VALID_LOCS

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_location]
                terrain={TERRAIN}
            [/have_location]
        [/filter_condition]
        [store_locations]
            [and]
                terrain={VALID_LOCS}
            [/and]
            [not]
                terrain={TERRAIN}
            [/not]
            [filter_adjacent_location]
                terrain={TERRAIN}
            [/filter_adjacent_location]
            variable=potential_rift_locations
        [/store_locations]
        # choose which locations to randomly convert
        {FOREACH potential_rift_locations prli}
            [set_variable]
                name=chance_TEMP
                rand=1,2,3,4
            [/set_variable]
            [if] # this might need to be adjusted
                [variable]
                    name=chance_TEMP
                    less_than=3
                [/variable]
                [then]
                    {CLEAR_VARIABLE potential_rift_locations[$prli]}
                    # so the index doesn't skip ahead as we have shortened the array
                    [set_variable]
                        name=prli
                        add=-1
                    [/set_variable]
                [/then]
            [/if]
        {NEXT prli}
        {FOREACH potential_rift_locations prli}
            [terrain]
                terrain={TERRAIN}
                x,y=$potential_rift_locations[$prli].x|,$potential_rift_locations[$prli].y|
            [/terrain]
        {NEXT prli}
        {CLEAR_VARIABLE potential_rift_locations}
        # hexes surrounded by rift or forest - simpler because there is no randomness
        [store_locations]
            [filter_adjacent_location]
                terrain={TERRAIN},{TERRAIN2}
                count=6
            [/filter_adjacent_location]
            variable=potential_rift_locations
        [/store_locations]
        {FOREACH potential_rift_locations prli}
            [terrain]
                terrain={TERRAIN2}
                x,y=$potential_rift_locations[$prli].x|,$potential_rift_locations[$prli].y|
            [/terrain]
        {NEXT prli}
        {CLEAR_VARIABLE potential_rift_locations}
    [/event]
#enddef
    {TRI_CREEPING_TERRAIN (Uu^Ryft) (Uu^Rzft) ("Dsmz,Dsmz^*,Uu,Uu^*,Uh,Ur*,Rr*,Fypd,Ctym,Cud,Xos")}
    {TRI_CREEPING_TERRAIN (Gll^Ftp) (Gll^Ftr) ("Dsmz,Dsmz^*,Uu,Uu^*,Uh,Ur*,Rr*,Uu^Ryft")}

#undef TRI_CREEPING_TERRAIN

    # daemons spawn in the rifts.  They cannot move over forests, but they can move over the rifts
    [event]
        name=side 2 turn
        first_time_only=no
        [filter_condition]
            [have_location]
                terrain=Uu^Ryft
            [/have_location]
        [/filter_condition]
        [set_variable]
            name=chance_dspawn
            rand=1,2
        [/set_variable]
        [if]
            [variable]
                name=chance_dspawn
                equals=1
            [/variable]
            [then]
                [store_locations]
                    terrain=Uu^Ryft
                    variable=dspawn_locs
                [/store_locations]
                [set_variable]
                    name=loc_index_dspawn
                    rand=1..$dspawn_locs.length
                [/set_variable]
                [set_variable]
                    name=type_dspawn
                    rand=Wind_Daemon_1,Wind_Daemon_2,Earth_Daemon_1,Earth_Daemon_2,Tri_Daemon2,Tri_Daemon3,Tri_Daemon5
                    #                    rand=Tri_Daemon1,Tri_Daemon2,Tri_Daemon1,Tri_Daemon2,Tri_Daemon3,Wind_Daemon_2,Tri_Daemon5
                [/set_variable]
                [unit]
                    side=2
                    type=$type_dspawn
                    x,y=$dspawn_locs[$loc_index_dspawn].x|,$dspawn_locs[$loc_index_dspawn].y|
                [/unit]
                {CLEAR_VARIABLE dspawn_locs}
                {CLEAR_VARIABLE type_dspawn}
                {CLEAR_VARIABLE loc_index_dspawn}
            [/then]
        [/if]
    [/event]

    # now we do the same for Keldan's forest, spawning Wose Thralls.  But make it less likely
    [event]
        name=side 5 turn
        first_time_only=no
        [filter_condition]
            [have_location]
                terrain=Gll^Ftp,Gll^Ftr
            [/have_location]
        [/filter_condition]
        [set_variable]
            name=chance_dspawn
            rand=1,2,3,4
        [/set_variable]
        [if]
            [variable]
                name=chance_dspawn
                equals=1
            [/variable]
            [then]
                [store_locations]
                    terrain=Gll^Ftr,Gll^Ftp
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                    variable=dspawn_locs
                [/store_locations]
                [set_variable]
                    name=loc_index_dspawn
                    rand=1..$dspawn_locs.length
                [/set_variable]
                #		    [set_variable]
                #			name=type_dspawn
                #			rand=Horse,Timber Wolf,Yak,Ram,Taraxippon,Toad,Timber Wolf,Yak
                #		    [/set_variable]
                [unit]
                    side=5
                    type=Wose
                    x,y=$dspawn_locs[$loc_index_dspawn].x|,$dspawn_locs[$loc_index_dspawn].y|
                [/unit]
                {ARCHAIC_KHTHONIZED (x,y=$dspawn_locs[$loc_index_dspawn].x|,$dspawn_locs[$loc_index_dspawn].y|)}
                {CLEAR_VARIABLE dspawn_locs}
                #		    {CLEAR_VARIABLE type_dspawn}
                {CLEAR_VARIABLE loc_index_dspawn}
            [/then]
        [/if]
    [/event]

    # Tristien dies (mechs change teams to neutral), Avatar summons Cruelty and Hunger.

    [event]
        name=last_breath
        [filter]
            id=Tristien
        [/filter]
        [message]
            speaker=Tristien
            message=_"Maybe now I can finally rest..."
        [/message]
        [kill]
            id=Tristien
            animate=yes
        [/kill]
        [message]
            speaker=Mech_D
            message=_"Transmission to local command lost!  Reconnecting to core..."
        [/message]
        [message]
            type=Tri_Mech_Drone
            message=_"No, do not attempt to reconnect!"
        [/message]
        [store_unit]
            [filter]
                id=Mech_D
            [/filter]
            variable=mech_d
            kill=no
        [/store_unit]
        [item]
            halo=halo/lighthouse-aura.png~CS(100,-200,200)
            x,y=$mech_d.x|,$mech_d.y|
        [/item]
        [redraw]
            side=1,3,5
        [/redraw]
        # FLAG - need a better animation here.
        {FLASH_RED (
            {TRANSFORM_UNIT (id=Mech_D) "Broken Mechanical Dragon"}
            {QUAKE "rumble.ogg"}
            [message]
                speaker=Mech_D
                message=_"Core is still down!  Switching to local routines..."
            [/message]
        )}
        [message]
            speaker=Avatar
            message=_"Mindless machines, your type is now obsolete."
        [/message]
        [remove_item]
            halo=halo/lighthouse-aura.png~CS(100,-200,200)
            x,y=$mech_d.x|,$mech_d.y|
        [/remove_item]
        [modify_side]
            side=4
            team_name=Mechs
        [/modify_side]
        [event]
            name=side 2 turn
            [message]
                speaker=Avatar
                message=_"Come, Cold Cruelty.  Show these weak ones your style!"
            [/message]
            [unit]
                side=2
                type=Trinity Cruel
                x,y=29,5
                id=Cruel
                name=_"Cruelty"
                canrecruit=yes
                extra_recruit="Orcish Grunt,Arif,Heavy Infantryman,Cavalryman"
                animate=yes
                [modifications]
                    {TRI_TRAIT_ELEMENTAL_HALO}
                    {TRAIT_RESILIENT}
                [/modifications]
            [/unit]
            [message]
                speaker=Cruel
                message=_"I'm going to enjoy this..."
            [/message]
            #		[terrain]
            #		    terrain=Qxua^Rzft
            #		    x,y=29,11
            #		[/terrain]
            [fire_event]
                name=avatar_to_keep
                [primary_unit]
                    id=Cruel
                [/primary_unit]
            [/fire_event]
            [gold]
                amount=110
                side=2
            [/gold]
            [event]
                name=recruit
                first_time_only=no
                [filter]
                    side=2
                    type="Orcish Grunt,Arif,Heavy Infantryman,Cavalryman"
                [/filter]
                {TRI_DP_AVATAR_GLOW_OVERLAY}
            [/event]
            [message]
                speaker=Avatar
                message=_"Come, Pitiless Hunger.  Visit your effects upon our enemies."
            [/message]
            [unit]
                side=2
                type=Trinity Hunger
                x,y=29,5
                id=Hunger
                name=_"Hunger"
                canrecruit=yes
                extra_recruit="Giant Rat,Mudcrawler,Wolf,Great Wolf"
                animate=yes
                [modifications]
                    {TRI_TRAIT_ELEMENTAL_HALO}
                    {TRAIT_STRONG}
                [/modifications]
            [/unit]
            [event]
                name=recruit
                first_time_only=no
                [filter]
                    side=2
                    type="Giant Rat,Mudcrawler,Wolf,Great Wolf"
                [/filter]
                {TRI_DP_AVATAR_GLOW_OVERLAY}
            [/event]
            [message]
                speaker=Hunger
                message=_"A test of will..."
            [/message]
            #		[terrain]
            #		    terrain=Qxua^Rzft
            #		    x,y=29,12
            #		[/terrain]
            # make this random? Ponce, Lyron, Kerrnyn ...?
            [store_unit]
                [filter]
                    id=Lyron
                [/filter]
                variable=lyron
                kill=no
            [/store_unit]
            [teleport]
                [filter]
                    id=Hunger
                [/filter]
                x,y=$lyron.x|,$lyron.y
                animate=yes
            [/teleport]
            [message]
                speaker=Hunger
                message=_"Hello..."
            [/message]
            [message]
                speaker=Lyron
                message=_"No!"
            [/message]
            [store_unit]
                [filter]
                    id=Lyron
                [/filter]
                variable=lyron
                kill=yes
            [/store_unit]
            {TRANSFORM_UNIT (id=Hunger) "$lyron.type|"}
            {MODIFY_UNIT (id=Hunger) max_hitpoints 100}
            [message]
                speaker=Haldrad
                message=_"What have you done?"
            [/message]
            [message]
                speaker=Avatar
                message=_"Your friend may be the most fortunate of all of you."
            [/message]
            [message]
                speaker=Keldan
                message=_"(That reminds me of what we Khthon sometimes must do, and yet it is different.  I wonder ...)"
            [/message]
            [event]
                name=side 5 turn
                [filter_condition]
                    [have_unit]
                        id=Keldan
                        y=1-47
                    [/have_unit]
                [/filter_condition]
                [message]
                    speaker=narrator
                    message=_"Keldan looked up as if he had an epiphany, then the machine components that had been grafted to him fell off.  His body bore no scars from the brutal surgery that the machinists had inflicted."
                [/message]
                [object]
                    id=obj_keldan_cyborg
                    silent=yes
                    [filter]
                        id=Keldan
                    [/filter]
                    [effect]
                        apply_to=type
                        name=Keldan
                    [/effect]
#ifdef __UNUSED__
                    [effect]
                        apply_to=hitpoints
                        increase_total=-20%
                        heal_full=yes
                    [/effect]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=profile
                        portrait="portraits/keldan.png"
                        small_portrait="portraits/keldan.png~SCALE(205,205)"
                        description= _ "Keldan has been restored to his Khthonic self"
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=yes
                        [resistance]
                            blade=100
                            pierce=110
                            impact=100
                            fire=90
                            cold=90
                            arcane=110
                        [/resistance]
                    [/effect]
#endif
                [/object]
                [message]
                    speaker=Keldan
                    message=_"I can counter the daemons.  They are empty and soulless, they do not have the life-force that others have, and that we Khthon represent.  Echidna is not truely defeated as long as this force flows free."
                [/message]
                [message]
                    speaker=Bresda
                    message=_"So how does that let you counter these daemons?"
                [/message]
                [message]
                    speaker=Keldan
                    message=_"They are strong against fire and steel, but life and vitality is completely alien to these empty daemons, they are completely lost before it, like a winter frost in the summer sun.  When the time is right, I will lay down my sword, shed my body, and give myself over to this great power.
I believe that this is what Echidna wants...  I also believe that, as an elf, this is what I want.  This is right, I will be at peace."
                [/message]
                [objectives]
                    side=5
                    [objective]
                        condition=win
                        description=_ "Move Keldan to a sand, flat, cave, or hills terrain north of the small metal keep to stop the spread of the purple void"
                    [/objective]
                    [objective]
                        condition=lose
                        description=_ "Enemy captures Sky Mountain (the snow terrain region in southeast corner)"
                    [/objective]
                    note= _"Keldan will start a spreading forest terrain.  The forest can block and consume the spreading rifts.  It can also claim sand and cave terrain, but it cannot grow on the metal or chasm.  The Destroyer's daemons deal with forest terrain poorly."
                [/objectives]
                [event]
                    name=moveto
                    [filter]
                        id=Keldan
                        [filter_location]
                            terrain=Dsmz,Dsmz^*,Uu,Uu^*,Uh,Ur*,Rr*
                            y=1-45
                        [/filter_location]
                    [/filter]
                    [store_unit]
                        [filter]
                            side=5
                            race=khthon
                            [not]
                                id=Keldan
                            [/not]
                        [/filter]
                        kill=no
                        variable=nkl_TEMP
                    [/store_unit]
                    [set_variable]
                        name=nkl_mark
                        value=0
                    [/set_variable]
                    {FOREACH nkl_TEMP nkli} # finding the highest level khthon to become the New Khthon Leader
                        [if]
                            [variable]
                                name=nkl_mark
                                less_than=$nkl_TEMP[$nkli].level
                            [/variable]
                            [then]
                                [set_variable]
                                    name=nkl_mark
                                    value=$nkl_TEMP[$nkli].level
                                [/set_variable]
                                [set_variable]
                                    name=nkl_id
                                    value=$nkl_TEMP[$nkli].id
                                [/set_variable]
                                [set_variable]
                                    name=nkl_name
                                    value=$nkl_TEMP[$nkli].name
                                [/set_variable]
                            [/then]
                        [/if]
                    {NEXT nkli}
                    {CLEAR_VARIABLE nkl_TEMP}
                    [message]
                        speaker=Keldan
                        message=_"This will do...  I'll leave you in charge, $nkl_name|."
                    [/message]
                    [message]
                        speaker=$nkl_id
                        message=_"..."
                    [/message]
                    {MODIFY_UNIT (id=$nkl_id) canrecruit yes}
                    [role]
                        id=$nkl_id
                        role=Khthon_Leader
                    [/role]
                    [set_recruit] # not sure this is really needed
                        side=5
                        recruit="Lunar Bug,Lunar Mantis,Lunar Stinkbug,Tri_Mech_Manbot"
                    [/set_recruit]
                    [message]
                        speaker=Keldan
                        message=_"Send them back to the void."
                    [/message]
                    [store_locations]
                        [filter]
                            id=Keldan
                        [/filter]
                        variable=khthon_point
                    [/store_locations]
                    {FLASH_GREEN (
                        [kill]
                            id=Keldan
                        [/kill]
                        [terrain]
                            terrain=Gll^Ftp
                            x,y=$x1,$y1
                        [/terrain]
                        [redraw]
                            side=1,3,5
                        [/redraw]
                    )}
                    [message]
                        speaker=Bresda
                        message=_"Some trees...  I fail to see how that helps us."
                    [/message]
                    [message]
                        speaker=Dardrus
                        message=_"It's a more familiar terrain for us, hopefully less so for the enemy."
                    [/message]
                    [message]
                        speaker=Bresda
                        message=_"But it's just one little clump, who cares how familiar they are with it?"
                    [/message]
                [/event]
            [/event]
        [/event]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Cruel
        [/filter]
        [message]
            speaker=Cruel
            message=_"Ha!  You call that a death-blow?  Pathetic... "
        [/message]
        [kill]
            id=Cruel
            animate=yes
        [/kill]
        [terrain]
            terrain=Uu^Ryft
            x,y=$x1|,$y1|
        [/terrain]
        [terrain]
            terrain=Urb
            x,y=29,11
        [/terrain]
        [redraw]
            side=1,3,5,6
        [/redraw]
    [/event]

    [event]
        name=last_breath
        [filter]
            id=Hunger
        [/filter]
        [message]
            speaker=Hunger
            message=_"Oh, King Haldrad, I never wanted to raise my arms against you, it was that daemon...  Now I am slain, was there nothing else you could have done?"
        [/message]
        [kill]
            id=Hunger
            animate=yes
        [/kill]
        [terrain]
            terrain=Uu^Ryft
            x,y=$x1|,$y1|
        [/terrain]
        [terrain]
            terrain=Urb
            x,y=29,12
        [/terrain]
        [redraw]
            side=1,3,5,6
        [/redraw]
        [message]
            speaker=Ponce
            message=_"For what it's worth, Haldrad, I barely knew the guy, but even I could see that was not your friend speaking.  The daemon was all that was left, there was nothing you could have done."
        [/message]
        [message]
            speaker=Haldrad
            message=_"I ... well either way, he is gone..."
        [/message]
    [/event]

    [event]
        name=attack_end
        [filter]
            side=1,3
            [or]
                type=Trinity Avatar
            [/or]
        [/filter]
        [filter_second]
            type=Trinity Avatar
            [or]
                side=1,3
            [/or]
        [/filter_second]
        [filter_condition]
            [not]
                [have_unit]
                    id=Tristien
                [/have_unit]
            [/not]
        [/filter_condition]
        [message]
            speaker=Avatar
            message=_"*(laughter)*"
        [/message]
        [message]
            speaker=Haldrad
            message=_"How are we ever going to defeat this thing?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"Maybe we don't need to..."
        [/message]
        [message]
            speaker=Haldrad
            message=_"What do you mean?"
        [/message]
        [message]
            speaker=Dardrus
            message=_"The enemy is not of this world, and that building in the north seems to be a kind of gate.  What if we direct our attack against that?"
        [/message]
        [message]
            speaker=Haldrad
            message=_"And just how do we do that?"
        [/message]
        [if]
            [have_unit]
                id=Mech_D
            [/have_unit]
            [then]
                [message]
                    speaker=Mech_D
                    message=_"*SCREECH*  ... Runaway process terminated.  Reloading..."
                [/message]
                [message]
                    speaker=Ponce
                    message=_"There you go, Prince!  We send that unstable war machine through the portal!"
                [/message]
                [message]
                    speaker=Haldrad
                    message=_"Hrmm, I see.  But how do we get the machine to go through the portal?"
                [/message]
                [message]
                    speaker=Nemesis
                    message=_"I am a god, I can get it into position.  But I need to be able to access the portal."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Nemesis
                    message=_"What do you think I'm carrying this thing around for?  Clear me a path to the portal."
                [/message]
            [/else]
        [/if]
        [message]
            speaker=Haldrad
            message=_"All right then.  We'll help clear the way!"
        [/message]
        [objectives]
            side=1,3,5,6
            [objective]
                condition=win
                description=_ "Nemesis takes Mechanical Dragon to the Avatars' portal."
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Haldrad"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Ponce"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Dardrus"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Bresda"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Khthon"
            [/objective]
            #            note=_"Nemesis needs to have a path to the portal, the purple rift blocking the way is removed as the side 2 leaders are defeated."
        [/objectives]
        [set_variable]
            name=endgame_np
            value=yes
        [/set_variable]
    [/event]

    # Nemesis pushes Mech_D
    # first time, if it is premature, a bit of dialogue

    [event]
        name=attack
        [filter]
            id=Nemesis
        [/filter]
        [filter_second]
            type=Mechanical Dragon
        [/filter_second]
        [message]
            speaker=Nemesis
            message=_"Down with you, infernal machine!"
        [/message]
        [message]
            speaker=Mech_D
            message=_"Grrrr...."
        [/message]
        [message]
            speaker=Bresda
            message=_"Isht-, I mean, Nemesis!  Is it wise to spend time smashing that thing?  Daemons are running loose, we need your help!"
        [/message]
        [message]
            speaker=Nemesis
            message=_"I know what I am doing, young one.  But I'll take your words under advisement."
        [/message]
    [/event]

    [event]
        name=attack
        [filter]
            id=Nemesis
        [/filter]
        [filter_second]
            type=Broken Mechanical Dragon
        [/filter_second]
        [store_unit]
            [filter]
                id=Mech_D
            [/filter]
            kill=yes
            variable=mech_d
        [/store_unit]
        {MOVE_UNIT (id=Nemesis) $x2 $y2}
        {TRANSFORM_UNIT (id=Nemesis) "Primeval Nemesis2_MD"}
        [message]
            speaker=Nemesis
            message=_"I have a use for you, you broken meat-grinder!  If the path to that inferrnal gate is clear..."
        [/message]
        [end_turn]
        [/end_turn]
        # update objectives
        [event]
            name=moveto
            [filter]
                type="Primeval Nemesis2_MD"
                x,y=64,50
            [/filter]
            [message]
                speaker=Nemesis
                message=_"This pad doesn't seem to be working for me, I'll have to get there the hard way. "
            [/message]
            {MOVE_UNIT (id=Nemesis) 47 47}
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Nemesis
            x,y=25-32,5-10
        [/filter]
        # this wasn't the best way
#ifdef __UNUSED__
        name=side 6 turn
        [filter_condition] #Keldan has started his forest, and at least two of the side 2 generals are defeated.
            side_turn=6
            [have_location]
                terrain=*^Ftp,*^Ftr
            [/have_location]
            [not]
                [have_location]
                    terrain=Qxua^Rzft
                    x=28,29,29
                    y=11,11,12
                    count=2,3
                [/have_location]
            [/not]
        [/filter_condition]
#endif
        {MOVE_UNIT (id=Nemesis) 28 10}
        {TRANSFORM_UNIT (id=Nemesis) "Primeval Nemesis2"}
        [unstore_unit]
            variable=mech_d
            x,y=28,9
        [/unstore_unit]
        {CLEAR_VARIABLE mech_d}
        [message]
            speaker=Nemesis
            message=_"There, head north to that light, dumb machine!  It will fix you."
        [/message]
        # this is an attempt to make it so that
        [if]
            [have_location]
                terrain=*^Ftp,*^Ftr
            [/have_location]
            [then]
                [set_variable]
                    name=MD_explosion
                    value=yes
                [/set_variable]
                [fire_event]
                    name=md_explosion
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Mech_D
                    message=_"But the prisoner is here...  Computing..."
                [/message]
                [if]
                    [have_unit]
                        type=Keldan
                    [/have_unit]
                    # the case where Keldan needs to set root
                    [then]
                        [message]
                            speaker=Nemesis
                            message=_"The broken machine seems fixated on the green daemon."
                        [/message]
                        [message]
                            speaker=Keldan
                            message=_"(My time is limited, I should get in position soon.)"
                        [/message]
                    [/then]
                    # the case where Keldan hasn't shown up yet, or is still a cyborg
                    [else]
                        [message]
                            speaker=Nemesis
                            message=_"The broken machine seems fixated on something to the south..."
                        [/message]
                    [/else]
                [/if]
                [event]
                    name=new turn
                    first_time_only=no
                    [filter_condition]
                        [have_location]
                            terrain=*^Ftp,*^Ftr
                        [/have_location]
                    [/filter_condition]
                    [fire_event]
                        name=md_explosion
                    [/fire_event]
                [/event]
            [/else]
        [/if]
    [/event]

    [event]
        name=md_explosion
        [message]
            speaker=Mech_D
            message=_"To the light ..."
        [/message]
        {MOVE_UNIT (id=Mech_D) 28 5}
        [message]
            speaker=Mech_D
            message=_"Core temperature rising, cannot continue ... No solution ...  Situation is terminal ...  Intitiating Self-Destruct Routine!"
        [/message]
        {MOVE_UNIT (id=Nemesis) 28 15}
        [kill]
            id=Mech_D
        [/kill]
        [item]
            halo=halo/lighthouse-aura.png~CS(100,-200,200)
            x,y=28,2
        [/item]
        [redraw]
            side=1,3,5
        [/redraw]
        {FLASH_RED ({QUAKE "rumble.ogg"}
        #       [terrain]
        #           terrain=Uu^Crby
        #           x,y=29,3
        #    x,y=$mech_d.x|,$mech_d.y|
        #           layer=overlay
        #       [/terrain]
        [terrain]
            terrain=Uu^Ryft
            x=21-23,33-36,24-26
            y=6,1,1
            layer=overlay
        [/terrain]
        [terrain]
            terrain=Tbmy
            x,y=28,1
        [/terrain]
        [delay]
            time=300
        [/delay]
    )}
    [delay]
        time=1000
    [/delay]
    [remove_item]
        halo=halo/lighthouse-aura.png~CS(100,-200,200)
        x,y=28,2
    [/remove_item]
    [redraw]
        side=1,3,5
    [/redraw]
    [scroll_to]
        x,y=28,1
    [/scroll_to]
    [delay]
        time=3000
    [/delay]
    [color_adjust]
        red,green,blue=25,-5,-5
    [/color_adjust]
    [message]
        speaker=Avatar
        message=_"No!"
    [/message]
    {QUAKE "rumble.ogg"}
    [delay]
        time=300
    [/delay]
    {THUNDER (
        [kill]
            id=Avatar
            animate=yes
        [/kill]
    )}
    [delay]
        time=300
    [/delay]
    {QUAKE "rumble.ogg"}
    # Nemesis blocks the Humans and Khthon from evacuating
    [music]
        name=frantic.ogg
        immediate=yes
        append=no
    [/music]
    {MOVE_UNIT (id=Nemesis) 31 36}
    [message]
        side=3
        message=_"We need to get out of here!"
    [/message]
    {QUAKE "rumble.ogg"}
    {MOVE_UNIT (id=Nemesis) 35 50}
    [message]
        speaker=Nemesis
        message=_"Get back into the mountain..."
    [/message]
    # a bit of clean-up to ensure things make sense
    {MODIFY_UNIT (
        race=primeval
        [not]
            canrecruit=yes
        [/not]
    ) side 3}
    {MODIFY_UNIT (type=Tri_Bronze_Bird,Tri_Silver_Bird) side 3}
    #	{MODIFY_UNIT (id=Ponce) side 3} #WTF??
    #
    # this is just so the player doesn't have to watch the sprite putter 900 hexes across the map
    # don't want any animations or restrictions
#define TRI_TEMP_TELEPORT ID X Y
    [teleport]
        [filter]
            {ID}
        [/filter]
        x,y={X},{Y}
        animate=no
        check_passability=no
    [/teleport]
#enddef
    {TRI_TEMP_TELEPORT (id=Nemesis) 57 56}
    {MOVE_UNIT (id=Nemesis) 60 57}
    {TRI_TEMP_TELEPORT (id=Bresda) 57 56}
    {MOVE_UNIT (id=Bresda) 68 60}
    {TRI_TEMP_TELEPORT (id=Dardrus) 57 56}
    {MOVE_UNIT (id=Dardrus) 68 61}
    [store_unit]
        variable=side_3
        [filter]
            side=3
            [not]
                canrecruit=yes
            [/not]
        [/filter]
        #       mode=append
        kill=yes
    [/store_unit]
    [store_unit]
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        kill=yes
        variable=leader_3
    [/store_unit]
    [kill]
        side=3
    [/kill]
    {TRI_TEMP_TELEPORT (id=Haldrad) 57 56}
    {MOVE_UNIT (id=Haldrad) 59 57}
    {MODIFY_UNIT (id=Nemesis) facing nw}
    {MODIFY_UNIT (id=Haldrad) facing se}
    [message]
        speaker=Nemesis
        message=_"Not you, you stay back.  I won't raise my sword against you unless I have to, but I cannot allow your type to come with us."
    [/message]
    [message]
        speaker=Haldrad
        message=_"What?!  We just fought on the same side, the green-eyed enemy and the otherworldly daemons are defeated - why do you condemn us to death?"
    [/message]
    {QUAKE "rumble.ogg"}
    [message]
        speaker=Ponce
        message=_"I knew she would do this...  She is no less evil than the ones we just fought."
    [/message]
    [message]
        speaker=Nemesis
        message=_"We've given your type freedom and space in the past, and paid dearly for it.  I will not make the mistake again.  Would you submit to become one of our followers?  To wear our mark?"
    [/message]
    {QUAKE "rumble.ogg"}
    [message]
        speaker=Haldrad
        message=_"I...  Is that the only way off this dying world?"
    [/message]
    [message]
        speaker=Nemesis
        message=_"That you even ask that is all I need to know...  Don't try to follow us."
    [/message]
    {MOVE_UNIT (id=Nemesis) 68 62}
    [store_unit]
        variable=side_6
        [filter]
            side=6
            [not]
                canrecruit=yes
            [/not]
        [/filter]
        #       mode=append
        kill=yes
    [/store_unit]
    [store_unit]
        [filter]
            side=6
            canrecruit=yes
        [/filter]
        kill=yes
        variable=leader_6
    [/store_unit]
    [kill]
        side=6
    [/kill]
    {QUAKE "rumble.ogg"}
    [terrain]
        x=59,60,61,62,63,64,65,66,67,68
        y=60-64,57-64,57-65,56-65,56-66,55-66,55-67,55-67,55-68,55-67
        terrain=Dsmz
    [/terrain]
    [redraw]
        side=1,3,5
    [/redraw]
    [music]
        name=nunc_dimittis.ogg
        immediate=yes
        append=no
    [/music]
    [message]
        speaker=Haldrad
        message=_"We're doomed..."
    [/message]
    {QUAKE "rumble.ogg"}
    [message]
        role=Khthon_Leader
        message=_"Not necessarily...  We can help..."
    [/message]
    [message]
        speaker=Haldrad
        message=_"(?)  I'm not sure we should be talking to you..."
    [/message]
    [message]
        role=Khthon_Leader
        message=_"We've been enemies of the red-eyed daemons for a long time...  We would be glad to help you subvert the winged one's plan to leave you behind."
    [/message]
    [message]
        speaker=Haldrad
        message=_"Hrmmm...  I don't like this, but what do you have in mind?"
    [/message]
    # might need to chack if there is someone standing here
    [scroll_to]
        x,y=$khthon_point[0].x|,$khthon_point[0].y|
    [/scroll_to]
    [delay]
        time=250
    [/delay]
    [item]
        x,y=$khthon_point[0].x|,$khthon_point[0].y|
        halo=halo/holy/light-beam-[1~7].png~CS(-50,100,-50):100
    [/item]
    [message]
        role=Khthon_Leader
        message=_"We still have a strong presence in your land...  And as you can see, Keldan established a foothold here.  We are all connected, we can take you back.  You will meet and defeat the red-eyed ones as they land their ice-mountain."
    [/message]
    [message]
        speaker=Ponce
        message=_"Then what?"
    [/message]
    [message]
        role=Khthon_Leader
        message=_"I'm not sure, our mother Echidna is gone..."
    [/message]
    [message]
        speaker=Ponce
        message=_"(Haldrad, I don't trust that thing.)"
    [/message]
    [message]
        speaker=Haldrad
        message=_"(Neither do I, but it's our only chance.  And our staying here won't prevent them from going back...)"
    [/message]
    [message]
        speaker=Haldrad
        message=_"We accept your offer, Green-Eye.  Let's surprise that winged warlord!"
    [/message]
    {MOVE_UNIT (id=Haldrad) ($khthon_point[0].x) ($khthon_point[0].y)}
    [endlevel]
        {CONTINUE}
    [/endlevel]
[/event]

[event]
    name=moveto
    [filter]
        [filter_location]
            terrain=Spay,Aa,Ha,Ms
        [/filter_location]
        [not]
            side=1,3,5,6
        [/not]
    [/filter]
    [message]
        speaker=unit
        message=_"I've reached the Sky Mountain..."
    [/message]
    [message]
        speaker=Haldrad
        message=_"Don't let them into the mountain!  It's our only way home!"
    [/message]
[/event]

[event]
    name=moveto
    [filter]
        x,y=68,58-63
        [not]
            side=1,3,5,6
        [/not]
    [/filter]
    [message]
        speaker=unit
        message=_"Entering the Sky Mountain..."
    [/message]
    [message]
        speaker=Haldrad
        message=_"All is lost..."
    [/message]
    [endlevel]
        result=defeat
    [/endlevel]
[/event]

[event]
    name=last breath
    [filter]
        id=Haldrad, Dardrus, Bresda, Ponce, Keldan
    [/filter]
    [message]
        speaker=unit
        message=_"This is not good..."
    [/message]
    [endlevel]
        result=defeat
    [/endlevel]
[/event]
[/scenario]
#undef TRI_TEMP_TELEPORT
